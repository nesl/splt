   1               		.file	"sos_shm.c"
   2               		.arch atmega128
   3               	__SREG__ = 0x3f
   4               	__SP_H__ = 0x3e
   5               	__SP_L__ = 0x3d
   6               	__tmp_reg__ = 0
   7               	__zero_reg__ = 1
   8               		.global __do_copy_data
   9               		.global __do_clear_bss
  12               		.text
  13               	.Ltext0:
 218               		.lcomm shm_bin,8
 222               	shm_lookup:
   1:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
   2:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #include <sos.h>
   3:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #include <slab.h>
   4:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #include <sos_shm.h>
   5:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #ifdef SOS_USE_PREEMPTION
   6:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #include <priority.h>
   7:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #endif
   8:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
   9:/Users/Administrator/sos-2x/kernel/sos_shm.c **** enum {
  10:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	SHM_NUM_POOL_ITEMS = 4,     // number of items in one pool (MUST be less than 8)
  11:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	SHM_NUM_BINS       = 4,
  12:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	SHM_NUM_WAITER     = 2,
  13:/Users/Administrator/sos-2x/kernel/sos_shm.c **** };
  14:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
  15:/Users/Administrator/sos-2x/kernel/sos_shm.c **** typedef struct _shm_str {
  16:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	sos_shm_t name;
  17:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	void *mem;
  18:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	sos_pid_t owner;
  19:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	sos_pid_t waiter[SHM_NUM_WAITER];  // the tasks that are waiting on the memory
  20:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	struct _shm_str *next;
  21:/Users/Administrator/sos-2x/kernel/sos_shm.c **** } shm_cb;
  22:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
  23:/Users/Administrator/sos-2x/kernel/sos_shm.c **** typedef struct shm_pool_t {
  24:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	struct shm_pool_t *next;
  25:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	shm_cb pool[SHM_NUM_POOL_ITEMS];
  26:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	uint8_t alloc;
  27:/Users/Administrator/sos-2x/kernel/sos_shm.c **** } shm_pool_t;
  28:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
  29:/Users/Administrator/sos-2x/kernel/sos_shm.c **** //
  30:/Users/Administrator/sos-2x/kernel/sos_shm.c **** // Simple hash table
  31:/Users/Administrator/sos-2x/kernel/sos_shm.c **** //
  32:/Users/Administrator/sos-2x/kernel/sos_shm.c **** static shm_cb *shm_bin[SHM_NUM_BINS] = {NULL};
  33:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
  34:/Users/Administrator/sos-2x/kernel/sos_shm.c **** static slab_t shm_slab;
  35:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
  36:/Users/Administrator/sos-2x/kernel/sos_shm.c **** static inline uint8_t hash_bin(sos_shm_t name)
  37:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
  38:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	return name % SHM_NUM_BINS;
  39:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
  40:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
  41:/Users/Administrator/sos-2x/kernel/sos_shm.c **** static inline shm_cb *name_to_bin(sos_shm_t name)
  42:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
  43:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	return shm_bin[hash_bin(name)];
  44:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
  45:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
  46:/Users/Administrator/sos-2x/kernel/sos_shm.c **** static shm_cb *shm_lookup(sos_shm_t name) 
  47:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 224               	.LM1:
 225               	/* prologue: frame size=0 */
 226               	/* prologue end (size=0) */
 227 0000 9C01      		movw r18,r24
 228               	.LBB2:
 229               	.LBB3:
 231               	.LM2:
 232 0002 FC01      		movw r30,r24
 233 0004 E370      		andi r30,lo8(3)
 234 0006 F070      		andi r31,hi8(3)
 235 0008 EE0F      		add r30,r30
 236 000a FF1F      		adc r31,r31
 237 000c E050      		subi r30,lo8(-(shm_bin))
 238 000e F040      		sbci r31,hi8(-(shm_bin))
 239 0010 0190      		ld __tmp_reg__,Z+
 240 0012 F081      		ld r31,Z
 241 0014 E02D      		mov r30,__tmp_reg__
 242               	.L10:
 243               	.LBE3:
 244               	.LBE2:
  48:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	shm_cb *shm = name_to_bin(name);
  49:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	
  50:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	while(shm != NULL) {
  51:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		if(shm->name == name) {
  52:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 			return shm;
  53:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		}
  54:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		shm = shm->next;
 246               	.LM3:
 247 0016 3097      		sbiw r30,0
 248 0018 59F0      		breq .L9
 250               	.LM4:
 251 001a 8081      		ld r24,Z
 252 001c 9181      		ldd r25,Z+1
 253 001e 8217      		cp r24,r18
 254 0020 9307      		cpc r25,r19
 255 0022 11F4      		brne .L6
 257               	.LM5:
 258 0024 CF01      		movw r24,r30
 259 0026 0895      		ret
 260               	.L6:
 262               	.LM6:
 263 0028 0780      		ldd __tmp_reg__,Z+7
 264 002a F085      		ldd r31,Z+8
 265 002c E02D      		mov r30,__tmp_reg__
 266 002e F3CF      		rjmp .L10
 267               	.L9:
  55:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	}
  56:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	return NULL;
 269               	.LM7:
 270 0030 80E0      		ldi r24,lo8(0)
 271 0032 90E0      		ldi r25,hi8(0)
  57:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
 273               	.LM8:
 274 0034 0895      		ret
 275               	/* epilogue: frame size=0 */
 276 0036 0895      		ret
 277               	/* epilogue end (size=1) */
 278               	/* function shm_lookup size 28 (27) */
 283               	.Lscope0:
 289               	shm_send_event:
  58:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
  59:/Users/Administrator/sos-2x/kernel/sos_shm.c **** //
  60:/Users/Administrator/sos-2x/kernel/sos_shm.c **** // TODO: send message to the waiter
  61:/Users/Administrator/sos-2x/kernel/sos_shm.c **** //
  62:/Users/Administrator/sos-2x/kernel/sos_shm.c **** static void shm_send_event( shm_cb *cb, uint8_t type )
  63:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 291               	.LM9:
 292               	/* prologue: frame size=0 */
 293 0038 AF92      		push r10
 294 003a BF92      		push r11
 295 003c CF92      		push r12
 296 003e DF92      		push r13
 297 0040 EF92      		push r14
 298 0042 FF92      		push r15
 299 0044 0F93      		push r16
 300 0046 1F93      		push r17
 301 0048 CF93      		push r28
 302 004a DF93      		push r29
 303               	/* prologue end (size=10) */
 304 004c 6C01      		movw r12,r24
 305 004e A62E      		mov r10,r22
 306 0050 EC01      		movw r28,r24
 307 0052 2596      		adiw r28,5
 308 0054 81E0      		ldi r24,lo8(1)
 309 0056 B82E      		mov r11,r24
 310               	.L16:
  64:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	uint8_t i;
  65:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	for( i = 0; i < SHM_NUM_WAITER; i++ ) {
  66:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		if( cb->waiter[i] != NULL_PID ) {
 312               	.LM10:
 313 0058 8991      		ld r24,Y+
 314 005a 8F3F      		cpi r24,lo8(-1)
 315 005c 51F0      		breq .L14
  67:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 			post_short( cb->waiter[i], KER_SHM_PID, MSG_SHM, type, cb->name, 0 );
 317               	.LM11:
 318 005e EE24      		clr r14
 319 0060 FF24      		clr r15
 320 0062 F601      		movw r30,r12
 321 0064 0081      		ld r16,Z
 322 0066 1181      		ldd r17,Z+1
 323 0068 2A2D      		mov r18,r10
 324 006a 42E1      		ldi r20,lo8(18)
 325 006c 63E1      		ldi r22,lo8(19)
 326 006e 0E94 0000 		call post_short
 327               	.L14:
 329               	.LM12:
 330 0072 BA94      		dec r11
 331 0074 B7FE      		sbrs r11,7
 332 0076 F0CF      		rjmp .L16
 333               	/* epilogue: frame size=0 */
 334 0078 DF91      		pop r29
 335 007a CF91      		pop r28
 336 007c 1F91      		pop r17
 337 007e 0F91      		pop r16
 338 0080 FF90      		pop r15
 339 0082 EF90      		pop r14
 340 0084 DF90      		pop r13
 341 0086 CF90      		pop r12
 342 0088 BF90      		pop r11
 343 008a AF90      		pop r10
 344 008c 0895      		ret
 345               	/* epilogue end (size=11) */
 346               	/* function shm_send_event size 43 (22) */
 351               	.Lscope1:
 357               	.global	ker_shm_open
 359               	ker_shm_open:
  68:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		}
  69:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	}
  70:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
  71:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
  72:/Users/Administrator/sos-2x/kernel/sos_shm.c **** int8_t ker_shm_open(sos_pid_t pid, sos_shm_t name, void *shm)
  73:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 361               	.LM13:
 362               	/* prologue: frame size=0 */
 363 008e DF92      		push r13
 364 0090 EF92      		push r14
 365 0092 FF92      		push r15
 366 0094 0F93      		push r16
 367 0096 1F93      		push r17
 368 0098 CF93      		push r28
 369 009a DF93      		push r29
 370               	/* prologue end (size=7) */
 371 009c D82E      		mov r13,r24
 372 009e EB01      		movw r28,r22
 373 00a0 8A01      		movw r16,r20
  74:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	shm_cb *cb;	
  75:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	uint8_t i;
  76:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	
  77:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	if(shm_lookup(name) != NULL) {
 375               	.LM14:
 376 00a2 CB01      		movw r24,r22
 377 00a4 0E94 0000 		call shm_lookup
 378 00a8 7C01      		movw r14,r24
 379 00aa 892B      		or r24,r25
 380 00ac 19F0      		breq .L20
  78:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		return -EEXIST;
 382               	.LM15:
 383 00ae 8FEE      		ldi r24,lo8(-17)
 384 00b0 9FEF      		ldi r25,hi8(-17)
 385 00b2 24C0      		rjmp .L19
 386               	.L20:
  79:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	}
  80:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
  81:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	cb = ker_slab_alloc( &shm_slab, KER_SHM_PID );
 388               	.LM16:
 389 00b4 63E1      		ldi r22,lo8(19)
 390 00b6 80E0      		ldi r24,lo8(shm_slab)
 391 00b8 90E0      		ldi r25,hi8(shm_slab)
 392 00ba 0E94 0000 		call ker_slab_alloc
 393 00be DC01      		movw r26,r24
  82:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
  83:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	if( cb == NULL ) { return -ENOMEM; }
 395               	.LM17:
 396 00c0 0097      		sbiw r24,0
 397 00c2 19F4      		brne .L21
 398 00c4 84EF      		ldi r24,lo8(-12)
 399 00c6 9FEF      		ldi r25,hi8(-12)
 400 00c8 19C0      		rjmp .L19
 401               	.L21:
  84:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	
  85:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	cb->name = name;
 403               	.LM18:
 404 00ca CD93      		st X+,r28
 405 00cc DC93      		st X,r29
 406 00ce 1197      		sbiw r26,1
  86:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	cb->mem = shm;
 408               	.LM19:
 409 00d0 FC01      		movw r30,r24
 410 00d2 0283      		std Z+2,r16
 411 00d4 1383      		std Z+3,r17
  87:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	cb->owner = pid;
 413               	.LM20:
 414 00d6 D482      		std Z+4,r13
 415 00d8 8FEF      		ldi r24,lo8(-1)
  88:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	for( i = 0; i < SHM_NUM_WAITER; i++ ) {
  89:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		cb->waiter[i] = NULL_PID;
 417               	.LM21:
 418 00da 8583      		std Z+5,r24
 419 00dc 8683      		std Z+6,r24
 420               	.LBB4:
 421               	.LBB5:
 423               	.LM22:
 424 00de FE01      		movw r30,r28
 425 00e0 E370      		andi r30,lo8(3)
 426 00e2 F070      		andi r31,hi8(3)
 427 00e4 EE0F      		add r30,r30
 428 00e6 FF1F      		adc r31,r31
 429 00e8 E050      		subi r30,lo8(-(shm_bin))
 430 00ea F040      		sbci r31,hi8(-(shm_bin))
 431 00ec 8081      		ld r24,Z
 432 00ee 9181      		ldd r25,Z+1
 433               	.LBE5:
 434               	.LBE4:
 436               	.LM23:
 437 00f0 ED01      		movw r28,r26
 438 00f2 8F83      		std Y+7,r24
 439 00f4 9887      		std Y+8,r25
 441               	.LM24:
 442 00f6 A083      		st Z,r26
 443 00f8 B183      		std Z+1,r27
  90:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	}
  91:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
  92:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	cb->next = name_to_bin( name );
  93:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	shm_bin[ hash_bin( name ) ] = cb;
  94:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	return SOS_OK;	
 445               	.LM25:
 446 00fa C701      		movw r24,r14
 447               	.L19:
 448               	/* epilogue: frame size=0 */
 449 00fc DF91      		pop r29
 450 00fe CF91      		pop r28
 451 0100 1F91      		pop r17
 452 0102 0F91      		pop r16
 453 0104 FF90      		pop r15
 454 0106 EF90      		pop r14
 455 0108 DF90      		pop r13
 456 010a 0895      		ret
 457               	/* epilogue end (size=8) */
 458               	/* function ker_shm_open size 63 (48) */
 463               	.Lscope2:
 469               	.global	ker_shm_update
 471               	ker_shm_update:
  95:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
  96:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
  97:/Users/Administrator/sos-2x/kernel/sos_shm.c **** int8_t ker_shm_update(sos_pid_t pid, sos_shm_t name, void *shm)
  98:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 473               	.LM26:
 474               	/* prologue: frame size=0 */
 475 010c CF93      		push r28
 476 010e DF93      		push r29
 477               	/* prologue end (size=2) */
 478 0110 CB01      		movw r24,r22
 479 0112 EA01      		movw r28,r20
  99:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	shm_cb *cb = shm_lookup( name );
 481               	.LM27:
 482 0114 0E94 0000 		call shm_lookup
 483 0118 FC01      		movw r30,r24
 100:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	
 101:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	if( cb == NULL ) {
 485               	.LM28:
 486 011a 0097      		sbiw r24,0
 487 011c 19F4      		brne .L36
 102:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		return -EBADF;
 489               	.LM29:
 490 011e 87EF      		ldi r24,lo8(-9)
 491 0120 9FEF      		ldi r25,hi8(-9)
 492 0122 07C0      		rjmp .L35
 493               	.L36:
 103:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	}
 104:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	
 105:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	cb->mem = shm;
 495               	.LM30:
 496 0124 C283      		std Z+2,r28
 497 0126 D383      		std Z+3,r29
 106:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	
 107:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	shm_send_event( cb, SHM_UPDATED );
 499               	.LM31:
 500 0128 61E0      		ldi r22,lo8(1)
 501 012a 0E94 0000 		call shm_send_event
 108:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	return SOS_OK;
 503               	.LM32:
 504 012e 80E0      		ldi r24,lo8(0)
 505 0130 90E0      		ldi r25,hi8(0)
 506               	.L35:
 507               	/* epilogue: frame size=0 */
 508 0132 DF91      		pop r29
 509 0134 CF91      		pop r28
 510 0136 0895      		ret
 511               	/* epilogue end (size=3) */
 512               	/* function ker_shm_update size 22 (17) */
 517               	.Lscope3:
 522               	.global	ker_shm_close
 524               	ker_shm_close:
 109:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
 110:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
 111:/Users/Administrator/sos-2x/kernel/sos_shm.c **** int8_t ker_shm_close(sos_pid_t pid, sos_shm_t name)
 112:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 526               	.LM33:
 527               	/* prologue: frame size=0 */
 528 0138 CF93      		push r28
 529 013a DF93      		push r29
 530               	/* prologue end (size=2) */
 531 013c 282F      		mov r18,r24
 532               	.LBB6:
 533               	.LBB7:
 535               	.LM34:
 536 013e FB01      		movw r30,r22
 537 0140 E370      		andi r30,lo8(3)
 538 0142 F070      		andi r31,hi8(3)
 539 0144 EE0F      		add r30,r30
 540 0146 FF1F      		adc r31,r31
 541 0148 E050      		subi r30,lo8(-(shm_bin))
 542 014a F040      		sbci r31,hi8(-(shm_bin))
 543 014c 0190      		ld __tmp_reg__,Z+
 544 014e F081      		ld r31,Z
 545 0150 E02D      		mov r30,__tmp_reg__
 546               	.LBE7:
 547               	.LBE6:
 113:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	shm_cb *head = name_to_bin(name);
 114:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	shm_cb *prev;
 115:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	shm_cb *curr;
 116:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
 117:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	if( head == NULL ) {
 549               	.LM35:
 550 0152 3097      		sbiw r30,0
 551 0154 21F4      		brne .L40
 552 0156 32C0      		rjmp .L52
 553               	.L51:
 118:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		return -EBADF;
 119:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	}
 120:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	
 121:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	prev = head;
 122:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	curr = head;
 123:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	while(curr != NULL) {
 124:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		if( curr->name == name ) {
 125:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 			if( pid != curr->owner ) {
 126:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 				return -EPERM;
 555               	.LM36:
 556 0158 8FEF      		ldi r24,lo8(-1)
 557 015a 9FEF      		ldi r25,hi8(-1)
 558 015c 31C0      		rjmp .L37
 559               	.L40:
 561               	.LM37:
 562 015e EF01      		movw r28,r30
 564               	.LM38:
 565 0160 DF01      		movw r26,r30
 566               	.L48:
 568               	.LM39:
 569 0162 8881      		ld r24,Y
 570 0164 9981      		ldd r25,Y+1
 571 0166 8617      		cp r24,r22
 572 0168 9707      		cpc r25,r23
 573 016a 11F5      		brne .L43
 575               	.LM40:
 576 016c 8C81      		ldd r24,Y+4
 577 016e 2817      		cp r18,r24
 578 0170 99F7      		brne .L51
 579 0172 8F81      		ldd r24,Y+7
 580 0174 9885      		ldd r25,Y+8
 127:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 			}
 128:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 			if( curr == head ) {
 582               	.LM41:
 583 0176 CE17      		cp r28,r30
 584 0178 DF07      		cpc r29,r31
 585 017a 59F4      		brne .L45
 586               	.LBB8:
 587               	.LBB9:
 589               	.LM42:
 590 017c 6370      		andi r22,lo8(3)
 591 017e 7070      		andi r23,hi8(3)
 592               	.LBE9:
 593               	.LBE8:
 595               	.LM43:
 596 0180 660F      		add r22,r22
 597 0182 712D      		mov r23,__zero_reg__
 598 0184 711D      		adc r23,__zero_reg__
 599 0186 FB01      		movw r30,r22
 600 0188 E050      		subi r30,lo8(-(shm_bin))
 601 018a F040      		sbci r31,hi8(-(shm_bin))
 602 018c 8083      		st Z,r24
 603 018e 9183      		std Z+1,r25
 604 0190 03C0      		rjmp .L47
 605               	.L45:
 129:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 				//! remove head
 130:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 				shm_bin[ hash_bin( name ) ] = head->next;
 131:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 			} else {
 132:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 				prev->next = curr->next;
 607               	.LM44:
 608 0192 FD01      		movw r30,r26
 609 0194 8783      		std Z+7,r24
 610 0196 9087      		std Z+8,r25
 611               	.L47:
 133:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 			}
 134:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 			shm_send_event( curr, SHM_CLOSED );
 613               	.LM45:
 614 0198 62E0      		ldi r22,lo8(2)
 615 019a CE01      		movw r24,r28
 616 019c 0E94 0000 		call shm_send_event
 135:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 			ker_slab_free( &shm_slab, curr);
 618               	.LM46:
 619 01a0 BE01      		movw r22,r28
 620 01a2 80E0      		ldi r24,lo8(shm_slab)
 621 01a4 90E0      		ldi r25,hi8(shm_slab)
 622 01a6 0E94 0000 		call ker_slab_free
 136:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 			return SOS_OK;
 624               	.LM47:
 625 01aa 80E0      		ldi r24,lo8(0)
 626 01ac 90E0      		ldi r25,hi8(0)
 627 01ae 08C0      		rjmp .L37
 628               	.L43:
 137:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		}
 138:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		prev = curr;
 630               	.LM48:
 631 01b0 DE01      		movw r26,r28
 139:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		curr = curr->next;
 633               	.LM49:
 634 01b2 0F80      		ldd __tmp_reg__,Y+7
 635 01b4 D885      		ldd r29,Y+8
 636 01b6 C02D      		mov r28,__tmp_reg__
 637 01b8 2097      		sbiw r28,0
 638 01ba 99F6      		brne .L48
 639               	.L52:
 140:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	}
 141:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	return -EBADF;
 641               	.LM50:
 642 01bc 87EF      		ldi r24,lo8(-9)
 643 01be 9FEF      		ldi r25,hi8(-9)
 644               	.L37:
 645               	/* epilogue: frame size=0 */
 646 01c0 DF91      		pop r29
 647 01c2 CF91      		pop r28
 648 01c4 0895      		ret
 649               	/* epilogue end (size=3) */
 650               	/* function ker_shm_close size 71 (66) */
 657               	.Lscope4:
 662               	.global	ker_shm_get
 664               	ker_shm_get:
 142:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
 143:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
 144:/Users/Administrator/sos-2x/kernel/sos_shm.c **** void* ker_shm_get(sos_pid_t pid, sos_shm_t name)
 145:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 666               	.LM51:
 667               	/* prologue: frame size=0 */
 668               	/* prologue end (size=0) */
 669 01c6 CB01      		movw r24,r22
 146:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	shm_cb *cb = shm_lookup( name );
 671               	.LM52:
 672 01c8 0E94 0000 		call shm_lookup
 673 01cc FC01      		movw r30,r24
 147:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
 148:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	if(cb != NULL) return cb->mem;
 675               	.LM53:
 676 01ce 0097      		sbiw r24,0
 677 01d0 19F0      		breq .L54
 679               	.LM54:
 680 01d2 8281      		ldd r24,Z+2
 681 01d4 9381      		ldd r25,Z+3
 682 01d6 0895      		ret
 683               	.L54:
 149:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	return NULL;
 150:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
 685               	.LM55:
 686 01d8 0895      		ret
 687               	/* epilogue: frame size=0 */
 688 01da 0895      		ret
 689               	/* epilogue end (size=1) */
 690               	/* function ker_shm_get size 11 (10) */
 695               	.Lscope5:
 700               	.global	ker_shm_wait
 702               	ker_shm_wait:
 151:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
 152:/Users/Administrator/sos-2x/kernel/sos_shm.c **** int8_t ker_shm_wait( sos_pid_t pid, sos_shm_t name )
 153:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 704               	.LM56:
 705               	/* prologue: frame size=0 */
 706 01dc CF93      		push r28
 707               	/* prologue end (size=1) */
 708 01de C82F      		mov r28,r24
 709 01e0 CB01      		movw r24,r22
 154:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	shm_cb *cb = shm_lookup( name );
 711               	.LM57:
 712 01e2 0E94 0000 		call shm_lookup
 155:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	uint8_t i;
 156:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	
 157:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	if( cb == NULL ) {
 714               	.LM58:
 715 01e6 0097      		sbiw r24,0
 716 01e8 39F4      		brne .L56
 158:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		return -EBADF;
 718               	.LM59:
 719 01ea 87EF      		ldi r24,lo8(-9)
 720 01ec 9FEF      		ldi r25,hi8(-9)
 721 01ee 11C0      		rjmp .L55
 722               	.L64:
 159:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	}
 160:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	
 161:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	for( i = 0; i < SHM_NUM_WAITER; i++ ) {
 162:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		if( cb->waiter[i] == NULL_PID ) {
 163:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 			cb->waiter[i] = pid;
 724               	.LM60:
 725 01f0 C583      		std Z+5,r28
 164:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 			return SOS_OK;
 727               	.LM61:
 728 01f2 80E0      		ldi r24,lo8(0)
 729 01f4 90E0      		ldi r25,hi8(0)
 730 01f6 0DC0      		rjmp .L55
 731               	.L56:
 733               	.LM62:
 734 01f8 20E0      		ldi r18,lo8(0)
 735 01fa DC01      		movw r26,r24
 736 01fc 1596      		adiw r26,5
 737 01fe FC01      		movw r30,r24
 738               	.L61:
 740               	.LM63:
 741 0200 8D91      		ld r24,X+
 742 0202 8F3F      		cpi r24,lo8(-1)
 743 0204 A9F3      		breq .L64
 745               	.LM64:
 746 0206 2F5F      		subi r18,lo8(-(1))
 747 0208 3196      		adiw r30,1
 748 020a 2230      		cpi r18,lo8(2)
 749 020c C8F3      		brlo .L61
 165:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		}
 166:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	}
 167:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	return -ENOMEM;
 751               	.LM65:
 752 020e 84EF      		ldi r24,lo8(-12)
 753 0210 9FEF      		ldi r25,hi8(-12)
 754               	.L55:
 755               	/* epilogue: frame size=0 */
 756 0212 CF91      		pop r28
 757 0214 0895      		ret
 758               	/* epilogue end (size=2) */
 759               	/* function ker_shm_wait size 29 (26) */
 765               	.Lscope6:
 770               	.global	ker_shm_stopwait
 772               	ker_shm_stopwait:
 168:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
 169:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
 170:/Users/Administrator/sos-2x/kernel/sos_shm.c **** int8_t ker_shm_stopwait( sos_pid_t pid, sos_shm_t name )
 171:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 774               	.LM66:
 775               	/* prologue: frame size=0 */
 776 0216 CF93      		push r28
 777               	/* prologue end (size=1) */
 778 0218 C82F      		mov r28,r24
 779 021a CB01      		movw r24,r22
 172:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	shm_cb *cb = shm_lookup( name );
 781               	.LM67:
 782 021c 0E94 0000 		call shm_lookup
 173:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	uint8_t i;
 174:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	
 175:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	if( cb == NULL ) {
 784               	.LM68:
 785 0220 0097      		sbiw r24,0
 786 0222 41F4      		brne .L66
 176:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		return -EBADF;
 788               	.LM69:
 789 0224 87EF      		ldi r24,lo8(-9)
 790 0226 9FEF      		ldi r25,hi8(-9)
 791 0228 12C0      		rjmp .L65
 792               	.L74:
 177:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	}
 178:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	
 179:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	for( i = 0; i < SHM_NUM_WAITER; i++ ) {
 180:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		if( cb->waiter[i] == pid ) {
 181:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 			cb->waiter[i] = NULL_PID;
 794               	.LM70:
 795 022a 8FEF      		ldi r24,lo8(-1)
 796 022c 8583      		std Z+5,r24
 182:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 			return SOS_OK;
 798               	.LM71:
 799 022e 80E0      		ldi r24,lo8(0)
 800 0230 90E0      		ldi r25,hi8(0)
 801 0232 0DC0      		rjmp .L65
 802               	.L66:
 804               	.LM72:
 805 0234 20E0      		ldi r18,lo8(0)
 806 0236 DC01      		movw r26,r24
 807 0238 1596      		adiw r26,5
 808 023a FC01      		movw r30,r24
 809               	.L71:
 811               	.LM73:
 812 023c 8D91      		ld r24,X+
 813 023e 8C17      		cp r24,r28
 814 0240 A1F3      		breq .L74
 816               	.LM74:
 817 0242 2F5F      		subi r18,lo8(-(1))
 818 0244 3196      		adiw r30,1
 819 0246 2230      		cpi r18,lo8(2)
 820 0248 C8F3      		brlo .L71
 183:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		}
 184:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	}
 185:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	return -EINVAL;
 822               	.LM75:
 823 024a 8AEE      		ldi r24,lo8(-22)
 824 024c 9FEF      		ldi r25,hi8(-22)
 825               	.L65:
 826               	/* epilogue: frame size=0 */
 827 024e CF91      		pop r28
 828 0250 0895      		ret
 829               	/* epilogue end (size=2) */
 830               	/* function ker_shm_stopwait size 30 (27) */
 836               	.Lscope7:
 841               	.global	ker_sys_shm_open
 843               	ker_sys_shm_open:
 186:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
 187:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
 188:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #ifdef SOS_USE_PREEMPTION
 189:/Users/Administrator/sos-2x/kernel/sos_shm.c **** int8_t ker_sys_shm_open( sos_shm_t name, void *shm )
 190:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 191:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   HAS_ATOMIC_PREEMPTION_SECTION;
 192:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   sos_pid_t my_id = ker_get_current_pid();
 193:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   ATOMIC_DISABLE_PREEMPTION();
 194:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   if( ker_shm_open( my_id, name, shm ) != SOS_OK ) {
 195:/Users/Administrator/sos-2x/kernel/sos_shm.c ****     ATOMIC_ENABLE_PREEMPTION();
 196:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #ifdef SOS_TEST_SUITE
 197:/Users/Administrator/sos-2x/kernel/sos_shm.c ****     return -EINVAL;
 198:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #else
 199:/Users/Administrator/sos-2x/kernel/sos_shm.c ****     return ker_mod_panic( my_id );
 200:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #endif
 201:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   }
 202:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   ATOMIC_ENABLE_PREEMPTION();
 203:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   return SOS_OK;
 204:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
 205:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
 206:/Users/Administrator/sos-2x/kernel/sos_shm.c **** int8_t ker_sys_shm_update( sos_shm_t name, void *shm )
 207:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 208:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   HAS_ATOMIC_PREEMPTION_SECTION;
 209:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   sos_pid_t my_id = ker_get_current_pid();
 210:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   ATOMIC_DISABLE_PREEMPTION();
 211:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   if( ker_shm_update( my_id, name, shm ) != SOS_OK ) {
 212:/Users/Administrator/sos-2x/kernel/sos_shm.c ****     ATOMIC_ENABLE_PREEMPTION();
 213:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #ifdef SOS_TEST_SUITE
 214:/Users/Administrator/sos-2x/kernel/sos_shm.c ****     return -EINVAL;
 215:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #else
 216:/Users/Administrator/sos-2x/kernel/sos_shm.c ****     return ker_mod_panic( my_id );
 217:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #endif
 218:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   }
 219:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   ATOMIC_ENABLE_PREEMPTION();
 220:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   return SOS_OK;
 221:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
 222:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
 223:/Users/Administrator/sos-2x/kernel/sos_shm.c **** int8_t ker_sys_shm_close( sos_shm_t name )
 224:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 225:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   HAS_ATOMIC_PREEMPTION_SECTION;
 226:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   sos_pid_t my_id = ker_get_current_pid();
 227:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   ATOMIC_DISABLE_PREEMPTION();
 228:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   if( ker_shm_close( my_id, name ) != SOS_OK ) {
 229:/Users/Administrator/sos-2x/kernel/sos_shm.c ****     ATOMIC_ENABLE_PREEMPTION();
 230:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #ifdef SOS_TEST_SUITE
 231:/Users/Administrator/sos-2x/kernel/sos_shm.c ****     return -EINVAL;
 232:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #else
 233:/Users/Administrator/sos-2x/kernel/sos_shm.c ****     return ker_mod_panic( my_id );
 234:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #endif
 235:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   }
 236:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   ATOMIC_ENABLE_PREEMPTION();
 237:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   return SOS_OK;
 238:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
 239:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
 240:/Users/Administrator/sos-2x/kernel/sos_shm.c **** void* ker_sys_shm_get( sos_shm_t name )
 241:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 242:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   HAS_ATOMIC_PREEMPTION_SECTION;
 243:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   sos_pid_t my_id = ker_get_current_pid();
 244:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   void* ret;
 245:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   ATOMIC_DISABLE_PREEMPTION();
 246:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   ret = ker_shm_get( my_id, name );
 247:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   ATOMIC_ENABLE_PREEMPTION();
 248:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   return ret;
 249:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
 250:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
 251:/Users/Administrator/sos-2x/kernel/sos_shm.c **** int8_t ker_sys_shm_wait( sos_shm_t name )
 252:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 253:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   HAS_ATOMIC_PREEMPTION_SECTION;
 254:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   sos_pid_t my_id = ker_get_current_pid();
 255:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   ATOMIC_DISABLE_PREEMPTION();
 256:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   if( ker_shm_wait( my_id, name ) != SOS_OK ) {
 257:/Users/Administrator/sos-2x/kernel/sos_shm.c ****     ATOMIC_ENABLE_PREEMPTION();
 258:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #ifdef SOS_TEST_SUITE
 259:/Users/Administrator/sos-2x/kernel/sos_shm.c ****     return -EINVAL;
 260:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #else
 261:/Users/Administrator/sos-2x/kernel/sos_shm.c ****     return ker_mod_panic( my_id );
 262:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #endif
 263:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   }
 264:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   ATOMIC_ENABLE_PREEMPTION();
 265:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   return SOS_OK;
 266:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
 267:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
 268:/Users/Administrator/sos-2x/kernel/sos_shm.c **** int8_t ker_sys_shm_stopwait( sos_shm_t name )
 269:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 270:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   HAS_ATOMIC_PREEMPTION_SECTION;
 271:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   sos_pid_t my_id = ker_get_current_pid();
 272:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   ATOMIC_DISABLE_PREEMPTION();
 273:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   if( ker_shm_stopwait( my_id, name ) != SOS_OK ) {
 274:/Users/Administrator/sos-2x/kernel/sos_shm.c ****     ATOMIC_ENABLE_PREEMPTION();
 275:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #ifdef SOS_TEST_SUITE
 276:/Users/Administrator/sos-2x/kernel/sos_shm.c ****     return -EINVAL;
 277:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #else
 278:/Users/Administrator/sos-2x/kernel/sos_shm.c ****     return ker_mod_panic( my_id );
 279:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #endif
 280:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   }
 281:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   ATOMIC_ENABLE_PREEMPTION();
 282:/Users/Administrator/sos-2x/kernel/sos_shm.c ****   return SOS_OK;
 283:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
 284:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
 285:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #else
 286:/Users/Administrator/sos-2x/kernel/sos_shm.c **** int8_t ker_sys_shm_open( sos_shm_t name, void *shm )
 287:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 845               	.LM76:
 846               	/* prologue: frame size=0 */
 847 0252 EF92      		push r14
 848 0254 FF92      		push r15
 849 0256 0F93      		push r16
 850 0258 1F93      		push r17
 851 025a CF93      		push r28
 852               	/* prologue end (size=5) */
 853 025c 7C01      		movw r14,r24
 854 025e 8B01      		movw r16,r22
 288:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	sos_pid_t my_id = ker_get_current_pid();
 856               	.LM77:
 857 0260 0E94 0000 		call ker_get_current_pid
 858 0264 C82F      		mov r28,r24
 289:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	
 290:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	if( ker_shm_open( my_id, name, shm ) != SOS_OK ) {
 860               	.LM78:
 861 0266 A801      		movw r20,r16
 862 0268 B701      		movw r22,r14
 863 026a 0E94 0000 		call ker_shm_open
 864 026e 8823      		tst r24
 865 0270 39F0      		breq .L76
 291:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #ifdef SOS_TEST_SUITE
 292:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	    	return -EINVAL;
 293:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #else
 294:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		return ker_mod_panic( my_id );
 867               	.LM79:
 868 0272 8C2F      		mov r24,r28
 869 0274 0E94 0000 		call ker_mod_panic
 870 0278 9927      		clr r25
 871 027a 87FD      		sbrc r24,7
 872 027c 9095      		com r25
 873 027e 02C0      		rjmp .L75
 874               	.L76:
 295:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #endif
 296:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	}
 297:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	return SOS_OK;
 876               	.LM80:
 877 0280 80E0      		ldi r24,lo8(0)
 878 0282 90E0      		ldi r25,hi8(0)
 879               	.L75:
 880               	/* epilogue: frame size=0 */
 881 0284 CF91      		pop r28
 882 0286 1F91      		pop r17
 883 0288 0F91      		pop r16
 884 028a FF90      		pop r15
 885 028c EF90      		pop r14
 886 028e 0895      		ret
 887               	/* epilogue end (size=6) */
 888               	/* function ker_sys_shm_open size 31 (20) */
 893               	.Lscope8:
 898               	.global	ker_sys_shm_update
 900               	ker_sys_shm_update:
 298:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
 299:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
 300:/Users/Administrator/sos-2x/kernel/sos_shm.c **** int8_t ker_sys_shm_update( sos_shm_t name, void *shm )
 301:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 902               	.LM81:
 903               	/* prologue: frame size=0 */
 904 0290 EF92      		push r14
 905 0292 FF92      		push r15
 906 0294 0F93      		push r16
 907 0296 1F93      		push r17
 908 0298 CF93      		push r28
 909               	/* prologue end (size=5) */
 910 029a 7C01      		movw r14,r24
 911 029c 8B01      		movw r16,r22
 302:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	sos_pid_t my_id = ker_get_current_pid();
 913               	.LM82:
 914 029e 0E94 0000 		call ker_get_current_pid
 915 02a2 C82F      		mov r28,r24
 303:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	
 304:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	if( ker_shm_update( my_id, name, shm ) != SOS_OK ) {
 917               	.LM83:
 918 02a4 A801      		movw r20,r16
 919 02a6 B701      		movw r22,r14
 920 02a8 0E94 0000 		call ker_shm_update
 921 02ac 8823      		tst r24
 922 02ae 39F0      		breq .L78
 305:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #ifdef SOS_TEST_SUITE
 306:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	    	return -EINVAL;
 307:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #else
 308:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		return ker_mod_panic( my_id );
 924               	.LM84:
 925 02b0 8C2F      		mov r24,r28
 926 02b2 0E94 0000 		call ker_mod_panic
 927 02b6 9927      		clr r25
 928 02b8 87FD      		sbrc r24,7
 929 02ba 9095      		com r25
 930 02bc 02C0      		rjmp .L77
 931               	.L78:
 309:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #endif
 310:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	}
 311:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	return SOS_OK;
 933               	.LM85:
 934 02be 80E0      		ldi r24,lo8(0)
 935 02c0 90E0      		ldi r25,hi8(0)
 936               	.L77:
 937               	/* epilogue: frame size=0 */
 938 02c2 CF91      		pop r28
 939 02c4 1F91      		pop r17
 940 02c6 0F91      		pop r16
 941 02c8 FF90      		pop r15
 942 02ca EF90      		pop r14
 943 02cc 0895      		ret
 944               	/* epilogue end (size=6) */
 945               	/* function ker_sys_shm_update size 31 (20) */
 950               	.Lscope9:
 954               	.global	ker_sys_shm_close
 956               	ker_sys_shm_close:
 312:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
 313:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
 314:/Users/Administrator/sos-2x/kernel/sos_shm.c **** int8_t ker_sys_shm_close( sos_shm_t name )
 315:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 958               	.LM86:
 959               	/* prologue: frame size=0 */
 960 02ce 0F93      		push r16
 961 02d0 1F93      		push r17
 962 02d2 CF93      		push r28
 963               	/* prologue end (size=3) */
 964 02d4 8C01      		movw r16,r24
 316:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	sos_pid_t my_id = ker_get_current_pid();
 966               	.LM87:
 967 02d6 0E94 0000 		call ker_get_current_pid
 968 02da C82F      		mov r28,r24
 317:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	
 318:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	if( ker_shm_close( my_id, name ) != SOS_OK ) {
 970               	.LM88:
 971 02dc B801      		movw r22,r16
 972 02de 0E94 0000 		call ker_shm_close
 973 02e2 8823      		tst r24
 974 02e4 39F0      		breq .L80
 319:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #ifdef SOS_TEST_SUITE
 320:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	    	return -EINVAL;
 321:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #else
 322:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		return ker_mod_panic( my_id );
 976               	.LM89:
 977 02e6 8C2F      		mov r24,r28
 978 02e8 0E94 0000 		call ker_mod_panic
 979 02ec 9927      		clr r25
 980 02ee 87FD      		sbrc r24,7
 981 02f0 9095      		com r25
 982 02f2 02C0      		rjmp .L79
 983               	.L80:
 323:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #endif
 324:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	}
 325:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	return SOS_OK;
 985               	.LM90:
 986 02f4 80E0      		ldi r24,lo8(0)
 987 02f6 90E0      		ldi r25,hi8(0)
 988               	.L79:
 989               	/* epilogue: frame size=0 */
 990 02f8 CF91      		pop r28
 991 02fa 1F91      		pop r17
 992 02fc 0F91      		pop r16
 993 02fe 0895      		ret
 994               	/* epilogue end (size=4) */
 995               	/* function ker_sys_shm_close size 25 (18) */
 1000               	.Lscope10:
 1004               	.global	ker_sys_shm_get
 1006               	ker_sys_shm_get:
 326:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
 327:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
 328:/Users/Administrator/sos-2x/kernel/sos_shm.c **** void* ker_sys_shm_get( sos_shm_t name )
 329:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 1008               	.LM91:
 1009               	/* prologue: frame size=0 */
 1010 0300 0F93      		push r16
 1011 0302 1F93      		push r17
 1012               	/* prologue end (size=2) */
 1013 0304 8C01      		movw r16,r24
 330:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	sos_pid_t my_id = ker_get_current_pid();
 1015               	.LM92:
 1016 0306 0E94 0000 		call ker_get_current_pid
 331:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	
 332:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	return ker_shm_get( my_id, name );
 1018               	.LM93:
 1019 030a B801      		movw r22,r16
 1020 030c 0E94 0000 		call ker_shm_get
 1021               	/* epilogue: frame size=0 */
 1022 0310 1F91      		pop r17
 1023 0312 0F91      		pop r16
 1024 0314 0895      		ret
 1025               	/* epilogue end (size=3) */
 1026               	/* function ker_sys_shm_get size 11 (6) */
 1028               	.Lscope11:
 1032               	.global	ker_sys_shm_wait
 1034               	ker_sys_shm_wait:
 333:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
 334:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
 335:/Users/Administrator/sos-2x/kernel/sos_shm.c **** int8_t ker_sys_shm_wait( sos_shm_t name )
 336:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 1036               	.LM94:
 1037               	/* prologue: frame size=0 */
 1038 0316 0F93      		push r16
 1039 0318 1F93      		push r17
 1040 031a CF93      		push r28
 1041               	/* prologue end (size=3) */
 1042 031c 8C01      		movw r16,r24
 337:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	sos_pid_t my_id = ker_get_current_pid();
 1044               	.LM95:
 1045 031e 0E94 0000 		call ker_get_current_pid
 1046 0322 C82F      		mov r28,r24
 338:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	
 339:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	if( ker_shm_wait( my_id, name ) != SOS_OK ) {
 1048               	.LM96:
 1049 0324 B801      		movw r22,r16
 1050 0326 0E94 0000 		call ker_shm_wait
 1051 032a 8823      		tst r24
 1052 032c 39F0      		breq .L83
 340:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #ifdef SOS_TEST_SUITE
 341:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	    	return -EINVAL;
 342:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #else
 343:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		return ker_mod_panic( my_id );
 1054               	.LM97:
 1055 032e 8C2F      		mov r24,r28
 1056 0330 0E94 0000 		call ker_mod_panic
 1057 0334 9927      		clr r25
 1058 0336 87FD      		sbrc r24,7
 1059 0338 9095      		com r25
 1060 033a 02C0      		rjmp .L82
 1061               	.L83:
 344:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #endif
 345:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	}
 346:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	return SOS_OK;
 1063               	.LM98:
 1064 033c 80E0      		ldi r24,lo8(0)
 1065 033e 90E0      		ldi r25,hi8(0)
 1066               	.L82:
 1067               	/* epilogue: frame size=0 */
 1068 0340 CF91      		pop r28
 1069 0342 1F91      		pop r17
 1070 0344 0F91      		pop r16
 1071 0346 0895      		ret
 1072               	/* epilogue end (size=4) */
 1073               	/* function ker_sys_shm_wait size 25 (18) */
 1078               	.Lscope12:
 1082               	.global	ker_sys_shm_stopwait
 1084               	ker_sys_shm_stopwait:
 347:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
 348:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
 349:/Users/Administrator/sos-2x/kernel/sos_shm.c **** int8_t ker_sys_shm_stopwait( sos_shm_t name )
 350:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 1086               	.LM99:
 1087               	/* prologue: frame size=0 */
 1088 0348 0F93      		push r16
 1089 034a 1F93      		push r17
 1090 034c CF93      		push r28
 1091               	/* prologue end (size=3) */
 1092 034e 8C01      		movw r16,r24
 351:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	sos_pid_t my_id = ker_get_current_pid();
 1094               	.LM100:
 1095 0350 0E94 0000 		call ker_get_current_pid
 1096 0354 C82F      		mov r28,r24
 352:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	
 353:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	if( ker_shm_stopwait( my_id, name ) != SOS_OK ) {
 1098               	.LM101:
 1099 0356 B801      		movw r22,r16
 1100 0358 0E94 0000 		call ker_shm_stopwait
 1101 035c 8823      		tst r24
 1102 035e 39F0      		breq .L85
 354:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #ifdef SOS_TEST_SUITE
 355:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	    	return -EINVAL;
 356:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #else
 357:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		return ker_mod_panic( my_id );
 1104               	.LM102:
 1105 0360 8C2F      		mov r24,r28
 1106 0362 0E94 0000 		call ker_mod_panic
 1107 0366 9927      		clr r25
 1108 0368 87FD      		sbrc r24,7
 1109 036a 9095      		com r25
 1110 036c 02C0      		rjmp .L84
 1111               	.L85:
 358:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #endif
 359:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	}
 360:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	return SOS_OK;
 1113               	.LM103:
 1114 036e 80E0      		ldi r24,lo8(0)
 1115 0370 90E0      		ldi r25,hi8(0)
 1116               	.L84:
 1117               	/* epilogue: frame size=0 */
 1118 0372 CF91      		pop r28
 1119 0374 1F91      		pop r17
 1120 0376 0F91      		pop r16
 1121 0378 0895      		ret
 1122               	/* epilogue end (size=4) */
 1123               	/* function ker_sys_shm_stopwait size 25 (18) */
 1128               	.Lscope13:
 1132               	.global	shm_remove_all
 1134               	shm_remove_all:
 361:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
 362:/Users/Administrator/sos-2x/kernel/sos_shm.c **** #endif
 363:/Users/Administrator/sos-2x/kernel/sos_shm.c **** //
 364:/Users/Administrator/sos-2x/kernel/sos_shm.c **** // Remove all data associated with the pid
 365:/Users/Administrator/sos-2x/kernel/sos_shm.c **** //
 366:/Users/Administrator/sos-2x/kernel/sos_shm.c **** int8_t shm_remove_all( sos_pid_t pid )
 367:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 1136               	.LM104:
 1137               	/* prologue: frame size=0 */
 1138 037a AF92      		push r10
 1139 037c BF92      		push r11
 1140 037e CF92      		push r12
 1141 0380 DF92      		push r13
 1142 0382 EF92      		push r14
 1143 0384 FF92      		push r15
 1144 0386 0F93      		push r16
 1145 0388 1F93      		push r17
 1146 038a CF93      		push r28
 1147 038c DF93      		push r29
 1148               	/* prologue end (size=10) */
 1149 038e A82E      		mov r10,r24
 1150 0390 23E0      		ldi r18,lo8(3)
 1151 0392 B22E      		mov r11,r18
 1152 0394 90E0      		ldi r25,lo8(shm_bin)
 1153 0396 E92E      		mov r14,r25
 1154 0398 90E0      		ldi r25,hi8(shm_bin)
 1155 039a F92E      		mov r15,r25
 1156               	.L102:
 1157               	.LBB10:
 368:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	uint8_t i;
 369:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	
 370:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	for( i = 0; i < SHM_NUM_BINS; i++ ) {
 371:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		shm_cb *prev = NULL;
 372:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		shm_cb *curr = shm_bin[i];
 1159               	.LM105:
 1160 039c F701      		movw r30,r14
 1161 039e C081      		ld r28,Z
 1162 03a0 D181      		ldd r29,Z+1
 373:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		prev = curr;
 1164               	.LM106:
 1165 03a2 6E01      		movw r12,r28
 1166               	.L110:
 374:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		
 375:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		while( curr != NULL ) {
 376:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 			if( curr->owner == pid ) {
 377:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 				shm_cb *tmp = curr;
 378:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 				//
 379:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 				// Remove the owner
 380:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 				//
 381:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 				if( curr == shm_bin[i] ) {
 382:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 					//! remove head
 383:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 					shm_bin[ i ] = curr->next;
 384:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 				} else {
 385:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 					prev->next = curr->next;
 386:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 				}
 387:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 				
 388:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 				curr = curr->next;
 389:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 				shm_send_event( tmp, SHM_CLOSED );
 390:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 				ker_slab_free( &shm_slab, tmp );
 391:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 				
 392:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 			} else {
 393:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 				uint8_t j;
 394:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 				for( j = 0; j < SHM_NUM_WAITER; j++ ) {
 395:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 					if( curr->waiter[j] == pid ) {
 396:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 						curr->waiter[j] = NULL_PID;
 397:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 					}
 398:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 				}
 399:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 				prev = curr;
 400:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 				curr = curr->next;
 1168               	.LM107:
 1169 03a4 2097      		sbiw r28,0
 1170 03a6 79F1      		breq .L106
 1172               	.LM108:
 1173 03a8 8C81      		ldd r24,Y+4
 1174 03aa 8A15      		cp r24,r10
 1175 03ac E1F4      		brne .L92
 1176               	.LBB11:
 1178               	.LM109:
 1179 03ae 8E01      		movw r16,r28
 1181               	.LM110:
 1182 03b0 F701      		movw r30,r14
 1183 03b2 8081      		ld r24,Z
 1184 03b4 9181      		ldd r25,Z+1
 1185 03b6 2F81      		ldd r18,Y+7
 1186 03b8 3885      		ldd r19,Y+8
 1187 03ba C817      		cp r28,r24
 1188 03bc D907      		cpc r29,r25
 1189 03be 19F4      		brne .L93
 1191               	.LM111:
 1192 03c0 2083      		st Z,r18
 1193 03c2 3183      		std Z+1,r19
 1194 03c4 03C0      		rjmp .L94
 1195               	.L93:
 1197               	.LM112:
 1198 03c6 F601      		movw r30,r12
 1199 03c8 2783      		std Z+7,r18
 1200 03ca 3087      		std Z+8,r19
 1201               	.L94:
 1203               	.LM113:
 1204 03cc 0F80      		ldd __tmp_reg__,Y+7
 1205 03ce D885      		ldd r29,Y+8
 1206 03d0 C02D      		mov r28,__tmp_reg__
 1208               	.LM114:
 1209 03d2 62E0      		ldi r22,lo8(2)
 1210 03d4 C801      		movw r24,r16
 1211 03d6 0E94 0000 		call shm_send_event
 1213               	.LM115:
 1214 03da B801      		movw r22,r16
 1215 03dc 80E0      		ldi r24,lo8(shm_slab)
 1216 03de 90E0      		ldi r25,hi8(shm_slab)
 1217 03e0 0E94 0000 		call ker_slab_free
 1218               	.LBE11:
 1219 03e4 DFCF      		rjmp .L110
 1220               	.L92:
 1221 03e6 2FEF      		ldi r18,lo8(-1)
 1222 03e8 FE01      		movw r30,r28
 1223 03ea 91E0      		ldi r25,lo8(1)
 1224               	.L100:
 1225               	.LBB12:
 1227               	.LM116:
 1228 03ec 8581      		ldd r24,Z+5
 1229 03ee 8A15      		cp r24,r10
 1230 03f0 09F4      		brne .L98
 1232               	.LM117:
 1233 03f2 2583      		std Z+5,r18
 1234               	.L98:
 1236               	.LM118:
 1237 03f4 9150      		subi r25,lo8(-(-1))
 1238 03f6 3196      		adiw r30,1
 1239 03f8 97FF      		sbrs r25,7
 1240 03fa F8CF      		rjmp .L100
 1242               	.LM119:
 1243 03fc 6E01      		movw r12,r28
 1245               	.LM120:
 1246 03fe 0F80      		ldd __tmp_reg__,Y+7
 1247 0400 D885      		ldd r29,Y+8
 1248 0402 C02D      		mov r28,__tmp_reg__
 1249 0404 CFCF      		rjmp .L110
 1250               	.L106:
 1251               	.LBE12:
 1252               	.LBE10:
 1254               	.LM121:
 1255 0406 BA94      		dec r11
 1256 0408 82E0      		ldi r24,lo8(2)
 1257 040a 90E0      		ldi r25,hi8(2)
 1258 040c E80E      		add r14,r24
 1259 040e F91E      		adc r15,r25
 1260 0410 B7FE      		sbrs r11,7
 1261 0412 C4CF      		rjmp .L102
 401:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 			}
 402:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		}
 403:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	}
 404:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	return SOS_OK;
 405:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
 1263               	.LM122:
 1264 0414 80E0      		ldi r24,lo8(0)
 1265 0416 90E0      		ldi r25,hi8(0)
 1266               	/* epilogue: frame size=0 */
 1267 0418 DF91      		pop r29
 1268 041a CF91      		pop r28
 1269 041c 1F91      		pop r17
 1270 041e 0F91      		pop r16
 1271 0420 FF90      		pop r15
 1272 0422 EF90      		pop r14
 1273 0424 DF90      		pop r13
 1274 0426 CF90      		pop r12
 1275 0428 BF90      		pop r11
 1276 042a AF90      		pop r10
 1277 042c 0895      		ret
 1278               	/* epilogue end (size=11) */
 1279               	/* function shm_remove_all size 90 (69) */
 1294               	.Lscope14:
 1297               	.global	shm_gc
 1299               	shm_gc:
 406:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
 407:/Users/Administrator/sos-2x/kernel/sos_shm.c **** void shm_gc( void )
 408:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 1301               	.LM123:
 1302               	/* prologue: frame size=0 */
 1303 042e EF92      		push r14
 1304 0430 FF92      		push r15
 1305 0432 1F93      		push r17
 1306 0434 CF93      		push r28
 1307 0436 DF93      		push r29
 1308               	/* prologue end (size=5) */
 1309 0438 13E0      		ldi r17,lo8(3)
 1310 043a 30E0      		ldi r19,lo8(shm_bin)
 1311 043c E32E      		mov r14,r19
 1312 043e 30E0      		ldi r19,hi8(shm_bin)
 1313 0440 F32E      		mov r15,r19
 1314               	.L118:
 1315               	.LBB13:
 409:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	uint8_t i;
 410:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	
 411:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	//
 412:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	// Mark all slab memory
 413:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	//
 414:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	for( i = 0; i < SHM_NUM_BINS; i++ ) {
 415:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		shm_cb *itr = shm_bin[i];
 1317               	.LM124:
 1318 0442 F701      		movw r30,r14
 1319 0444 C191      		ld r28,Z+
 1320 0446 D191      		ld r29,Z+
 1321 0448 7F01      		movw r14,r30
 1322               	.L123:
 416:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		
 417:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		while( itr != NULL ) {
 418:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 			slab_gc_mark( &shm_slab, itr );
 419:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 			itr = itr->next;
 1324               	.LM125:
 1325 044a 2097      		sbiw r28,0
 1326 044c 49F0      		breq .L122
 1328               	.LM126:
 1329 044e BE01      		movw r22,r28
 1330 0450 80E0      		ldi r24,lo8(shm_slab)
 1331 0452 90E0      		ldi r25,hi8(shm_slab)
 1332 0454 0E94 0000 		call slab_gc_mark
 1334               	.LM127:
 1335 0458 0F80      		ldd __tmp_reg__,Y+7
 1336 045a D885      		ldd r29,Y+8
 1337 045c C02D      		mov r28,__tmp_reg__
 1338 045e F5CF      		rjmp .L123
 1339               	.L122:
 1340               	.LBE13:
 1342               	.LM128:
 1343 0460 1150      		subi r17,lo8(-(-1))
 1344 0462 17FF      		sbrs r17,7
 1345 0464 EECF      		rjmp .L118
 420:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		}
 421:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	}
 422:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	
 423:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	//
 424:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	// GC slab memory
 425:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	//
 426:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	slab_gc( &shm_slab, KER_SHM_PID );
 1347               	.LM129:
 1348 0466 63E1      		ldi r22,lo8(19)
 1349 0468 80E0      		ldi r24,lo8(shm_slab)
 1350 046a 90E0      		ldi r25,hi8(shm_slab)
 1351 046c 0E94 0000 		call slab_gc
 427:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	//
 428:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	// GC the shm
 429:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	//
 430:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	malloc_gc( KER_SHM_PID );
 1353               	.LM130:
 1354 0470 83E1      		ldi r24,lo8(19)
 1355 0472 0E94 0000 		call malloc_gc
 1356               	/* epilogue: frame size=0 */
 1357 0476 DF91      		pop r29
 1358 0478 CF91      		pop r28
 1359 047a 1F91      		pop r17
 1360 047c FF90      		pop r15
 1361 047e EF90      		pop r14
 1362 0480 0895      		ret
 1363               	/* epilogue end (size=6) */
 1364               	/* function shm_gc size 42 (31) */
 1372               	.Lscope15:
 1375               	.global	shm_init
 1377               	shm_init:
 431:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
 432:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 
 433:/Users/Administrator/sos-2x/kernel/sos_shm.c **** int8_t shm_init( void )
 434:/Users/Administrator/sos-2x/kernel/sos_shm.c **** {
 1379               	.LM131:
 1380               	/* prologue: frame size=0 */
 1381 0482 0F93      		push r16
 1382               	/* prologue end (size=1) */
 1383 0484 23E0      		ldi r18,lo8(3)
 1384 0486 E0E0      		ldi r30,lo8(shm_bin)
 1385 0488 F0E0      		ldi r31,hi8(shm_bin)
 1386               	.L128:
 435:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	uint8_t i;
 436:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	
 437:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	for( i = 0; i < SHM_NUM_BINS; i++ ) {
 438:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 		shm_bin[i] = NULL;
 1388               	.LM132:
 1389 048a 1192      		st Z+,__zero_reg__
 1390 048c 1192      		st Z+,__zero_reg__
 1392               	.LM133:
 1393 048e 2150      		subi r18,lo8(-(-1))
 1394 0490 27FF      		sbrs r18,7
 1395 0492 FBCF      		rjmp .L128
 1396 0494 24E0      		ldi r18,lo8(4)
 439:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	}
 440:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	ker_slab_init( KER_SHM_PID, &shm_slab, sizeof( shm_cb ), 4, SLAB_LONGTERM );
 1398               	.LM134:
 1399 0496 00E8      		ldi r16,lo8(-128)
 1400 0498 49E0      		ldi r20,lo8(9)
 1401 049a 60E0      		ldi r22,lo8(shm_slab)
 1402 049c 70E0      		ldi r23,hi8(shm_slab)
 1403 049e 83E1      		ldi r24,lo8(19)
 1404 04a0 0E94 0000 		call ker_slab_init
 441:/Users/Administrator/sos-2x/kernel/sos_shm.c **** 	return SOS_OK;
 442:/Users/Administrator/sos-2x/kernel/sos_shm.c **** }
 1406               	.LM135:
 1407 04a4 80E0      		ldi r24,lo8(0)
 1408 04a6 90E0      		ldi r25,hi8(0)
 1409               	/* epilogue: frame size=0 */
 1410 04a8 0F91      		pop r16
 1411 04aa 0895      		ret
 1412               	/* epilogue end (size=2) */
 1413               	/* function shm_init size 21 (18) */
 1418               	.Lscope16:
 1420               		.lcomm shm_slab,6
 1423               		.text
 1425               	Letext:
 1426               	/* File "/Users/Administrator/sos-2x/kernel/sos_shm.c": code  598 = 0x0256 ( 461), prologues  60, e
DEFINED SYMBOLS
                            *ABS*:00000000 sos_shm.c
                            *ABS*:0000003f __SREG__
                            *ABS*:0000003e __SP_H__
                            *ABS*:0000003d __SP_L__
                            *ABS*:00000000 __tmp_reg__
                            *ABS*:00000001 __zero_reg__
                             .bss:00000000 shm_bin
/var/tmp//ccKnIt1f.s:222    .text:00000000 shm_lookup
/var/tmp//ccKnIt1f.s:289    .text:00000038 shm_send_event
/var/tmp//ccKnIt1f.s:359    .text:0000008e ker_shm_open
/var/tmp//ccKnIt1f.s:218    .bss:00000008 shm_slab
/var/tmp//ccKnIt1f.s:471    .text:0000010c ker_shm_update
/var/tmp//ccKnIt1f.s:524    .text:00000138 ker_shm_close
/var/tmp//ccKnIt1f.s:664    .text:000001c6 ker_shm_get
/var/tmp//ccKnIt1f.s:702    .text:000001dc ker_shm_wait
/var/tmp//ccKnIt1f.s:772    .text:00000216 ker_shm_stopwait
/var/tmp//ccKnIt1f.s:843    .text:00000252 ker_sys_shm_open
/var/tmp//ccKnIt1f.s:900    .text:00000290 ker_sys_shm_update
/var/tmp//ccKnIt1f.s:956    .text:000002ce ker_sys_shm_close
/var/tmp//ccKnIt1f.s:1006   .text:00000300 ker_sys_shm_get
/var/tmp//ccKnIt1f.s:1034   .text:00000316 ker_sys_shm_wait
/var/tmp//ccKnIt1f.s:1084   .text:00000348 ker_sys_shm_stopwait
/var/tmp//ccKnIt1f.s:1134   .text:0000037a shm_remove_all
/var/tmp//ccKnIt1f.s:1299   .text:0000042e shm_gc
/var/tmp//ccKnIt1f.s:1377   .text:00000482 shm_init
/var/tmp//ccKnIt1f.s:1425   .text:000004ac Letext

UNDEFINED SYMBOLS
__do_copy_data
__do_clear_bss
post_short
ker_slab_alloc
ker_slab_free
ker_get_current_pid
ker_mod_panic
slab_gc_mark
slab_gc
malloc_gc
ker_slab_init
