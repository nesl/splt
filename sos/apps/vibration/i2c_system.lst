   1               		.file	"i2c_system.c"
   2               		.arch atmega128
   3               	__SREG__ = 0x3f
   4               	__SP_H__ = 0x3e
   5               	__SP_L__ = 0x3d
   6               	__tmp_reg__ = 0
   7               	__zero_reg__ = 1
   8               		.global __do_copy_data
   9               		.global __do_clear_bss
  12               		.text
  13               	.Ltext0:
 307               	.global	i2c_system_init
 309               	i2c_system_init:
   1:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** /* -*- Mode: C; tab-width:2 -*- */
   2:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** /* ex: set ts=2 shiftwidth=2 softtabstop=2 cindent: */
   3:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** /**
   4:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****  * @file i2c_system.c
   5:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****  * @brief SOS interface to I2C
   6:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****  * @author Roy Shea
   7:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****  * @author David Lee (modified 4/7/2005)
   8:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****  **/
   9:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
  10:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** #include <net_stack.h>
  11:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** #include <message.h>
  12:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** #include <malloc.h>
  13:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** #include <hdlc.h>
  14:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** #include <crc.h>
  15:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** #include <sos_error_types.h>
  16:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
  17:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** //#define LED_DEBUG
  18:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** #include <led_dbg.h>
  19:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
  20:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** //#define UART_DEBUG
  21:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** #include <uart_dbg.h>
  22:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
  23:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** #include <i2c.h>
  24:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** #include <i2c_const.h>
  25:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** #include <i2c_system.h>
  26:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** #include <sos_i2c_mgr.h>
  27:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
  28:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
  29:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** enum {
  30:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	I2C_SYS_INIT=0,
  31:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	I2C_SYS_IDLE,
  32:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	I2C_SYS_MASTER_WAIT,
  33:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	I2C_SYS_MASTER_TX,
  34:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	I2C_SYS_MASTER_RX,
  35:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	I2C_SYS_SLAVE_WAIT,
  36:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	I2C_SYS_SLAVE_TX,
  37:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	I2C_SYS_SLAVE_RX,
  38:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** };
  39:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
  40:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
  41:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** typedef struct i2c_system_state {
  42:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	uint8_t calling_mod_id; // ID of the calling module
  43:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	uint8_t state;          // Protocol state of i2c_system.
  44:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	uint8_t ownAddr;
  45:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	
  46:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	uint8_t addr;           // slave address
  47:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	Message *msgBuf;
  48:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
  49:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	uint8_t *dataBuf;       // Transceiver buffer
  50:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	uint8_t rxLen;
  51:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
  52:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	uint8_t flags;
  53:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** } i2c_system_state_t;
  54:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
  55:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** static i2c_system_state_t i2c_sys;
  56:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
  57:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** /**
  58:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****  ****************************************
  59:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****  Initialize the I2C hardware on an AVR
  60:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****  ****************************************
  61:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****  */
  62:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** int8_t i2c_system_init() {
 311               	.LM1:
 312               	/* prologue: frame size=0 */
 313               	/* prologue end (size=0) */
  63:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
  64:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	i2c_sys.state = I2C_SYS_INIT;
 315               	.LM2:
 316 0000 1092 0000 		sts i2c_sys+1,__zero_reg__
  65:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
  66:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	i2c_hardware_init();
 318               	.LM3:
 319 0004 0E94 0000 		call i2c_hardware_init
  67:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	
  68:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	i2c_sys.calling_mod_id = NULL_PID;
 321               	.LM4:
 322 0008 8FEF      		ldi r24,lo8(-1)
 323 000a 8093 0000 		sts i2c_sys,r24
  69:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	i2c_sys.flags = I2C_SYS_NULL_FLAG;
 325               	.LM5:
 326 000e 1092 0000 		sts i2c_sys+9,__zero_reg__
  70:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	i2c_sys.msgBuf = NULL;
 328               	.LM6:
 329 0012 1092 0000 		sts (i2c_sys+4)+1,__zero_reg__
 330 0016 1092 0000 		sts i2c_sys+4,__zero_reg__
  71:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	i2c_sys.dataBuf = NULL;
 332               	.LM7:
 333 001a 1092 0000 		sts (i2c_sys+6)+1,__zero_reg__
 334 001e 1092 0000 		sts i2c_sys+6,__zero_reg__
  72:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	i2c_sys.rxLen = 0;
 336               	.LM8:
 337 0022 1092 0000 		sts i2c_sys+8,__zero_reg__
  73:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	i2c_sys.addr = I2C_BCAST_ADDRESS;
 339               	.LM9:
 340 0026 1092 0000 		sts i2c_sys+3,__zero_reg__
  74:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
  75:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	i2c_sys.ownAddr = I2C_ADDRESS;
 342               	.LM10:
 343 002a 82E0      		ldi r24,lo8(2)
 344 002c 8093 0000 		sts i2c_sys+2,r24
  76:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	i2c_initTransceiver(I2C_ADDRESS, I2C_SYS_MASTER_FLAG);
 346               	.LM11:
 347 0030 60E1      		ldi r22,lo8(16)
 348 0032 0E94 0000 		call i2c_initTransceiver
  77:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
  78:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	i2c_sys.state = I2C_SYS_IDLE;
 350               	.LM12:
 351 0036 81E0      		ldi r24,lo8(1)
 352 0038 8093 0000 		sts i2c_sys+1,r24
  79:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
  80:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	return SOS_OK;
  81:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** }
 354               	.LM13:
 355 003c 80E0      		ldi r24,lo8(0)
 356 003e 90E0      		ldi r25,hi8(0)
 357               	/* epilogue: frame size=0 */
 358 0040 0895      		ret
 359               	/* epilogue end (size=1) */
 360               	/* function i2c_system_init size 33 (32) */
 362               	.Lscope0:
 368               	.global	ker_i2c_reserve_bus
 370               	ker_i2c_reserve_bus:
  82:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
  83:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
  84:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** /**
  85:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****  ****************************************
  86:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****  SOS Specific Interface to the i2c
  87:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****  ****************************************
  88:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****  */
  89:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** int8_t ker_i2c_reserve_bus(uint8_t calling_id, uint8_t ownAddress, uint8_t flags) {
 372               	.LM14:
 373               	/* prologue: frame size=0 */
 374               	/* prologue end (size=0) */
 375 0042 262F      		mov r18,r22
  90:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
  91:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// can only reserve bus for raw use
  92:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// all incoming sos_msgs will be handed off to the scheduler
  93:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// this means that a module can not reserve the bus to read sos_msgs
  94:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	if ((flags & I2C_SYS_SOS_MSG_FLAG) && !(flags & I2C_SYS_TX_FLAG)) {
 377               	.LM15:
 378 0044 47FF      		sbrs r20,7
 379 0046 05C0      		rjmp .L3
 381               	.LM16:
 382 0048 46FD      		sbrc r20,6
 383 004a 03C0      		rjmp .L3
  95:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		return -EINVAL;
 385               	.LM17:
 386 004c 8AEE      		ldi r24,lo8(-22)
 387 004e 9FEF      		ldi r25,hi8(-22)
 388 0050 0895      		ret
 389               	.L3:
  96:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	}
  97:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
  98:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// if it is already reaserved AND
  99:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// it was reserved by another module OR it is currently busy
 100:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	if ((i2c_sys.calling_mod_id != NULL_PID) &&
 391               	.LM18:
 392 0052 9091 0000 		lds r25,i2c_sys
 393 0056 9F3F      		cpi r25,lo8(-1)
 394 0058 59F0      		breq .L4
 395 005a 9817      		cp r25,r24
 396 005c 31F4      		brne .L5
 397 005e 9091 0000 		lds r25,i2c_sys+1
 398 0062 9530      		cpi r25,lo8(5)
 399 0064 29F0      		breq .L4
 400 0066 9230      		cpi r25,lo8(2)
 401 0068 19F0      		breq .L4
 402               	.L5:
 101:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			((i2c_sys.calling_mod_id != calling_id) || ((i2c_sys.state != I2C_SYS_SLAVE_WAIT) && (i2c_sys.st
 102:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		LED_DBG(LED_RED_TOGGLE);
 103:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		return -EBUSY;
 404               	.LM19:
 405 006a 80EF      		ldi r24,lo8(-16)
 406 006c 9FEF      		ldi r25,hi8(-16)
 407 006e 0895      		ret
 408               	.L4:
 104:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	}
 105:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	i2c_sys.calling_mod_id = calling_id;
 410               	.LM20:
 411 0070 8093 0000 		sts i2c_sys,r24
 106:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 107:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	i2c_sys.ownAddr = ownAddress;
 413               	.LM21:
 414 0074 2093 0000 		sts i2c_sys+2,r18
 108:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	i2c_sys.flags = flags;
 416               	.LM22:
 417 0078 4093 0000 		sts i2c_sys+9,r20
 109:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 110:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	i2c_initTransceiver(ownAddress, i2c_sys.flags);
 419               	.LM23:
 420 007c 642F      		mov r22,r20
 421 007e 822F      		mov r24,r18
 422 0080 0E94 0000 		call i2c_initTransceiver
 111:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 112:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	if (i2c_sys.flags & I2C_SYS_MASTER_FLAG) {
 424               	.LM24:
 425 0084 8091 0000 		lds r24,i2c_sys+9
 426 0088 84FF      		sbrs r24,4
 427 008a 02C0      		rjmp .L6
 113:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		i2c_sys.state = I2C_SYS_MASTER_WAIT;
 429               	.LM25:
 430 008c 82E0      		ldi r24,lo8(2)
 431 008e 01C0      		rjmp .L8
 432               	.L6:
 114:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	} else {
 115:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		i2c_sys.state = I2C_SYS_SLAVE_WAIT;
 434               	.LM26:
 435 0090 85E0      		ldi r24,lo8(5)
 436               	.L8:
 437 0092 8093 0000 		sts i2c_sys+1,r24
 116:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	}
 117:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 118:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	LED_DBG(LED_GREEN_TOGGLE);
 119:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	return SOS_OK;
 439               	.LM27:
 440 0096 80E0      		ldi r24,lo8(0)
 441 0098 90E0      		ldi r25,hi8(0)
 120:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** }
 443               	.LM28:
 444 009a 0895      		ret
 445               	/* epilogue: frame size=0 */
 446 009c 0895      		ret
 447               	/* epilogue end (size=1) */
 448               	/* function ker_i2c_reserve_bus size 46 (45) */
 450               	.Lscope1:
 454               	.global	ker_i2c_release_bus
 456               	ker_i2c_release_bus:
 121:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 122:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 123:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** int8_t ker_i2c_release_bus(uint8_t calling_id) {
 458               	.LM29:
 459               	/* prologue: frame size=0 */
 460               	/* prologue end (size=0) */
 461 009e 982F      		mov r25,r24
 124:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 125:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****     // Always allow i2c_module to release i2c
 126:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****     // Otherwise, check that the correct module is calling the resease and
 127:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****     // that the i2c is not busy.
 128:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****     if (calling_id != I2C_PID) {
 463               	.LM30:
 464 00a0 8134      		cpi r24,lo8(65)
 465 00a2 91F0      		breq .L10
 129:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			if (i2c_sys.calling_mod_id != calling_id) {
 467               	.LM31:
 468 00a4 8091 0000 		lds r24,i2c_sys
 469 00a8 8917      		cp r24,r25
 470 00aa 19F0      		breq .L11
 130:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				return -EPERM;
 472               	.LM32:
 473 00ac 8FEF      		ldi r24,lo8(-1)
 474 00ae 9FEF      		ldi r25,hi8(-1)
 475 00b0 0895      		ret
 476               	.L11:
 131:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			}
 132:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****       if ((i2c_sys.state != I2C_SYS_IDLE) && (i2c_sys.state != I2C_SYS_SLAVE_WAIT) && (i2c_sys.stat
 478               	.LM33:
 479 00b2 8091 0000 		lds r24,i2c_sys+1
 480 00b6 8130      		cpi r24,lo8(1)
 481 00b8 39F0      		breq .L10
 482 00ba 8530      		cpi r24,lo8(5)
 483 00bc 29F0      		breq .L10
 484 00be 8230      		cpi r24,lo8(2)
 485 00c0 19F0      		breq .L10
 133:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				return -EBUSY;
 487               	.LM34:
 488 00c2 80EF      		ldi r24,lo8(-16)
 489 00c4 9FEF      		ldi r25,hi8(-16)
 490 00c6 0895      		ret
 491               	.L10:
 134:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			}
 135:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		}
 136:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		// release the i2c
 137:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****     i2c_sys.flags = 0;
 493               	.LM35:
 494 00c8 1092 0000 		sts i2c_sys+9,__zero_reg__
 138:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		i2c_sys.rxLen = 0;
 496               	.LM36:
 497 00cc 1092 0000 		sts i2c_sys+8,__zero_reg__
 139:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****     i2c_sys.calling_mod_id = NULL_PID;
 499               	.LM37:
 500 00d0 8FEF      		ldi r24,lo8(-1)
 501 00d2 8093 0000 		sts i2c_sys,r24
 140:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****     i2c_sys.state = I2C_SYS_IDLE;
 503               	.LM38:
 504 00d6 81E0      		ldi r24,lo8(1)
 505 00d8 8093 0000 		sts i2c_sys+1,r24
 141:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 142:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****     return SOS_OK;
 507               	.LM39:
 508 00dc 80E0      		ldi r24,lo8(0)
 509 00de 90E0      		ldi r25,hi8(0)
 143:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** }
 511               	.LM40:
 512 00e0 0895      		ret
 513               	/* epilogue: frame size=0 */
 514 00e2 0895      		ret
 515               	/* epilogue end (size=1) */
 516               	/* function ker_i2c_release_bus size 35 (34) */
 518               	.Lscope2:
 525               	.global	ker_i2c_send_data
 527               	ker_i2c_send_data:
 144:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 145:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 146:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** /**
 147:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****  * Send data over the i2c
 148:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****  */
 149:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** int8_t ker_i2c_send_data(
 150:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		uint8_t dest_addr,
 151:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		uint8_t *buff,
 152:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		uint8_t msg_size,
 153:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		uint8_t calling_id) {
 529               	.LM41:
 530               	/* prologue: frame size=0 */
 531               	/* prologue end (size=0) */
 532 00e4 982F      		mov r25,r24
 533 00e6 FB01      		movw r30,r22
 154:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 155:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// Check if others are using the i2c
 156:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	if (i2c_sys.state == I2C_SYS_IDLE) {  // bus not initialized??
 535               	.LM42:
 536 00e8 3091 0000 		lds r19,i2c_sys+1
 537 00ec 3130      		cpi r19,lo8(1)
 538 00ee E1F0      		breq .L24
 157:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		return -EINVAL;
 158:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	}
 159:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	if ((i2c_sys.calling_mod_id != calling_id) ||
 540               	.LM43:
 541 00f0 8091 0000 		lds r24,i2c_sys
 542 00f4 8217      		cp r24,r18
 543 00f6 21F4      		brne .L16
 544 00f8 3530      		cpi r19,lo8(5)
 545 00fa 29F0      		breq .L15
 546 00fc 3230      		cpi r19,lo8(2)
 547 00fe 19F0      		breq .L15
 548               	.L16:
 160:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			((i2c_sys.state != I2C_SYS_SLAVE_WAIT) && (i2c_sys.state != I2C_SYS_MASTER_WAIT))) {
 161:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		return -EBUSY;
 550               	.LM44:
 551 0100 80EF      		ldi r24,lo8(-16)
 552 0102 9FEF      		ldi r25,hi8(-16)
 553 0104 0895      		ret
 554               	.L15:
 162:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	}
 163:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	
 164:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// get a handle to the outgoing data
 165:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	i2c_sys.addr = dest_addr;
 556               	.LM45:
 557 0106 9093 0000 		sts i2c_sys+3,r25
 166:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	if (i2c_sys.flags & I2C_SYS_SOS_MSG_FLAG) {
 559               	.LM46:
 560 010a 8091 0000 		lds r24,i2c_sys+9
 561 010e 87FF      		sbrs r24,7
 562 0110 15C0      		rjmp .L17
 167:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		i2c_sys.msgBuf = (Message*)buff;
 564               	.LM47:
 565 0112 F093 0000 		sts (i2c_sys+4)+1,r31
 566 0116 E093 0000 		sts i2c_sys+4,r30
 168:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		if (i2c_sys.msgBuf->len != msg_size) { // invalid msg packet
 568               	.LM48:
 569 011a 8781      		ldd r24,Z+7
 570 011c 8417      		cp r24,r20
 571 011e 39F0      		breq .L18
 169:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			i2c_sys.msgBuf = NULL;
 573               	.LM49:
 574 0120 1092 0000 		sts (i2c_sys+4)+1,__zero_reg__
 575 0124 1092 0000 		sts i2c_sys+4,__zero_reg__
 576               	.L24:
 170:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			return -EINVAL;
 578               	.LM50:
 579 0128 8AEE      		ldi r24,lo8(-22)
 580 012a 9FEF      		ldi r25,hi8(-22)
 581 012c 0895      		ret
 582               	.L18:
 171:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		}
 172:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		i2c_sys.dataBuf = i2c_sys.msgBuf->data;
 584               	.LM51:
 585 012e 8085      		ldd r24,Z+8
 586 0130 9185      		ldd r25,Z+9
 587 0132 9093 0000 		sts (i2c_sys+6)+1,r25
 588 0136 8093 0000 		sts i2c_sys+6,r24
 589 013a 04C0      		rjmp .L19
 590               	.L17:
 173:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	} else {
 174:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		i2c_sys.dataBuf = buff;
 592               	.LM52:
 593 013c F093 0000 		sts (i2c_sys+6)+1,r31
 594 0140 E093 0000 		sts i2c_sys+6,r30
 595               	.L19:
 175:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	}
 176:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 177:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	if (i2c_sys.state == I2C_SYS_MASTER_WAIT) {
 597               	.LM53:
 598 0144 3230      		cpi r19,lo8(2)
 599 0146 59F4      		brne .L20
 178:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		if (i2c_startTransceiverTx(i2c_sys.addr, buff, msg_size, i2c_sys.flags) == SOS_OK) {
 601               	.LM54:
 602 0148 2091 0000 		lds r18,i2c_sys+9
 603 014c BF01      		movw r22,r30
 604 014e 8091 0000 		lds r24,i2c_sys+3
 605 0152 0E94 0000 		call i2c_startTransceiverTx
 606 0156 8823      		tst r24
 607 0158 89F4      		brne .L22
 179:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			i2c_sys.state = I2C_SYS_MASTER_TX;
 609               	.LM55:
 610 015a 83E0      		ldi r24,lo8(3)
 611 015c 0AC0      		rjmp .L25
 612               	.L20:
 180:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			return SOS_OK;
 181:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		}
 182:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	} else {
 183:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		if (i2c_startTransceiverTx(i2c_sys.addr, buff, msg_size, i2c_sys.flags) == SOS_OK) {
 614               	.LM56:
 615 015e 2091 0000 		lds r18,i2c_sys+9
 616 0162 BF01      		movw r22,r30
 617 0164 8091 0000 		lds r24,i2c_sys+3
 618 0168 0E94 0000 		call i2c_startTransceiverTx
 619 016c 8823      		tst r24
 620 016e 31F4      		brne .L22
 184:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			i2c_sys.state = I2C_SYS_SLAVE_TX;
 622               	.LM57:
 623 0170 86E0      		ldi r24,lo8(6)
 624               	.L25:
 625 0172 8093 0000 		sts i2c_sys+1,r24
 185:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			return SOS_OK;
 627               	.LM58:
 628 0176 80E0      		ldi r24,lo8(0)
 629 0178 90E0      		ldi r25,hi8(0)
 630 017a 0895      		ret
 631               	.L22:
 186:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		}
 187:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	}
 188:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// lower layer busy (async slave recieve?)
 189:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	return -EBUSY;
 633               	.LM59:
 634 017c 80EF      		ldi r24,lo8(-16)
 635 017e 9FEF      		ldi r25,hi8(-16)
 190:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** }
 637               	.LM60:
 638 0180 0895      		ret
 639               	/* epilogue: frame size=0 */
 640 0182 0895      		ret
 641               	/* epilogue end (size=1) */
 642               	/* function ker_i2c_send_data size 80 (79) */
 644               	.Lscope3:
 650               	.global	ker_i2c_read_data
 652               	ker_i2c_read_data:
 191:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 192:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 193:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** /**
 194:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****  * Read data from the i2c.
 195:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****  */
 196:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** int8_t ker_i2c_read_data(uint8_t dest_addr, uint8_t read_size, uint8_t calling_id) {
 654               	.LM61:
 655               	/* prologue: frame size=0 */
 656               	/* prologue end (size=0) */
 657 0184 282F      		mov r18,r24
 197:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 198:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	if (i2c_sys.state == I2C_SYS_IDLE) {  // bus not initialized??
 659               	.LM62:
 660 0186 9091 0000 		lds r25,i2c_sys+1
 661 018a 9130      		cpi r25,lo8(1)
 662 018c 19F4      		brne .L27
 199:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		return -EINVAL;
 664               	.LM63:
 665 018e 8AEE      		ldi r24,lo8(-22)
 666 0190 9FEF      		ldi r25,hi8(-22)
 667 0192 0895      		ret
 668               	.L27:
 200:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	}
 201:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// Check if others are using the i2c
 202:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	if ((i2c_sys.calling_mod_id != calling_id) ||
 670               	.LM64:
 671 0194 8091 0000 		lds r24,i2c_sys
 672 0198 8417      		cp r24,r20
 673 019a 21F4      		brne .L29
 674 019c 9530      		cpi r25,lo8(5)
 675 019e 29F0      		breq .L28
 676 01a0 9230      		cpi r25,lo8(2)
 677 01a2 19F0      		breq .L28
 678               	.L29:
 203:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			((i2c_sys.state != I2C_SYS_SLAVE_WAIT) && (i2c_sys.state != I2C_SYS_MASTER_WAIT))) {
 204:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		return -EBUSY;
 680               	.LM65:
 681 01a4 80EF      		ldi r24,lo8(-16)
 682 01a6 9FEF      		ldi r25,hi8(-16)
 683 01a8 0895      		ret
 684               	.L28:
 205:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	}
 206:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	i2c_sys.addr = dest_addr;
 686               	.LM66:
 687 01aa 2093 0000 		sts i2c_sys+3,r18
 207:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	i2c_sys.rxLen = read_size;
 689               	.LM67:
 690 01ae 6093 0000 		sts i2c_sys+8,r22
 208:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 209:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	if (i2c_sys.state == I2C_SYS_MASTER_WAIT) {
 692               	.LM68:
 693 01b2 9230      		cpi r25,lo8(2)
 694 01b4 49F4      		brne .L30
 210:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		if (i2c_startTransceiverRx(i2c_sys.addr, read_size, i2c_sys.flags) == SOS_OK) {
 696               	.LM69:
 697 01b6 4091 0000 		lds r20,i2c_sys+9
 698 01ba 822F      		mov r24,r18
 699 01bc 0E94 0000 		call i2c_startTransceiverRx
 700 01c0 8823      		tst r24
 701 01c2 79F4      		brne .L32
 211:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			i2c_sys.state = I2C_SYS_MASTER_RX;
 703               	.LM70:
 704 01c4 84E0      		ldi r24,lo8(4)
 705 01c6 08C0      		rjmp .L34
 706               	.L30:
 212:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			return SOS_OK;
 213:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		}
 214:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	} else {
 215:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		if (i2c_startTransceiverRx(i2c_sys.addr, read_size, i2c_sys.flags) == SOS_OK) {
 708               	.LM71:
 709 01c8 4091 0000 		lds r20,i2c_sys+9
 710 01cc 822F      		mov r24,r18
 711 01ce 0E94 0000 		call i2c_startTransceiverRx
 712 01d2 8823      		tst r24
 713 01d4 31F4      		brne .L32
 216:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			i2c_sys.state = I2C_SYS_SLAVE_RX;
 715               	.LM72:
 716 01d6 87E0      		ldi r24,lo8(7)
 717               	.L34:
 718 01d8 8093 0000 		sts i2c_sys+1,r24
 217:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			return SOS_OK;
 720               	.LM73:
 721 01dc 80E0      		ldi r24,lo8(0)
 722 01de 90E0      		ldi r25,hi8(0)
 723 01e0 0895      		ret
 724               	.L32:
 218:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		}
 219:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	}
 220:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// lower layer busy (async slave recieve?)
 221:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	return -EBUSY;
 726               	.LM74:
 727 01e2 80EF      		ldi r24,lo8(-16)
 728 01e4 9FEF      		ldi r25,hi8(-16)
 222:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** }
 730               	.LM75:
 731 01e6 0895      		ret
 732               	/* epilogue: frame size=0 */
 733 01e8 0895      		ret
 734               	/* epilogue end (size=1) */
 735               	/* function ker_i2c_read_data size 51 (50) */
 737               	.Lscope4:
 741               	.global	i2c_send_done
 743               	i2c_send_done:
 223:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 224:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 225:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** static inline void resetTransceiver() {
 226:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	i2c_initTransceiver(i2c_sys.ownAddr, i2c_sys.flags);
 227:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	if(i2c_sys.flags & I2C_SYS_MASTER_FLAG) {
 228:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		i2c_sys.state = I2C_SYS_MASTER_WAIT;
 229:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	} else {
 230:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		i2c_sys.state = I2C_SYS_SLAVE_WAIT;
 231:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	}
 232:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** }
 233:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 234:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 235:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** /**
 236:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****  * Send MSG_I2C_SEND_DONE
 237:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****  */
 238:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** void i2c_send_done(uint8_t status) {
 745               	.LM76:
 746               	/* prologue: frame size=0 */
 747 01ea EF92      		push r14
 748 01ec FF92      		push r15
 749 01ee 0F93      		push r16
 750 01f0 1F93      		push r17
 751               	/* prologue end (size=4) */
 752 01f2 982F      		mov r25,r24
 239:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 240:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// figure out if we have someone to send this message to
 241:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	if ((i2c_sys.calling_mod_id != NULL_PID) &&
 754               	.LM77:
 755 01f4 8091 0000 		lds r24,i2c_sys
 756 01f8 8F3F      		cpi r24,lo8(-1)
 757 01fa C1F1      		breq .L35
 759               	.LM78:
 760 01fc 8091 0000 		lds r24,i2c_sys+1
 761 0200 8330      		cpi r24,lo8(3)
 762 0202 19F4      		brne .L38
 763 0204 94FD      		sbrc r25,4
 764 0206 03C0      		rjmp .L37
 765 0208 31C0      		rjmp .L35
 766               	.L38:
 767 020a 8630      		cpi r24,lo8(6)
 768 020c 79F5      		brne .L35
 769               	.L37:
 242:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			(((i2c_sys.state == I2C_SYS_MASTER_TX) && (status & I2C_SYS_MASTER_FLAG)) || ((i2c_sys.state == 
 243:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		/* bus was reserved by someone AND
 244:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		 * bus reserved as master and a send was requested, packet transmited as a master
 245:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		 * OR bus reserved as slave and a send was requested */
 246:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		
 247:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		if (status & I2C_SYS_ERROR_FLAG) {
 771               	.LM79:
 772 020e 892F      		mov r24,r25
 773 0210 9927      		clr r25
 774 0212 80FF      		sbrs r24,0
 775 0214 06C0      		rjmp .L39
 248:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			post_short(i2c_sys.calling_mod_id, I2C_PID, MSG_I2C_SEND_DONE, 0, 0, SOS_MSG_SEND_FAIL|SOS_MSG_H
 777               	.LM80:
 778 0216 32E4      		ldi r19,lo8(66)
 779 0218 E32E      		mov r14,r19
 780 021a F12C      		mov r15,__zero_reg__
 781 021c 00E0      		ldi r16,lo8(0)
 782 021e 10E0      		ldi r17,hi8(0)
 783 0220 15C0      		rjmp .L47
 784               	.L39:
 249:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		} else if(status & I2C_SYS_RX_PEND_FLAG) {
 786               	.LM81:
 787 0222 25E0      		ldi r18,5
 788 0224 9695      	1:	lsr r25
 789 0226 8795      		ror r24
 790 0228 2A95      		dec r18
 791 022a E1F7      		brne 1b
 792 022c 8C01      		movw r16,r24
 793 022e 0170      		andi r16,lo8(1)
 794 0230 1070      		andi r17,hi8(1)
 795 0232 80FF      		sbrs r24,0
 796 0234 08C0      		rjmp .L41
 250:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			// This is the result of a read request done sending the destination
 251:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			// address and now waiting for the read done
 252:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			i2c_sys.state = (i2c_sys.flags & I2C_SYS_MASTER_FLAG)?I2C_SYS_MASTER_RX:I2C_SYS_SLAVE_RX;
 798               	.LM82:
 799 0236 8091 0000 		lds r24,i2c_sys+9
 800 023a 84FF      		sbrs r24,4
 801 023c 02C0      		rjmp .L42
 802 023e 84E0      		ldi r24,lo8(4)
 803 0240 13C0      		rjmp .L46
 804               	.L42:
 805 0242 87E0      		ldi r24,lo8(7)
 806 0244 11C0      		rjmp .L46
 807               	.L41:
 253:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			return;
 254:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		} else {
 255:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			post_short(i2c_sys.calling_mod_id, I2C_PID, MSG_I2C_SEND_DONE, 0, 0, SOS_MSG_HIGH_PRIORITY);
 809               	.LM83:
 810 0246 80E4      		ldi r24,lo8(64)
 811 0248 E82E      		mov r14,r24
 812 024a F12C      		mov r15,__zero_reg__
 813               	.L47:
 814 024c 20E0      		ldi r18,lo8(0)
 815 024e 40E4      		ldi r20,lo8(64)
 816 0250 61E4      		ldi r22,lo8(65)
 817 0252 8091 0000 		lds r24,i2c_sys
 818 0256 0E94 0000 		call post_short
 256:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		}
 257:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		i2c_sys.state = (i2c_sys.flags & I2C_SYS_MASTER_FLAG)?I2C_SYS_MASTER_WAIT:I2C_SYS_SLAVE_WAIT;
 820               	.LM84:
 821 025a 8091 0000 		lds r24,i2c_sys+9
 822 025e 84FF      		sbrs r24,4
 823 0260 02C0      		rjmp .L45
 824 0262 82E0      		ldi r24,lo8(2)
 825 0264 01C0      		rjmp .L46
 826               	.L45:
 827 0266 85E0      		ldi r24,lo8(5)
 828               	.L46:
 829 0268 8093 0000 		sts i2c_sys+1,r24
 830               	.L35:
 831               	/* epilogue: frame size=0 */
 832 026c 1F91      		pop r17
 833 026e 0F91      		pop r16
 834 0270 FF90      		pop r15
 835 0272 EF90      		pop r14
 836 0274 0895      		ret
 837               	/* epilogue end (size=5) */
 838               	/* function i2c_send_done size 70 (61) */
 840               	.Lscope5:
 846               	.global	i2c_read_done
 848               	i2c_read_done:
 258:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	}
 259:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** }
 260:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 261:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 262:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** /**
 263:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****  * Send MSG_I2C_READ_DONE
 264:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c ****  */
 265:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** void i2c_read_done(uint8_t *buff, uint8_t len, uint8_t status) {
 850               	.LM85:
 851               	/* prologue: frame size=0 */
 852 0276 AF92      		push r10
 853 0278 BF92      		push r11
 854 027a CF92      		push r12
 855 027c DF92      		push r13
 856 027e EF92      		push r14
 857 0280 FF92      		push r15
 858 0282 0F93      		push r16
 859 0284 1F93      		push r17
 860 0286 CF93      		push r28
 861 0288 DF93      		push r29
 862               	/* prologue end (size=10) */
 863 028a 6C01      		movw r12,r24
 266:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 267:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	uint8_t *bufPtr = NULL;
 268:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	Message *msgPtr = NULL;
 269:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 270:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// this is a problem that should be handled
 271:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	if (buff == NULL) {
 865               	.LM86:
 866 028c 892B      		or r24,r25
 867 028e 09F4      		brne .+2
 868 0290 EAC0      		rjmp .L48
 272:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		return;
 273:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	}
 274:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 275:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	if ((i2c_sys.calling_mod_id != NULL_PID) && (status & I2C_SYS_ERROR_FLAG)) {
 870               	.LM87:
 871 0292 8091 0000 		lds r24,i2c_sys
 872 0296 8F3F      		cpi r24,lo8(-1)
 873 0298 11F0      		breq .L50
 874 029a 40FD      		sbrc r20,0
 875 029c D8C0      		rjmp .L51
 876               	.L50:
 276:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		goto post_error_msg;
 277:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	}
 278:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 279:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// the bus was reserved the read was of the length we requested
 280:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	if ((i2c_sys.calling_mod_id != NULL_PID) && (len == i2c_sys.rxLen) && 
 878               	.LM88:
 879 029e 8F3F      		cpi r24,lo8(-1)
 880 02a0 21F1      		breq .L52
 881 02a2 8091 0000 		lds r24,i2c_sys+8
 882 02a6 6817      		cp r22,r24
 883 02a8 01F5      		brne .L52
 884 02aa 8091 0000 		lds r24,i2c_sys+1
 885 02ae 8430      		cpi r24,lo8(4)
 886 02b0 19F4      		brne .L54
 887 02b2 44FD      		sbrc r20,4
 888 02b4 05C0      		rjmp .L53
 889 02b6 19C0      		rjmp .L52
 890               	.L54:
 891 02b8 8730      		cpi r24,lo8(7)
 892 02ba B9F4      		brne .L52
 893 02bc 44FD      		sbrc r20,4
 894 02be 15C0      		rjmp .L52
 895               	.L53:
 281:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			// the data was recieved in the correct mode
 282:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			(((i2c_sys.state == I2C_SYS_MASTER_RX) && (I2C_SYS_MASTER_FLAG & status)) ||
 283:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			 ((i2c_sys.state == I2C_SYS_SLAVE_RX) && !(I2C_SYS_MASTER_FLAG & status)))) {
 284:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 285:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		// reserved read done will only be raw reads, wrap in message and send
 286:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		post_long(
 897               	.LM89:
 898 02c0 C4E4      		ldi r28,lo8(68)
 899 02c2 EC2E      		mov r14,r28
 900 02c4 F12C      		mov r15,__zero_reg__
 901 02c6 8601      		movw r16,r12
 902 02c8 262F      		mov r18,r22
 903 02ca 41E4      		ldi r20,lo8(65)
 904 02cc 642F      		mov r22,r20
 905 02ce 8091 0000 		lds r24,i2c_sys
 906 02d2 0E94 0000 		call post_long
 287:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				i2c_sys.calling_mod_id,
 288:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				I2C_PID,
 289:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				MSG_I2C_READ_DONE,
 290:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				len,
 291:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				buff,
 292:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				SOS_MSG_RELEASE|SOS_MSG_HIGH_PRIORITY);
 293:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		i2c_sys.state = (i2c_sys.flags & I2C_SYS_MASTER_FLAG)?I2C_SYS_MASTER_WAIT:I2C_SYS_SLAVE_WAIT;
 908               	.LM90:
 909 02d6 8091 0000 		lds r24,i2c_sys+9
 910 02da 84FF      		sbrs r24,4
 911 02dc 02C0      		rjmp .L55
 912 02de 82E0      		ldi r24,lo8(2)
 913 02e0 01C0      		rjmp .L56
 914               	.L55:
 915 02e2 85E0      		ldi r24,lo8(5)
 916               	.L56:
 917 02e4 8093 0000 		sts i2c_sys+1,r24
 294:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		return;
 919               	.LM91:
 920 02e8 BEC0      		rjmp .L48
 921               	.L52:
 295:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	}
 296:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 297:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// there appers to be a bug in avr-gcc this a work around to make sure
 298:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// the cast to message works correctly
 299:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// the following code seems to cat the value 0x800008 independent of what
 300:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// buff actually ii2c_sys.  this has no correlation to the data in buff or the 
 301:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// value of the pointer the cast (along with many others that should) works
 302:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// in gdb but fail to execute correctly when compilied
 303:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	/* bufPtr = &buff[HDLC_PROTOCOL_SIZE]; */
 304:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 305:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// DO NOT CHANGE THIS SECTION OF CODE
 306:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// start of section
 307:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	bufPtr = buff+1;
 923               	.LM92:
 924 02ea 8601      		movw r16,r12
 925 02ec 0F5F      		subi r16,lo8(-(1))
 926 02ee 1F4F      		sbci r17,hi8(-(1))
 927 02f0 5801      		movw r10,r16
 308:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// end of DO NOT CHANGE SECTION
 309:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		
 310:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// if it passes sanity checks give it to the scheduler
 311:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	if (!(I2C_SYS_MASTER_FLAG & status) && (len >= SOS_MSG_HEADER_SIZE) && (buff[0] == HDLC_SOS_MSG)) 
 929               	.LM93:
 930 02f2 44FD      		sbrc r20,4
 931 02f4 ACC0      		rjmp .L51
 932 02f6 6830      		cpi r22,lo8(8)
 933 02f8 08F4      		brsh .+2
 934 02fa A9C0      		rjmp .L51
 935 02fc F601      		movw r30,r12
 936 02fe 8081      		ld r24,Z
 937 0300 8130      		cpi r24,lo8(1)
 938 0302 09F0      		breq .+2
 939 0304 A4C0      		rjmp .L51
 312:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 313:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		if ((len >= (HDLC_PROTOCOL_SIZE + SOS_MSG_HEADER_SIZE + ((Message*)bufPtr)->len + SOS_MSG_CRC_SIZ
 941               	.LM94:
 942 0306 262F      		mov r18,r22
 943 0308 3327      		clr r19
 944 030a F801      		movw r30,r16
 945 030c 8781      		ldd r24,Z+7
 946 030e 9927      		clr r25
 947 0310 0B96      		adiw r24,11
 948 0312 2817      		cp r18,r24
 949 0314 3907      		cpc r19,r25
 950 0316 08F4      		brsh .+2
 951 0318 9AC0      		rjmp .L51
 952 031a 6138      		cpi r22,lo8(-127)
 953 031c 08F0      		brlo .+2
 954 031e 97C0      		rjmp .L51
 314:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				(len <= I2C_MAX_MSG_LEN)) {
 315:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 316:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			// please do not edit the next line
 317:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			bufPtr = buff;
 318:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			// we have enough bytes for it to be a message, lets start the copy out
 319:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			// XXX msgPtr = (Message*)ker_malloc(sizeof(Message), I2C_PID);
 320:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			msgPtr = msg_create();
 956               	.LM95:
 957 0320 0E94 0000 		call msg_create
 958 0324 EC01      		movw r28,r24
 321:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			if (msgPtr !=NULL) {
 960               	.LM96:
 961 0326 892B      		or r24,r25
 962 0328 09F4      		brne .+2
 963 032a 91C0      		rjmp .L51
 964               	.LBB2:
 965               	.LBB3:
 967               	.Ltext1:
   1:/Users/Administrator/sos-2x/processor/avr/include/crc.h **** /* -*- Mode: C; tab-width:4 -*- */
   2:/Users/Administrator/sos-2x/processor/avr/include/crc.h **** /* ex: set ts=4: */
   3:/Users/Administrator/sos-2x/processor/avr/include/crc.h **** /*									tab:4
   4:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * "Copyright (c) 2000-2003 The Regents of the University  of California.  
   5:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * All rights reserved.
   6:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  *
   7:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * Permission to use, copy, modify, and distribute this software and its
   8:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * documentation for any purpose, without fee, and without written agreement is
   9:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * hereby granted, provided that the above copyright notice, the following
  10:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * two paragraphs and the author appear in all copies of this software.
  11:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * 
  12:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * IN NO EVENT SHALL THE UNIVERSITY OF CALIFORNIA BE LIABLE TO ANY PARTY FOR
  13:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES ARISING OUT
  14:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN IF THE UNIVERSITY OF
  15:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * CALIFORNIA HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  16:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * 
  17:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * THE UNIVERSITY OF CALIFORNIA SPECIFICALLY DISCLAIMS ANY WARRANTIES,
  18:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY
  19:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * AND FITNESS FOR A PARTICULAR PURPOSE.  THE SOFTWARE PROVIDED HEREUNDER IS
  20:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * ON AN "AS IS" BASIS, AND THE UNIVERSITY OF CALIFORNIA HAS NO OBLIGATION TO
  21:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS."
  22:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  *
  23:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * Copyright (c) 2002-2003 Intel Corporation
  24:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * All rights reserved.
  25:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  *
  26:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * This file is distributed under the terms in the attached INTEL-LICENSE     
  27:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * file. If you do not find these files, copies can be found by writing to
  28:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * Intel Research Berkeley, 2150 Shattuck Avenue, Suite 1300, Berkeley, CA, 
  29:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  * 94704.  Attention:  Intel License Inquiry.
  30:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****  */
  31:/Users/Administrator/sos-2x/processor/avr/include/crc.h **** #ifndef _CRC_H
  32:/Users/Administrator/sos-2x/processor/avr/include/crc.h **** #define _CRC_H
  33:/Users/Administrator/sos-2x/processor/avr/include/crc.h **** 
  34:/Users/Administrator/sos-2x/processor/avr/include/crc.h **** extern uint16_t crcTable[256] PROGMEM;  //!< this is defined in crc.c
  35:/Users/Administrator/sos-2x/processor/avr/include/crc.h **** 
  36:/Users/Administrator/sos-2x/processor/avr/include/crc.h **** static inline uint16_t crcByte(uint16_t oldCrc, uint8_t byte)
  37:/Users/Administrator/sos-2x/processor/avr/include/crc.h **** {
 969               	.LM97:
 970 032c F601      		movw r30,r12
 971 032e 8081      		ld r24,Z
 972               	.LBB4:
  38:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****   uint8_t *magic = (uint8_t *)&crcTable[oldCrc >> 8 ^ byte];
 974               	.LM98:
 975 0330 E82F      		mov r30,r24
 976 0332 FF27      		clr r31
 977 0334 EE0F      		lsl r30
 978 0336 FF1F      		rol r31
 979 0338 E050      		subi r30,lo8(-(crcTable))
 980 033a F040      		sbci r31,hi8(-(crcTable))
 981               	.LBB5:
  39:/Users/Administrator/sos-2x/processor/avr/include/crc.h **** 
  40:/Users/Administrator/sos-2x/processor/avr/include/crc.h ****   return pgm_read_byte(magic) | ((uint8_t)oldCrc ^ pgm_read_byte(magic + 1)) << 8;
 983               	.LM99:
 984               	/* #APP */
 985 033c 8491      		lpm r24, Z
 986               		
 987               	/* #NOAPP */
 988               	.LBE5:
 989 033e E82E      		mov r14,r24
 990 0340 FF24      		clr r15
 991               	.LBB6:
 992 0342 3196      		adiw r30,1
 993               	/* #APP */
 994 0344 8491      		lpm r24, Z
 995               		
 996               	/* #NOAPP */
 997               	.LBE6:
 998 0346 9927      		clr r25
 999 0348 982F      		mov r25,r24
 1000 034a 8827      		clr r24
 1001 034c E82A      		or r14,r24
 1002 034e F92A      		or r15,r25
 1003 0350 BE01      		movw r22,r28
 1004 0352 D501      		movw r26,r10
 1005 0354 47E0      		ldi r20,lo8(7)
 1006               	.L69:
 1007               	.LBE4:
 1008               	.LBE3:
 1010               	.Ltext2:
 322:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				uint8_t i=0;
 323:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				uint16_t runningCRC=0, crc_in=0;
 324:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 325:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				// extract the protocol field
 326:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				for (i=0; i<HDLC_PROTOCOL_SIZE; i++) {
 327:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 					runningCRC = crcByte(runningCRC, bufPtr[i]);
 328:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				}
 329:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 330:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				// extract the header
 331:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				bufPtr = &buff[HDLC_PROTOCOL_SIZE];
 332:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				for (i=0; i<SOS_MSG_HEADER_SIZE; i++) {
 333:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 					((uint8_t*)msgPtr)[i] = bufPtr[i];
 1012               	.LM100:
 1013 0356 8C91      		ld r24,X
 1014 0358 FB01      		movw r30,r22
 1015 035a 8193      		st Z+,r24
 1016 035c BF01      		movw r22,r30
 1017               	.LBB7:
 1019               	.Ltext3:
 1021               	.LM101:
 1022 035e 8D91      		ld r24,X+
 1023               	.LBB8:
 1025               	.LM102:
 1026 0360 EF2D      		mov r30,r15
 1027 0362 FF27      		clr r31
 1028 0364 9927      		clr r25
 1029 0366 E827      		eor r30,r24
 1030 0368 F927      		eor r31,r25
 1031 036a EE0F      		add r30,r30
 1032 036c FF1F      		adc r31,r31
 1033 036e E050      		subi r30,lo8(-(crcTable))
 1034 0370 F040      		sbci r31,hi8(-(crcTable))
 1035               	.LBB9:
 1037               	.LM103:
 1038               	/* #APP */
 1039 0372 8491      		lpm r24, Z
 1040               		
 1041               	/* #NOAPP */
 1042               	.LBE9:
 1043 0374 282F      		mov r18,r24
 1044 0376 3327      		clr r19
 1045               	.LBB10:
 1046 0378 3196      		adiw r30,1
 1047               	/* #APP */
 1048 037a 8491      		lpm r24, Z
 1049               		
 1050               	/* #NOAPP */
 1051               	.LBE10:
 1052 037c 8E25      		eor r24,r14
 1053 037e 9927      		clr r25
 1054 0380 F82E      		mov r15,r24
 1055 0382 EE24      		clr r14
 1056 0384 E22A      		or r14,r18
 1057 0386 F32A      		or r15,r19
 1058               	.LBE8:
 1059               	.LBE7:
 1061               	.Ltext4:
 1063               	.LM104:
 1064 0388 4150      		subi r20,lo8(-(-1))
 1065 038a 47FF      		sbrs r20,7
 1066 038c E4CF      		rjmp .L69
 334:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 					runningCRC = crcByte(runningCRC, bufPtr[i]);
 335:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				}
 336:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 337:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				// extract the data if it exists
 338:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				if (msgPtr->len != 0) {
 1068               	.LM105:
 1069 038e 8F81      		ldd r24,Y+7
 1070 0390 8823      		tst r24
 1071 0392 99F1      		breq .L70
 1072               	.LBB11:
 1073               	.LBB12:
 1074               	.LBB13:
 1076               	.Ltext5:
   1:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /* -*- Mode: C; tab-width:4 -*- */
   2:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /* ex: set ts=4: */
   3:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /*
   4:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * Copyright (c) 2003 The Regents of the University of California.
   5:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * All rights reserved.
   6:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *
   7:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * Redistribution and use in source and binary forms, with or without
   8:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * modification, are permitted provided that the following conditions
   9:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * are met:
  10:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * 1. Redistributions of source code must retain the above copyright
  11:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *    notice, this list of conditions and the following disclaimer.
  12:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * 2. Redistributions in binary form must reproduce the above
  13:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *    copyright notice, this list of conditions and the following
  14:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *    disclaimer in the documentation and/or other materials provided
  15:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *    with the distribution.
  16:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * 3. All advertising materials mentioning features or use of this
  17:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *    software must display the following acknowledgement:
  18:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *       This product includes software developed by Networked &
  19:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *       Embedded Systems Lab at UCLA
  20:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * 4. Neither the name of the University nor that of the Laboratory
  21:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *    may be used to endorse or promote products derived from this
  22:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *    software without specific prior written permission.
  23:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *
  24:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS''
  25:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
  26:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
  27:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE REGENTS
  28:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
  29:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
  30:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
  31:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
  32:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
  33:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
  34:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
  35:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * SUCH DAMAGE.
  36:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *
  37:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief    Allocte and free dynamic memory 
  38:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @author   Roy Shea (roy@cs.ucla.edu) 
  39:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  40:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #ifndef _MALLOC_H_
  41:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #define _MALLOC_H_
  42:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  43:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #include <sos_types.h>
  44:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #include <pid.h>
  45:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #include <malloc_conf.h>
  46:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #include <sos_module_types.h>
  47:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #ifdef FAULT_TOLERANT_SOS
  48:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #include <malloc_domains.h>
  49:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #endif
  50:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  51:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  52:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Init function for memory manager
  53:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  54:/Users/Administrator/sos-2x/kernel/include/malloc.h **** extern void mem_init(void);
  55:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  56:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  57:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Starting memory module interface
  58:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  59:/Users/Administrator/sos-2x/kernel/include/malloc.h **** extern void mem_start(void);
  60:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  61:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  62:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Allocate a chunk of blocks from the heap
  63:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  64:/Users/Administrator/sos-2x/kernel/include/malloc.h **** extern void *sos_blk_mem_alloc(uint16_t size, sos_pid_t id, bool bCallFromModule);
  65:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  66:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  67:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Free a block back into the heap
  68:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  69:/Users/Administrator/sos-2x/kernel/include/malloc.h **** extern void sos_blk_mem_free(void* ptr, bool bCallFromModule);
  70:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  71:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  72:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Re-allocate a block of memory from the heap
  73:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  74:/Users/Administrator/sos-2x/kernel/include/malloc.h **** extern void *sos_blk_mem_realloc(void* pntr, uint16_t newSize, bool bCallFromModule);
  75:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  76:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  77:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Change memory ownership of a segment of memory
  78:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  79:/Users/Administrator/sos-2x/kernel/include/malloc.h **** extern int8_t sos_blk_mem_change_own(void* ptr, sos_pid_t id, bool bCallFromModule);
  80:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  81:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  82:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Allocate a block of memory for long term usage
  83:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  84:/Users/Administrator/sos-2x/kernel/include/malloc.h **** extern void *sos_blk_mem_longterm_alloc(uint16_t size, sos_pid_t id, bool bCallFromModule);
  85:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  86:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  87:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  88:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Allocate dynamic memory
  89:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @param size Number of bytes to allocate
  90:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @param id Node responsible for the memory
  91:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @return Returns a pointer to the allocated memory.
  92:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * Will return a NULL pointer if the call to sys_malloc fails.
  93:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  94:/Users/Administrator/sos-2x/kernel/include/malloc.h **** static inline void *ker_malloc(uint16_t size, sos_pid_t id)
  95:/Users/Administrator/sos-2x/kernel/include/malloc.h **** {
  96:/Users/Administrator/sos-2x/kernel/include/malloc.h ****   return sos_blk_mem_alloc(size, id, false);
 1078               	.LM106:
 1079 0394 40E0      		ldi r20,lo8(0)
 1080 0396 61E4      		ldi r22,lo8(65)
 1081 0398 9927      		clr r25
 1082 039a 0E94 0000 		call sos_blk_mem_alloc
 1083               	.LBE13:
 1084               	.LBE12:
 1086               	.Ltext6:
 339:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 					uint8_t *dataPtr;
 340:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 					dataPtr = ker_malloc(((Message*)msgPtr)->len, I2C_PID);
 341:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 342:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 					if (dataPtr != NULL) {
 1088               	.LM107:
 1089 039e 0097      		sbiw r24,0
 1090 03a0 09F4      		brne .+2
 1091 03a2 51C0      		rjmp .L96
 343:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 344:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 						msgPtr->data = dataPtr;
 1093               	.LM108:
 1094 03a4 8887      		std Y+8,r24
 1095 03a6 9987      		std Y+9,r25
 345:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 346:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 						bufPtr = &buff[HDLC_PROTOCOL_SIZE+SOS_MSG_HEADER_SIZE];
 1097               	.LM109:
 1098 03a8 8601      		movw r16,r12
 1099 03aa 075F      		subi r16,lo8(-(9))
 1100 03ac 1F4F      		sbci r17,hi8(-(9))
 347:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 						for (i=0; i<msgPtr->len; i++) {
 1102               	.LM110:
 1103 03ae 40E0      		ldi r20,lo8(0)
 1104               	.L95:
 1105 03b0 8F81      		ldd r24,Y+7
 1106 03b2 4817      		cp r20,r24
 1107 03b4 20F5      		brsh .L80
 348:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 							msgPtr->data[i] = bufPtr[i];
 1109               	.LM111:
 1110 03b6 842F      		mov r24,r20
 1111 03b8 9927      		clr r25
 1112 03ba E885      		ldd r30,Y+8
 1113 03bc F985      		ldd r31,Y+9
 1114 03be E80F      		add r30,r24
 1115 03c0 F91F      		adc r31,r25
 1116 03c2 D801      		movw r26,r16
 1117 03c4 A80F      		add r26,r24
 1118 03c6 B91F      		adc r27,r25
 1119 03c8 8C91      		ld r24,X
 1120 03ca 8083      		st Z,r24
 1121               	.LBB14:
 1123               	.Ltext7:
 1125               	.LM112:
 1126 03cc 8C91      		ld r24,X
 1127               	.LBB15:
 1129               	.LM113:
 1130 03ce EF2D      		mov r30,r15
 1131 03d0 FF27      		clr r31
 1132 03d2 9927      		clr r25
 1133 03d4 E827      		eor r30,r24
 1134 03d6 F927      		eor r31,r25
 1135 03d8 EE0F      		add r30,r30
 1136 03da FF1F      		adc r31,r31
 1137 03dc E050      		subi r30,lo8(-(crcTable))
 1138 03de F040      		sbci r31,hi8(-(crcTable))
 1139               	.LBB16:
 1141               	.LM114:
 1142               	/* #APP */
 1143 03e0 8491      		lpm r24, Z
 1144               		
 1145               	/* #NOAPP */
 1146               	.LBE16:
 1147 03e2 282F      		mov r18,r24
 1148 03e4 3327      		clr r19
 1149               	.LBB17:
 1150 03e6 3196      		adiw r30,1
 1151               	/* #APP */
 1152 03e8 8491      		lpm r24, Z
 1153               		
 1154               	/* #NOAPP */
 1155               	.LBE17:
 1156 03ea 8E25      		eor r24,r14
 1157 03ec 9927      		clr r25
 1158 03ee F82E      		mov r15,r24
 1159 03f0 EE24      		clr r14
 1160 03f2 E22A      		or r14,r18
 1161 03f4 F32A      		or r15,r19
 1162               	.LBE15:
 1163               	.LBE14:
 1165               	.Ltext8:
 1167               	.LM115:
 1168 03f6 4F5F      		subi r20,lo8(-(1))
 1169 03f8 DBCF      		rjmp .L95
 1170               	.L70:
 1171               	.LBE11:
 349:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 							runningCRC = crcByte(runningCRC, bufPtr[i]);
 350:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 						}
 351:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 					} else { // -ENOMEM
 352:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 						ker_free(msgPtr);
 353:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 						goto post_error_msg;
 354:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 					}
 355:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				} else {
 356:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 					msgPtr->data = NULL;
 1173               	.LM116:
 1174 03fa 1886      		std Y+8,__zero_reg__
 1175 03fc 1986      		std Y+9,__zero_reg__
 1176               	.L80:
 357:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				}
 358:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 359:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				// get the CRC and check it
 360:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				bufPtr = &buff[HDLC_PROTOCOL_SIZE+SOS_MSG_HEADER_SIZE+msgPtr->len];
 1178               	.LM117:
 1179 03fe 8F81      		ldd r24,Y+7
 1180 0400 F601      		movw r30,r12
 1181 0402 E80F      		add r30,r24
 1182 0404 F11D      		adc r31,__zero_reg__
 361:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				crc_in = bufPtr[0] | (bufPtr[1]<<8);
 1184               	.LM118:
 1185 0406 8185      		ldd r24,Z+9
 1186 0408 282F      		mov r18,r24
 1187 040a 3327      		clr r19
 1188 040c 8285      		ldd r24,Z+10
 1189 040e 9927      		clr r25
 1190 0410 982F      		mov r25,r24
 1191 0412 8827      		clr r24
 1192 0414 282B      		or r18,r24
 1193 0416 392B      		or r19,r25
 1194 0418 8885      		ldd r24,Y+8
 1195 041a 9985      		ldd r25,Y+9
 362:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 363:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				if (crc_in == runningCRC) {
 1197               	.LM119:
 1198 041c 2E15      		cp r18,r14
 1199 041e 3F05      		cpc r19,r15
 1200 0420 79F4      		brne .L81
 364:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 					// message passed all sanity checks including crc
 365:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 					LED_DBG(LED_YELLOW_TOGGLE);
 366:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 					if(msgPtr->data != NULL ) {
 1202               	.LM120:
 1203 0422 892B      		or r24,r25
 1204 0424 21F0      		breq .L82
 367:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 						msgPtr->flag = SOS_MSG_RELEASE;
 1206               	.LM121:
 1207 0426 84E0      		ldi r24,lo8(4)
 1208 0428 90E0      		ldi r25,hi8(4)
 1209 042a 8A87      		std Y+10,r24
 1210 042c 9B87      		std Y+11,r25
 1211               	.L82:
 1212               	.LBB18:
 1213               	.LBB19:
 1215               	.Ltext9:
   1:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** /* -*- Mode: C; tab-width:4 -*- */
   2:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** /* ex: set ts=4 shiftwidth=4 softtabstop=4 cindent: */
   3:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** /*
   4:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * Copyright (c) 2003 The Regents of the University of California.
   5:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * All rights reserved.
   6:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *
   7:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * Redistribution and use in source and binary forms, with or without
   8:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * modification, are permitted provided that the following conditions
   9:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * are met:
  10:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * 1. Redistributions of source code must retain the above copyright
  11:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *    notice, this list of conditions and the following disclaimer.
  12:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * 2. Redistributions in binary form must reproduce the above
  13:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *    copyright notice, this list of conditions and the following
  14:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *    disclaimer in the documentation and/or other materials provided
  15:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *    with the distribution.
  16:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * 3. All advertising materials mentioning features or use of this
  17:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *    software must display the following acknowledgement:
  18:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *       This product includes software developed by Networked &
  19:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *       Embedded Systems Lab at UCLA
  20:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * 4. Neither the name of the University nor that of the Laboratory
  21:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *    may be used to endorse or promote products derived from this
  22:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *    software without specific prior written permission.
  23:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *
  24:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS''
  25:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
  26:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
  27:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE REGENTS
  28:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
  29:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
  30:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
  31:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
  32:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
  33:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
  34:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
  35:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * SUCH DAMAGE.
  36:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *
  37:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  */
  38:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** /**
  39:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * @brief inline functions for message handling in the stack
  40:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * @author Simon Han (simonhan@ee.ucla.edu)
  41:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *
  42:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * In SOS, stack is part of operating system.
  43:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * Therefore, stack helps kernel to do message filtering.
  44:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * Note that this routine was originally done in post and call logic.
  45:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * But most of message filterings are meanful for messages from the 
  46:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * network.  
  47:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  */
  48:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** 
  49:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** 
  50:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** #ifndef _NET_STACK_H
  51:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** #define _NET_STACK_H
  52:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** 
  53:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** #include <message_queue.h>
  54:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** #include <sos_sched.h>
  55:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** #include <sos_info.h>
  56:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** 
  57:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** static inline void handle_incoming_msg(Message *msg, uint16_t channel_flag)
  58:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** {
  59:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****   //   DEBUG("<NET STACK> Received message from network\n");
  60:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****   msg->flag |= SOS_MSG_FROM_NETWORK | channel_flag;
 1217               	.LM122:
 1218 042e 8A85      		ldd r24,Y+10
 1219 0430 9B85      		ldd r25,Y+11
 1220 0432 9560      		ori r25,hi8(1280)
 1221 0434 8A87      		std Y+10,r24
 1222 0436 9B87      		std Y+11,r25
  61:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****   msg->daddr = entohs(msg->daddr);
  62:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****   msg->saddr = entohs(msg->saddr);
  63:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****   sched_msg_alloc(msg);
 1224               	.LM123:
 1225 0438 CE01      		movw r24,r28
 1226 043a 0E94 0000 		call sched_msg_alloc
 1227               	.LBE19:
 1228               	.LBE18:
 1230               	.Ltext10:
 368:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 					}
 369:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 					handle_incoming_msg(msgPtr, SOS_MSG_I2C_IO);
 370:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 					return;
 1232               	.LM124:
 1233 043e 13C0      		rjmp .L48
 1234               	.L81:
 1235               	.LBB20:
 1236               	.LBB21:
 1238               	.Ltext11:
  97:/Users/Administrator/sos-2x/kernel/include/malloc.h **** }
  98:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  99:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
 100:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Reallocate dynamic memory
 101:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @param pntr Pointer to the currently held block of memory
 102:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @param newSize Number of bytes to be allocated
 103:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @return Returns the pointer to the reallocated memory.
 104:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * Returns a NULL if unable to reallocate but the original pointer is still valid.
 105:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
 106:/Users/Administrator/sos-2x/kernel/include/malloc.h **** static inline void* ker_realloc(void* pntr, uint16_t newSize)
 107:/Users/Administrator/sos-2x/kernel/include/malloc.h **** {
 108:/Users/Administrator/sos-2x/kernel/include/malloc.h ****   return sos_blk_mem_realloc(pntr, newSize, false);
 109:/Users/Administrator/sos-2x/kernel/include/malloc.h **** }
 110:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
 111:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
 112:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Free memory pointed to by ptr
 113:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @param ptr Pointer to the memory that should be released
 114:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @return void
 115:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
 116:/Users/Administrator/sos-2x/kernel/include/malloc.h **** static inline void ker_free(void* ptr)
 117:/Users/Administrator/sos-2x/kernel/include/malloc.h **** {
 118:/Users/Administrator/sos-2x/kernel/include/malloc.h ****   sos_blk_mem_free(ptr, false);
 1240               	.LM125:
 1241 0440 60E0      		ldi r22,lo8(0)
 1242 0442 0E94 0000 		call sos_blk_mem_free
 1243               	.L96:
 1244               	.LBE21:
 1245               	.LBE20:
 1246               	.LBB22:
 1247               	.LBB23:
 1248 0446 60E0      		ldi r22,lo8(0)
 1249 0448 CE01      		movw r24,r28
 1250 044a 0E94 0000 		call sos_blk_mem_free
 1251               	.L51:
 1252               	.LBE23:
 1253               	.LBE22:
 1254               	.LBE2:
 1256               	.Ltext12:
 371:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				} else { // clean up
 372:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 					ker_free(msgPtr->data);
 373:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 					ker_free(msgPtr);
 374:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 				}
 375:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 			}
 376:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 		}
 377:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	}
 378:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 
 379:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	// if we make it to here return error message
 380:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** post_error_msg:
 381:/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c **** 	post_short(
 1258               	.LM126:
 1259 044e 40E4      		ldi r20,lo8(64)
 1260 0450 E42E      		mov r14,r20
 1261 0452 F12C      		mov r15,__zero_reg__
 1262 0454 00E0      		ldi r16,lo8(0)
 1263 0456 10E0      		ldi r17,hi8(0)
 1264 0458 20E0      		ldi r18,lo8(0)
 1265 045a 4FE0      		ldi r20,lo8(15)
 1266 045c 61E4      		ldi r22,lo8(65)
 1267 045e 8091 0000 		lds r24,i2c_sys
 1268 0462 0E94 0000 		call post_short
 1269               	.L48:
 1270               	/* epilogue: frame size=0 */
 1271 0466 DF91      		pop r29
 1272 0468 CF91      		pop r28
 1273 046a 1F91      		pop r17
 1274 046c 0F91      		pop r16
 1275 046e FF90      		pop r15
 1276 0470 EF90      		pop r14
 1277 0472 DF90      		pop r13
 1278 0474 CF90      		pop r12
 1279 0476 BF90      		pop r11
 1280 0478 AF90      		pop r10
 1281 047a 0895      		ret
 1282               	/* epilogue end (size=11) */
 1283               	/* function i2c_read_done size 277 (256) */
 1317               	.Lscope6:
 1319               		.lcomm i2c_sys,10
 1321               		.text
 1323               	Letext:
 1324               	/* File "/Users/Administrator/sos-2x/drivers/i2c/i2c_system.c": code  592 = 0x0250 ( 557), prologue
DEFINED SYMBOLS
                            *ABS*:00000000 i2c_system.c
                            *ABS*:0000003f __SREG__
                            *ABS*:0000003e __SP_H__
                            *ABS*:0000003d __SP_L__
                            *ABS*:00000000 __tmp_reg__
                            *ABS*:00000001 __zero_reg__
/var/tmp//ccEX8lm3.s:309    .text:00000000 i2c_system_init
                             .bss:00000000 i2c_sys
/var/tmp//ccEX8lm3.s:370    .text:00000042 ker_i2c_reserve_bus
/var/tmp//ccEX8lm3.s:456    .text:0000009e ker_i2c_release_bus
/var/tmp//ccEX8lm3.s:527    .text:000000e4 ker_i2c_send_data
/var/tmp//ccEX8lm3.s:652    .text:00000184 ker_i2c_read_data
/var/tmp//ccEX8lm3.s:743    .text:000001ea i2c_send_done
/var/tmp//ccEX8lm3.s:848    .text:00000276 i2c_read_done
/var/tmp//ccEX8lm3.s:1323   .text:0000047c Letext

UNDEFINED SYMBOLS
__do_copy_data
__do_clear_bss
i2c_hardware_init
i2c_initTransceiver
i2c_startTransceiverTx
i2c_startTransceiverRx
post_short
post_long
msg_create
crcTable
sos_blk_mem_alloc
sched_msg_alloc
sos_blk_mem_free
