   1               		.file	"timestamp.c"
   2               		.arch atmega128
   3               	__SREG__ = 0x3f
   4               	__SP_H__ = 0x3e
   5               	__SP_L__ = 0x3d
   6               	__tmp_reg__ = 0
   7               	__zero_reg__ = 1
   8               		.global __do_copy_data
   9               		.global __do_clear_bss
  12               		.text
  13               	.Ltext0:
 292               		.lcomm ts_owner,2
 297               	timestamp_do_timestamp:
   1:/Users/Administrator/sos-2x/kernel/timestamp.c **** /* -*- Mode: C; tab-width:4 -*- */
   2:/Users/Administrator/sos-2x/kernel/timestamp.c **** /* ex: set ts=4 shiftwidth=4 softtabstop=4 cindent: */
   3:/Users/Administrator/sos-2x/kernel/timestamp.c **** 
   4:/Users/Administrator/sos-2x/kernel/timestamp.c **** /**
   5:/Users/Administrator/sos-2x/kernel/timestamp.c ****  * @brief Packet time stamping service 
   6:/Users/Administrator/sos-2x/kernel/timestamp.c ****  * @author Simon Han
   7:/Users/Administrator/sos-2x/kernel/timestamp.c ****  */
   8:/Users/Administrator/sos-2x/kernel/timestamp.c **** #include <sos_types.h>
   9:/Users/Administrator/sos-2x/kernel/timestamp.c **** #include <stddef.h>
  10:/Users/Administrator/sos-2x/kernel/timestamp.c **** #include <malloc.h>
  11:/Users/Administrator/sos-2x/kernel/timestamp.c **** #include <message_types.h>
  12:/Users/Administrator/sos-2x/kernel/timestamp.c **** #include <hardware.h>
  13:/Users/Administrator/sos-2x/kernel/timestamp.c **** 
  14:/Users/Administrator/sos-2x/kernel/timestamp.c **** /**
  15:/Users/Administrator/sos-2x/kernel/timestamp.c ****  * timestamp record
  16:/Users/Administrator/sos-2x/kernel/timestamp.c ****  */
  17:/Users/Administrator/sos-2x/kernel/timestamp.c **** typedef struct {
  18:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	void *ptr;
  19:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	uint32_t ts;
  20:/Users/Administrator/sos-2x/kernel/timestamp.c **** } ts_rec_t;
  21:/Users/Administrator/sos-2x/kernel/timestamp.c **** 
  22:/Users/Administrator/sos-2x/kernel/timestamp.c **** /**
  23:/Users/Administrator/sos-2x/kernel/timestamp.c ****  * timestamp service record
  24:/Users/Administrator/sos-2x/kernel/timestamp.c ****  */
  25:/Users/Administrator/sos-2x/kernel/timestamp.c **** typedef struct ts_svc{
  26:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	sos_pid_t pid;  //! module id
  27:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	uint8_t num_rec;
  28:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	uint8_t next_rec;
  29:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	ts_rec_t rec[];	
  30:/Users/Administrator/sos-2x/kernel/timestamp.c **** } ts_svc_t;
  31:/Users/Administrator/sos-2x/kernel/timestamp.c **** 
  32:/Users/Administrator/sos-2x/kernel/timestamp.c **** static ts_svc_t *ts_owner = NULL;
  33:/Users/Administrator/sos-2x/kernel/timestamp.c **** 
  34:/Users/Administrator/sos-2x/kernel/timestamp.c **** static void timestamp_do_timestamp(void* ptr, uint32_t t)
  35:/Users/Administrator/sos-2x/kernel/timestamp.c **** {
 299               	.LM1:
 300               	/* prologue: frame size=0 */
 301               	/* prologue end (size=0) */
  36:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	ts_owner->rec[ts_owner->next_rec].ptr = ptr;
 303               	.LM2:
 304 0000 A091 0000 		lds r26,ts_owner
 305 0004 B091 0000 		lds r27,(ts_owner)+1
 306 0008 FD01      		movw r30,r26
 307 000a 2281      		ldd r18,Z+2
 308 000c 3327      		clr r19
 309 000e F901      		movw r30,r18
 310 0010 EE0F      		lsl r30
 311 0012 FF1F      		rol r31
 312 0014 EE0F      		lsl r30
 313 0016 FF1F      		rol r31
 314 0018 E20F      		add r30,r18
 315 001a F31F      		adc r31,r19
 316 001c E20F      		add r30,r18
 317 001e F31F      		adc r31,r19
 318 0020 EA0F      		add r30,r26
 319 0022 FB1F      		adc r31,r27
 320 0024 8383      		std Z+3,r24
 321 0026 9483      		std Z+4,r25
  37:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	ts_owner->rec[ts_owner->next_rec].ts = t;
 323               	.LM3:
 324 0028 FD01      		movw r30,r26
 325 002a 8281      		ldd r24,Z+2
 326 002c 9927      		clr r25
 327 002e FC01      		movw r30,r24
 328 0030 EE0F      		lsl r30
 329 0032 FF1F      		rol r31
 330 0034 EE0F      		lsl r30
 331 0036 FF1F      		rol r31
 332 0038 E80F      		add r30,r24
 333 003a F91F      		adc r31,r25
 334 003c E80F      		add r30,r24
 335 003e F91F      		adc r31,r25
 336 0040 EA0F      		add r30,r26
 337 0042 FB1F      		adc r31,r27
 338 0044 4583      		std Z+5,r20
 339 0046 5683      		std Z+6,r21
 340 0048 6783      		std Z+7,r22
 341 004a 7087      		std Z+8,r23
  38:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	ts_owner->next_rec += 1;
 343               	.LM4:
 344 004c FD01      		movw r30,r26
 345 004e 8281      		ldd r24,Z+2
 346 0050 8F5F      		subi r24,lo8(-(1))
 347 0052 8283      		std Z+2,r24
  39:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	if(ts_owner->next_rec == ts_owner->num_rec) {
 349               	.LM5:
 350 0054 E091 0000 		lds r30,ts_owner
 351 0058 F091 0000 		lds r31,(ts_owner)+1
 352 005c 9281      		ldd r25,Z+2
 353 005e 8181      		ldd r24,Z+1
 354 0060 9817      		cp r25,r24
 355 0062 09F4      		brne .L1
  40:/Users/Administrator/sos-2x/kernel/timestamp.c **** 		ts_owner->next_rec = 0;
 357               	.LM6:
 358 0064 1282      		std Z+2,__zero_reg__
 359               	.L1:
 360 0066 0895      		ret
 361               	/* epilogue: frame size=0 */
 362 0068 0895      		ret
 363               	/* epilogue end (size=1) */
 364               	/* function timestamp_do_timestamp size 53 (52) */
 366               	.Lscope0:
 371               	.global	timestamp_incoming
 373               	timestamp_incoming:
  41:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	}
  42:/Users/Administrator/sos-2x/kernel/timestamp.c **** }
  43:/Users/Administrator/sos-2x/kernel/timestamp.c **** 
  44:/Users/Administrator/sos-2x/kernel/timestamp.c **** void timestamp_incoming(Message *msg_in, uint32_t t)
  45:/Users/Administrator/sos-2x/kernel/timestamp.c **** {
 375               	.LM7:
 376               	/* prologue: frame size=0 */
 377               	/* prologue end (size=0) */
 378 006a DC01      		movw r26,r24
  46:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	if(ts_owner && (ts_owner->pid == msg_in->did)) {
 380               	.LM8:
 381 006c E091 0000 		lds r30,ts_owner
 382 0070 F091 0000 		lds r31,(ts_owner)+1
 383 0074 3097      		sbiw r30,0
 384 0076 49F0      		breq .L3
 386               	.LM9:
 387 0078 9081      		ld r25,Z
 388 007a 8C91      		ld r24,X
 389 007c 9817      		cp r25,r24
 390 007e 29F4      		brne .L3
  47:/Users/Administrator/sos-2x/kernel/timestamp.c **** 		timestamp_do_timestamp(msg_in->data, t);
 392               	.LM10:
 393 0080 FD01      		movw r30,r26
 394 0082 8085      		ldd r24,Z+8
 395 0084 9185      		ldd r25,Z+9
 396 0086 0E94 0000 		call timestamp_do_timestamp
 397               	.L3:
 398 008a 0895      		ret
 399               	/* epilogue: frame size=0 */
 400 008c 0895      		ret
 401               	/* epilogue end (size=1) */
 402               	/* function timestamp_incoming size 18 (17) */
 404               	.Lscope1:
 409               	.global	timestamp_outgoing
 411               	timestamp_outgoing:
  48:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	}
  49:/Users/Administrator/sos-2x/kernel/timestamp.c **** }
  50:/Users/Administrator/sos-2x/kernel/timestamp.c **** 
  51:/Users/Administrator/sos-2x/kernel/timestamp.c **** void timestamp_outgoing(Message *msg_out, uint32_t t)
  52:/Users/Administrator/sos-2x/kernel/timestamp.c **** {
 413               	.LM11:
 414               	/* prologue: frame size=0 */
 415               	/* prologue end (size=0) */
 416 008e DC01      		movw r26,r24
  53:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	if(ts_owner && (ts_owner->pid == msg_out->sid)) {
 418               	.LM12:
 419 0090 E091 0000 		lds r30,ts_owner
 420 0094 F091 0000 		lds r31,(ts_owner)+1
 421 0098 3097      		sbiw r30,0
 422 009a 49F0      		breq .L5
 424               	.LM13:
 425 009c 9081      		ld r25,Z
 426 009e FD01      		movw r30,r26
 427 00a0 8181      		ldd r24,Z+1
 428 00a2 9817      		cp r25,r24
 429 00a4 21F4      		brne .L5
  54:/Users/Administrator/sos-2x/kernel/timestamp.c **** 		timestamp_do_timestamp(msg_out->data, t);
 431               	.LM14:
 432 00a6 8085      		ldd r24,Z+8
 433 00a8 9185      		ldd r25,Z+9
 434 00aa 0E94 0000 		call timestamp_do_timestamp
 435               	.L5:
 436 00ae 0895      		ret
 437               	/* epilogue: frame size=0 */
 438 00b0 0895      		ret
 439               	/* epilogue end (size=1) */
 440               	/* function timestamp_outgoing size 18 (17) */
 442               	.Lscope2:
 447               	.global	ker_timestamp_register
 449               	ker_timestamp_register:
  55:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	}
  56:/Users/Administrator/sos-2x/kernel/timestamp.c **** }
  57:/Users/Administrator/sos-2x/kernel/timestamp.c **** 
  58:/Users/Administrator/sos-2x/kernel/timestamp.c **** int8_t ker_timestamp_register(sos_pid_t pid, uint8_t n)
  59:/Users/Administrator/sos-2x/kernel/timestamp.c **** {
 451               	.LM15:
 452               	/* prologue: frame size=0 */
 453 00b2 EF92      		push r14
 454 00b4 FF92      		push r15
 455 00b6 0F93      		push r16
 456 00b8 1F93      		push r17
 457 00ba CF93      		push r28
 458               	/* prologue end (size=5) */
 459 00bc 082F      		mov r16,r24
 460 00be 162F      		mov r17,r22
  60:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	uint8_t i;
  61:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	if(ts_owner != NULL) {
 462               	.LM16:
 463 00c0 E090 0000 		lds r14,ts_owner
 464 00c4 F090 0000 		lds r15,(ts_owner)+1
 465 00c8 E114      		cp r14,__zero_reg__
 466 00ca F104      		cpc r15,__zero_reg__
 467 00cc 19F0      		breq .L8
  62:/Users/Administrator/sos-2x/kernel/timestamp.c **** 		return -EBUSY;
 469               	.LM17:
 470 00ce 80EF      		ldi r24,lo8(-16)
 471 00d0 9FEF      		ldi r25,hi8(-16)
 472 00d2 46C0      		rjmp .L7
 473               	.L8:
  63:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	}
  64:/Users/Administrator/sos-2x/kernel/timestamp.c **** #ifndef NO_RADIO
  65:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	if(radio_set_timestamp(true) != SOS_OK) {
 475               	.LM18:
 476 00d4 81E0      		ldi r24,lo8(1)
 477 00d6 0E94 0000 		call radio_set_timestamp
 478 00da C82F      		mov r28,r24
 479 00dc 8823      		tst r24
 480 00de 19F0      		breq .L9
  66:/Users/Administrator/sos-2x/kernel/timestamp.c **** 		return -ENXIO;
 482               	.LM19:
 483 00e0 8AEF      		ldi r24,lo8(-6)
 484 00e2 9FEF      		ldi r25,hi8(-6)
 485 00e4 3DC0      		rjmp .L7
 486               	.L9:
 487               	.LBB2:
 489               	.Ltext1:
   1:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /* -*- Mode: C; tab-width:4 -*- */
   2:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /* ex: set ts=4: */
   3:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /*
   4:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * Copyright (c) 2003 The Regents of the University of California.
   5:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * All rights reserved.
   6:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *
   7:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * Redistribution and use in source and binary forms, with or without
   8:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * modification, are permitted provided that the following conditions
   9:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * are met:
  10:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * 1. Redistributions of source code must retain the above copyright
  11:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *    notice, this list of conditions and the following disclaimer.
  12:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * 2. Redistributions in binary form must reproduce the above
  13:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *    copyright notice, this list of conditions and the following
  14:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *    disclaimer in the documentation and/or other materials provided
  15:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *    with the distribution.
  16:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * 3. All advertising materials mentioning features or use of this
  17:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *    software must display the following acknowledgement:
  18:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *       This product includes software developed by Networked &
  19:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *       Embedded Systems Lab at UCLA
  20:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * 4. Neither the name of the University nor that of the Laboratory
  21:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *    may be used to endorse or promote products derived from this
  22:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *    software without specific prior written permission.
  23:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *
  24:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS''
  25:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
  26:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
  27:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE REGENTS
  28:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
  29:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
  30:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
  31:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
  32:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
  33:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
  34:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
  35:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * SUCH DAMAGE.
  36:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *
  37:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief    Allocte and free dynamic memory 
  38:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @author   Roy Shea (roy@cs.ucla.edu) 
  39:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  40:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #ifndef _MALLOC_H_
  41:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #define _MALLOC_H_
  42:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  43:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #include <sos_types.h>
  44:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #include <pid.h>
  45:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #include <malloc_conf.h>
  46:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #include <sos_module_types.h>
  47:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #ifdef FAULT_TOLERANT_SOS
  48:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #include <malloc_domains.h>
  49:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #endif
  50:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  51:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  52:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Init function for memory manager
  53:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  54:/Users/Administrator/sos-2x/kernel/include/malloc.h **** extern void mem_init(void);
  55:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  56:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  57:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Starting memory module interface
  58:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  59:/Users/Administrator/sos-2x/kernel/include/malloc.h **** extern void mem_start(void);
  60:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  61:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  62:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Allocate a chunk of blocks from the heap
  63:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  64:/Users/Administrator/sos-2x/kernel/include/malloc.h **** extern void *sos_blk_mem_alloc(uint16_t size, sos_pid_t id, bool bCallFromModule);
  65:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  66:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  67:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Free a block back into the heap
  68:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  69:/Users/Administrator/sos-2x/kernel/include/malloc.h **** extern void sos_blk_mem_free(void* ptr, bool bCallFromModule);
  70:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  71:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  72:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Re-allocate a block of memory from the heap
  73:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  74:/Users/Administrator/sos-2x/kernel/include/malloc.h **** extern void *sos_blk_mem_realloc(void* pntr, uint16_t newSize, bool bCallFromModule);
  75:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  76:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  77:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Change memory ownership of a segment of memory
  78:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  79:/Users/Administrator/sos-2x/kernel/include/malloc.h **** extern int8_t sos_blk_mem_change_own(void* ptr, sos_pid_t id, bool bCallFromModule);
  80:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  81:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  82:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Allocate a block of memory for long term usage
  83:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  84:/Users/Administrator/sos-2x/kernel/include/malloc.h **** extern void *sos_blk_mem_longterm_alloc(uint16_t size, sos_pid_t id, bool bCallFromModule);
  85:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  86:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  87:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  88:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Allocate dynamic memory
  89:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @param size Number of bytes to allocate
  90:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @param id Node responsible for the memory
  91:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @return Returns a pointer to the allocated memory.
  92:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * Will return a NULL pointer if the call to sys_malloc fails.
  93:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  94:/Users/Administrator/sos-2x/kernel/include/malloc.h **** static inline void *ker_malloc(uint16_t size, sos_pid_t id)
  95:/Users/Administrator/sos-2x/kernel/include/malloc.h **** {
 491               	.LM20:
 492 00e6 86E0      		ldi r24,lo8(6)
 493 00e8 189F      		mul r17,r24
 494 00ea C001      		movw r24,r0
 495 00ec 1124      		clr r1
 496               	.LBB3:
  96:/Users/Administrator/sos-2x/kernel/include/malloc.h ****   return sos_blk_mem_alloc(size, id, false);
 498               	.LM21:
 499 00ee 4C2F      		mov r20,r28
 500 00f0 6EE0      		ldi r22,lo8(14)
 501 00f2 0396      		adiw r24,3
 502 00f4 0E94 0000 		call sos_blk_mem_alloc
 503 00f8 FC01      		movw r30,r24
 504               	.LBE3:
 505               	.LBE2:
 507               	.LM22:
 508 00fa 9093 0000 		sts (ts_owner)+1,r25
 509 00fe 8093 0000 		sts ts_owner,r24
 511               	.Ltext2:
  67:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	}
  68:/Users/Administrator/sos-2x/kernel/timestamp.c **** #endif
  69:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	ts_owner = (ts_svc_t*)ker_malloc(offsetof(struct ts_svc, rec) + n * sizeof(ts_rec_t), KER_TS_PID);
  70:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	if(ts_owner == NULL){ 
 513               	.LM23:
 514 0102 892B      		or r24,r25
 515 0104 31F4      		brne .L11
  71:/Users/Administrator/sos-2x/kernel/timestamp.c **** #ifndef NO_RADIO
  72:/Users/Administrator/sos-2x/kernel/timestamp.c **** 		radio_set_timestamp(false);
 517               	.LM24:
 518 0106 8C2F      		mov r24,r28
 519 0108 0E94 0000 		call radio_set_timestamp
  73:/Users/Administrator/sos-2x/kernel/timestamp.c **** #endif
  74:/Users/Administrator/sos-2x/kernel/timestamp.c **** 		return -ENOMEM;
 521               	.LM25:
 522 010c 84EF      		ldi r24,lo8(-12)
 523 010e 9FEF      		ldi r25,hi8(-12)
 524 0110 27C0      		rjmp .L7
 525               	.L11:
  75:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	}
  76:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	ts_owner->pid = pid;
 527               	.LM26:
 528 0112 0083      		st Z,r16
  77:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	ts_owner->num_rec = n;
 530               	.LM27:
 531 0114 E091 0000 		lds r30,ts_owner
 532 0118 F091 0000 		lds r31,(ts_owner)+1
 533 011c 1183      		std Z+1,r17
  78:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	ts_owner->next_rec = 0;
 535               	.LM28:
 536 011e E091 0000 		lds r30,ts_owner
 537 0122 F091 0000 		lds r31,(ts_owner)+1
 538 0126 C283      		std Z+2,r28
  79:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	for(i = 0; i < n; i++) {
 540               	.LM29:
 541 0128 C117      		cp r28,r17
 542 012a C0F4      		brsh .L17
 543 012c 4091 0000 		lds r20,ts_owner
 544 0130 5091 0000 		lds r21,(ts_owner)+1
 545 0134 C701      		movw r24,r14
 546 0136 9701      		movw r18,r14
 547 0138 612F      		mov r22,r17
 548               	.L15:
  80:/Users/Administrator/sos-2x/kernel/timestamp.c **** 		(ts_owner->rec[i]).ptr = NULL;
 550               	.LM30:
 551 013a FC01      		movw r30,r24
 552 013c E20F      		add r30,r18
 553 013e F31F      		adc r31,r19
 554 0140 E40F      		add r30,r20
 555 0142 F51F      		adc r31,r21
 556 0144 1382      		std Z+3,__zero_reg__
 557 0146 1482      		std Z+4,__zero_reg__
  81:/Users/Administrator/sos-2x/kernel/timestamp.c **** 		(ts_owner->rec[i]).ts = 0;
 559               	.LM31:
 560 0148 1582      		std Z+5,__zero_reg__
 561 014a 1682      		std Z+6,__zero_reg__
 562 014c 1782      		std Z+7,__zero_reg__
 563 014e 1086      		std Z+8,__zero_reg__
 565               	.LM32:
 566 0150 6150      		subi r22,lo8(-(-1))
 567 0152 2F5F      		subi r18,lo8(-(1))
 568 0154 3F4F      		sbci r19,hi8(-(1))
 569 0156 0596      		adiw r24,5
 570 0158 6623      		tst r22
 571 015a 79F7      		brne .L15
 572               	.L17:
  82:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	}
  83:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	return SOS_OK;
 574               	.LM33:
 575 015c 80E0      		ldi r24,lo8(0)
 576 015e 90E0      		ldi r25,hi8(0)
 577               	.L7:
 578               	/* epilogue: frame size=0 */
 579 0160 CF91      		pop r28
 580 0162 1F91      		pop r17
 581 0164 0F91      		pop r16
 582 0166 FF90      		pop r15
 583 0168 EF90      		pop r14
 584 016a 0895      		ret
 585               	/* epilogue end (size=6) */
 586               	/* function ker_timestamp_register size 93 (82) */
 591               	.Lscope3:
 595               	.global	ker_timestamp_deregister
 597               	ker_timestamp_deregister:
  84:/Users/Administrator/sos-2x/kernel/timestamp.c **** }
  85:/Users/Administrator/sos-2x/kernel/timestamp.c **** 
  86:/Users/Administrator/sos-2x/kernel/timestamp.c **** 
  87:/Users/Administrator/sos-2x/kernel/timestamp.c **** int8_t ker_timestamp_deregister(sos_pid_t pid)
  88:/Users/Administrator/sos-2x/kernel/timestamp.c **** {
 599               	.LM34:
 600               	/* prologue: frame size=0 */
 601               	/* prologue end (size=0) */
 602 016c 982F      		mov r25,r24
  89:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	if(ts_owner && ts_owner->pid == pid) {
 604               	.LM35:
 605 016e E091 0000 		lds r30,ts_owner
 606 0172 F091 0000 		lds r31,(ts_owner)+1
 607 0176 3097      		sbiw r30,0
 608 0178 89F0      		breq .L19
 610               	.LM36:
 611 017a 8081      		ld r24,Z
 612 017c 8917      		cp r24,r25
 613 017e 71F4      		brne .L19
 614               	.LBB4:
 615               	.LBB5:
 617               	.Ltext3:
  97:/Users/Administrator/sos-2x/kernel/include/malloc.h **** }
  98:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  99:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
 100:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Reallocate dynamic memory
 101:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @param pntr Pointer to the currently held block of memory
 102:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @param newSize Number of bytes to be allocated
 103:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @return Returns the pointer to the reallocated memory.
 104:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * Returns a NULL if unable to reallocate but the original pointer is still valid.
 105:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
 106:/Users/Administrator/sos-2x/kernel/include/malloc.h **** static inline void* ker_realloc(void* pntr, uint16_t newSize)
 107:/Users/Administrator/sos-2x/kernel/include/malloc.h **** {
 108:/Users/Administrator/sos-2x/kernel/include/malloc.h ****   return sos_blk_mem_realloc(pntr, newSize, false);
 109:/Users/Administrator/sos-2x/kernel/include/malloc.h **** }
 110:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
 111:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
 112:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Free memory pointed to by ptr
 113:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @param ptr Pointer to the memory that should be released
 114:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @return void
 115:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
 116:/Users/Administrator/sos-2x/kernel/include/malloc.h **** static inline void ker_free(void* ptr)
 117:/Users/Administrator/sos-2x/kernel/include/malloc.h **** {
 118:/Users/Administrator/sos-2x/kernel/include/malloc.h ****   sos_blk_mem_free(ptr, false);
 619               	.LM37:
 620 0180 60E0      		ldi r22,lo8(0)
 621 0182 CF01      		movw r24,r30
 622 0184 0E94 0000 		call sos_blk_mem_free
 623               	.LBE5:
 624               	.LBE4:
 626               	.Ltext4:
  90:/Users/Administrator/sos-2x/kernel/timestamp.c **** 		ker_free(ts_owner);
  91:/Users/Administrator/sos-2x/kernel/timestamp.c **** 		ts_owner = NULL;
 628               	.LM38:
 629 0188 1092 0000 		sts (ts_owner)+1,__zero_reg__
 630 018c 1092 0000 		sts ts_owner,__zero_reg__
  92:/Users/Administrator/sos-2x/kernel/timestamp.c **** #ifndef NO_RADIO
  93:/Users/Administrator/sos-2x/kernel/timestamp.c **** 		radio_set_timestamp(false);
 632               	.LM39:
 633 0190 80E0      		ldi r24,lo8(0)
 634 0192 0E94 0000 		call radio_set_timestamp
  94:/Users/Administrator/sos-2x/kernel/timestamp.c **** #endif
  95:/Users/Administrator/sos-2x/kernel/timestamp.c **** 		return SOS_OK;
 636               	.LM40:
 637 0196 80E0      		ldi r24,lo8(0)
 638 0198 90E0      		ldi r25,hi8(0)
 639 019a 0895      		ret
 640               	.L19:
  96:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	} else {
  97:/Users/Administrator/sos-2x/kernel/timestamp.c **** 		return -ESRCH; 
 642               	.LM41:
 643 019c 8DEF      		ldi r24,lo8(-3)
 644 019e 9FEF      		ldi r25,hi8(-3)
  98:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	}
  99:/Users/Administrator/sos-2x/kernel/timestamp.c **** }
 646               	.LM42:
 647 01a0 0895      		ret
 648               	/* epilogue: frame size=0 */
 649 01a2 0895      		ret
 650               	/* epilogue end (size=1) */
 651               	/* function ker_timestamp_deregister size 28 (27) */
 653               	.Lscope4:
 658               	.global	ker_timestamp_query
 660               	ker_timestamp_query:
 100:/Users/Administrator/sos-2x/kernel/timestamp.c **** 
 101:/Users/Administrator/sos-2x/kernel/timestamp.c **** uint32_t ker_timestamp_query(sos_pid_t pid, void *data)
 102:/Users/Administrator/sos-2x/kernel/timestamp.c **** {
 662               	.LM43:
 663               	/* prologue: frame size=0 */
 664 01a4 FF92      		push r15
 665 01a6 0F93      		push r16
 666 01a8 1F93      		push r17
 667 01aa CF93      		push r28
 668               	/* prologue end (size=4) */
 669 01ac 8B01      		movw r16,r22
 103:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	uint8_t i;
 104:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	if(ts_owner->pid != pid) return 0;
 671               	.LM44:
 672 01ae E091 0000 		lds r30,ts_owner
 673 01b2 F091 0000 		lds r31,(ts_owner)+1
 674 01b6 9081      		ld r25,Z
 675 01b8 9817      		cp r25,r24
 676 01ba 41F0      		breq .L23
 677 01bc 2AC0      		rjmp .L30
 678               	.L31:
 679               	.LBB6:
 105:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	for(i = 0; i < ts_owner->num_rec; i++) {
 106:/Users/Administrator/sos-2x/kernel/timestamp.c **** 		if((ts_owner->rec[i].ptr == data) && (ts_owner->rec[i].ts != 0)) {
 107:/Users/Administrator/sos-2x/kernel/timestamp.c **** 			uint32_t ret = ts_owner->rec[i].ts;
 108:/Users/Administrator/sos-2x/kernel/timestamp.c **** 			ts_owner->rec[i].ptr = NULL;
 681               	.LM45:
 682 01be 1382      		std Z+3,__zero_reg__
 683 01c0 1482      		std Z+4,__zero_reg__
 109:/Users/Administrator/sos-2x/kernel/timestamp.c **** 			ts_owner->rec[i].ts = 0;
 685               	.LM46:
 686 01c2 1582      		std Z+5,__zero_reg__
 687 01c4 1682      		std Z+6,__zero_reg__
 688 01c6 1782      		std Z+7,__zero_reg__
 689 01c8 1086      		std Z+8,__zero_reg__
 110:/Users/Administrator/sos-2x/kernel/timestamp.c **** 			return ret;
 691               	.LM47:
 692 01ca 27C0      		rjmp .L22
 693               	.L23:
 694               	.LBE6:
 696               	.LM48:
 697 01cc C0E0      		ldi r28,lo8(0)
 698 01ce 8181      		ldd r24,Z+1
 699 01d0 C817      		cp r28,r24
 700 01d2 F8F4      		brsh .L30
 701 01d4 DF01      		movw r26,r30
 702 01d6 F82E      		mov r15,r24
 703 01d8 20E0      		ldi r18,lo8(0)
 704 01da 30E0      		ldi r19,hi8(0)
 705 01dc A901      		movw r20,r18
 706               	.L28:
 708               	.LM49:
 709 01de F901      		movw r30,r18
 710 01e0 E40F      		add r30,r20
 711 01e2 F51F      		adc r31,r21
 712 01e4 EA0F      		add r30,r26
 713 01e6 FB1F      		adc r31,r27
 714 01e8 8381      		ldd r24,Z+3
 715 01ea 9481      		ldd r25,Z+4
 716 01ec 8017      		cp r24,r16
 717 01ee 9107      		cpc r25,r17
 718 01f0 49F4      		brne .L26
 719 01f2 6581      		ldd r22,Z+5
 720 01f4 7681      		ldd r23,Z+6
 721 01f6 8781      		ldd r24,Z+7
 722 01f8 9085      		ldd r25,Z+8
 723 01fa 6115      		cp r22,__zero_reg__
 724 01fc 7105      		cpc r23,__zero_reg__
 725 01fe 8105      		cpc r24,__zero_reg__
 726 0200 9105      		cpc r25,__zero_reg__
 727 0202 E9F6      		brne .L31
 728               	.L26:
 730               	.LM50:
 731 0204 CF5F      		subi r28,lo8(-(1))
 732 0206 4F5F      		subi r20,lo8(-(1))
 733 0208 5F4F      		sbci r21,hi8(-(1))
 734 020a 2B5F      		subi r18,lo8(-(5))
 735 020c 3F4F      		sbci r19,hi8(-(5))
 736 020e CF15      		cp r28,r15
 737 0210 30F3      		brlo .L28
 738               	.L30:
 111:/Users/Administrator/sos-2x/kernel/timestamp.c **** 		}
 112:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	}
 113:/Users/Administrator/sos-2x/kernel/timestamp.c **** 	return 0;
 740               	.LM51:
 741 0212 60E0      		ldi r22,lo8(0)
 742 0214 70E0      		ldi r23,hi8(0)
 743 0216 80E0      		ldi r24,hlo8(0)
 744 0218 90E0      		ldi r25,hhi8(0)
 745               	.L22:
 746               	/* epilogue: frame size=0 */
 747 021a CF91      		pop r28
 748 021c 1F91      		pop r17
 749 021e 0F91      		pop r16
 750 0220 FF90      		pop r15
 751 0222 0895      		ret
 752               	/* epilogue end (size=5) */
 753               	/* function ker_timestamp_query size 64 (55) */
 758               	.Lscope5:
 761               		.text
 763               	Letext:
 764               	/* File "/Users/Administrator/sos-2x/kernel/timestamp.c": code  274 = 0x0112 ( 250), prologues   9,
DEFINED SYMBOLS
                            *ABS*:00000000 timestamp.c
                            *ABS*:0000003f __SREG__
                            *ABS*:0000003e __SP_H__
                            *ABS*:0000003d __SP_L__
                            *ABS*:00000000 __tmp_reg__
                            *ABS*:00000001 __zero_reg__
                             .bss:00000000 ts_owner
/var/tmp//ccG0UpoG.s:297    .text:00000000 timestamp_do_timestamp
/var/tmp//ccG0UpoG.s:373    .text:0000006a timestamp_incoming
/var/tmp//ccG0UpoG.s:411    .text:0000008e timestamp_outgoing
/var/tmp//ccG0UpoG.s:449    .text:000000b2 ker_timestamp_register
/var/tmp//ccG0UpoG.s:597    .text:0000016c ker_timestamp_deregister
/var/tmp//ccG0UpoG.s:660    .text:000001a4 ker_timestamp_query
/var/tmp//ccG0UpoG.s:763    .text:00000224 Letext

UNDEFINED SYMBOLS
__do_copy_data
__do_clear_bss
radio_set_timestamp
sos_blk_mem_alloc
sos_blk_mem_free
