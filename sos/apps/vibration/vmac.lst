   1               		.file	"vmac.c"
   2               		.arch atmega128
   3               	__SREG__ = 0x3f
   4               	__SP_H__ = 0x3e
   5               	__SP_L__ = 0x3d
   6               	__tmp_reg__ = 0
   7               	__zero_reg__ = 1
   8               		.global __do_copy_data
   9               		.global __do_clear_bss
  12               		.text
  13               	.Ltext0:
 339               	.global	_mac_recv_callback
 340               	.global	_mac_recv_callback
 341               		.section .bss
 344               	_mac_recv_callback:
 345 0000 0000      		.skip 2,0
 346               		.section	.progmem.data,"a",@progbits
 349               	mod_header:
 350 0000 0000      		.word	0
 351 0002 09        		.byte	9
 352 0003 00        		.byte	0
 353 0004 00        		.byte	0
 354 0005 00        		.byte	0
 355 0006 0000 0000 		.skip 8,0
 355      0000 0000 
 356 000e 0000      		.word	pm(vmac_handler)
 357               		.text
 360               	getSeq:
   1:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /* -*- Mode: C; tab-width:4 -*- */
   2:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /* ex: set ts=4 shiftwidth=4 softtabstop=4 cindent: */
   3:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*
   4:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * Copyright (c) 2003 The Regents of the University of California.
   5:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * All rights reserved.
   6:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *
   7:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * Redistribution and use in source and binary forms, with or without
   8:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * modification, are permitted provided that the following conditions
   9:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * are met:
  10:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * 1. Redistributions of source code must retain the above copyright
  11:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *    notice, this list of conditions and the following disclaimer.
  12:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * 2. Redistributions in binary form must reproduce the above
  13:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *    copyright notice, this list of conditions and the following
  14:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *    disclaimer in the documentation and/or other materials provided
  15:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *    with the distribution.
  16:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * 3. All advertising materials mentioning features or use of this
  17:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *    software must display the following acknowledgement:
  18:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *       This product includes software developed by Networked &
  19:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *       Embedded Systems Lab at UCLA
  20:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * 4. Neither the name of the University nor that of the Laboratory
  21:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *    may be used to endorse or promote products derived from this
  22:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *    software without specific prior written permission.
  23:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *
  24:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS''
  25:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
  26:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
  27:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE REGENTS
  28:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
  29:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
  30:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
  31:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
  32:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
  33:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
  34:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
  35:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * SUCH DAMAGE.
  36:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *
  37:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  */
  38:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
  39:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /**
  40:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * @brief    virtual hal for radio
  41:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * @author   Hubert Wu {huberwu@cs.ucla.edu}
  42:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * @author   Dimitrios Lymberopoulos {dimitrios.lymberopoulos@yale.edu}
  43:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  */
  44:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
  45:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #include <random.h>
  46:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #include <hardware.h>
  47:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #include <sos_types.h>
  48:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #include <sos_module_types.h>
  49:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #include <sos_timer.h>
  50:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #include <malloc.h>
  51:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #include <net_stack.h>
  52:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #include <timestamp.h>
  53:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #include <systime.h>
  54:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #include <sos_info.h>
  55:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #include <message.h>
  56:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #include <string.h> // for memcpy
  57:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #include <spi_hal.h>
  58:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #include <vmac.h>
  59:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** //#define LED_DEBUG
  60:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #include <led_dbg.h>
  61:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #include <sys_module.h>
  62:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #include <module.h>
  63:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #ifdef SOS_USE_PREEMPTION
  64:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #include <priority.h>
  65:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #endif
  66:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
  67:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #define VMAC_SEND_STATE_IDLE         0
  68:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #define VMAC_SEND_STATE_BACKOFF      1
  69:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #define VMAC_SEND_STATE_WAIT_FOR_ACK 2
  70:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #define MSG_VMAC_TX_NEXT_MSG         MOD_MSG_START
  71:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #define MSG_VMAC_TX_ACKED            (MOD_MSG_START+1)
  72:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** //#define ENA_VMAC_UART_DEBUG
  73:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
  74:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** static Message *vmac_msg;
  75:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** //static volatile uint8_t valid_msg=0;
  76:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** static volatile uint8_t vmac_send_state;
  77:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
  78:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
  79:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * define the maximum number retry times for sending a packet            *
  80:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
  81:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #define MAX_RETRIES		5
  82:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
  83:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
  84:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * define the maximum number of messages in the MAC queue                *
  85:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
  86:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #define MAX_MSGS_IN_QUEUE	30
  87:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
  88:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
  89:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * define the timer ID                                                   *
  90:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
  91:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #define WAKEUP_TIMER_TID    0 //!< Wakeup Timer TID
  92:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
  93:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
  94:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * declare the timer                                                     *
  95:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
  96:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** static sos_timer_t wakeup_timer;// = TIMER_INITIALIZER(RADIO_PID, WAKEUP_TIMER_TID, TIMER_ONE_SHOT)
  97:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
  98:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
  99:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * declare the message handler                                           *
 100:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 101:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** static int8_t vmac_handler(void *state, Message *e);
 102:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 103:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 104:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * declare backoff mechanism functions                                   *
 105:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 106:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** static int16_t MacBackoff_congestionBackoff(int8_t retries);
 107:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** static void radio_msg_send(Message *msg);
 108:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** static uint8_t getMsgNumOfQueue();
 109:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 110:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 111:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * define the MAC module header                                          *
 112:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 113:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** static mod_header_t mod_header SOS_MODULE_HEADER ={
 114:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** mod_id : RADIO_PID,
 115:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** state_size : 0,
 116:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** num_timers : 0,
 117:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** num_sub_func : 0,
 118:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** num_prov_func : 0,
 119:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** module_handler: vmac_handler,
 120:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** };
 121:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 122:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 123:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * declare the MAC module                                                *
 124:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 125:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #ifndef SOS_USE_PREEMPTION
 126:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** static sos_module_t vmac_module;
 127:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #endif
 128:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 129:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 130:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * declare the queue used for MAC                                        *
 131:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 132:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** static mq_t vmac_pq;
 133:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 134:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 135:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * declare the sequence number variable                                  *
 136:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 137:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** static uint8_t seq_count;
 138:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 139:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 140:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * define the retry times variable                                       *
 141:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 142:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** static uint8_t retry_count;
 143:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 144:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 145:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 146:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * Define arrays for duplicate count                                     *
 147:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 148:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #define NUM_DUP_CHECK  3
 149:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** static uint16_t dup_addr[NUM_DUP_CHECK];
 150:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** static uint8_t dup_seq[NUM_DUP_CHECK];
 151:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** static uint8_t oldest_dup;
 152:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 153:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 154:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * get sequence number                                                   *
 155:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 156:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** static uint8_t getSeq()
 157:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** {
 362               	.LM1:
 363               	/* prologue: frame size=0 */
 364               	/* prologue end (size=0) */
 158:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	uint8_t ret;
 159:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	HAS_CRITICAL_SECTION;
 160:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	ENTER_CRITICAL_SECTION();
 366               	.LM2:
 367               	/* #APP */
 368 0000 8FB7      		in r24, __SREG__
 369 0002 F894      		cli
 370               		
 161:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	ret = seq_count;
 372               	.LM3:
 373               	/* #NOAPP */
 374 0004 9091 0000 		lds r25,seq_count
 162:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	LEAVE_CRITICAL_SECTION();
 376               	.LM4:
 377               	/* #APP */
 378 0008 8FBF      		out __SREG__, r24
 379               		
 163:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	return ret;
 164:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** }
 381               	.LM5:
 382               	/* #NOAPP */
 383 000a 892F      		mov r24,r25
 384 000c 9927      		clr r25
 385               	/* epilogue: frame size=0 */
 386 000e 0895      		ret
 387               	/* epilogue end (size=1) */
 388               	/* function getSeq size 15 (14) */
 394               	.Lscope0:
 397               	.global	radio_gc
 399               	radio_gc:
 165:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 166:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 167:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * increase sequence number                                              *
 168:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 169:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** static uint8_t incSeq()
 170:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** {
 171:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	uint8_t ret;
 172:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	HAS_CRITICAL_SECTION;
 173:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	ENTER_CRITICAL_SECTION();
 174:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	if(seq_count==0xFF) { // do not use 0x00 as a sequence number!
 175:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		ENTER_CRITICAL_SECTION();
 176:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		seq_count=1;
 177:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		ret=1;          // 0x00 will be considered ACKed by default!
 178:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	} else {
 179:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		ret = seq_count++;
 180:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	}
 181:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	LEAVE_CRITICAL_SECTION();
 182:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	return ret;
 183:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** }
 184:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 185:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 186:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * set sequence number to 0                                              *
 187:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 188:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** static void resetSeq()
 189:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** {
 190:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	HAS_CRITICAL_SECTION;
 191:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	ENTER_CRITICAL_SECTION();
 192:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	seq_count = 1 + ker_rand()%255;
 193:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	LEAVE_CRITICAL_SECTION();
 194:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** }
 195:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 196:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 197:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * message dispatch function for backoff mechanism for Collision         *
 198:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *   Avoidance implementation                                            *
 199:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 200:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** static int8_t vmac_handler(void *state, Message *e)
 201:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** {
 202:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** HAS_CRITICAL_SECTION;
 203:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** //   MsgParam *p = (MsgParam*)(e->data);
 204:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****    switch(e->type){
 205:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****        case MSG_TIMER_TIMEOUT:
 206:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		{
 207:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 208:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		ENTER_CRITICAL_SECTION();
 209:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		radio_msg_send(vmac_msg);
 210:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		LEAVE_CRITICAL_SECTION();
 211:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		break;
 212:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		}
 213:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	   case MSG_VMAC_TX_NEXT_MSG:
 214:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	   {
 215:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		ENTER_CRITICAL_SECTION();
 216:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		if( vmac_msg == NULL ) {
 217:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			retry_count = 0;
 218:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			vmac_msg = mq_dequeue(&vmac_pq);
 219:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			if( vmac_msg != NULL ) {
 220:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 				radio_msg_send(vmac_msg);
 221:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			}
 222:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		}
 223:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		LEAVE_CRITICAL_SECTION();	   
 224:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	     break;
 225:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	   }
 226:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	   case MSG_VMAC_TX_ACKED:
 227:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	   {
 228:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		ENTER_CRITICAL_SECTION();
 229:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		ker_timer_stop(RADIO_PID, WAKEUP_TIMER_TID);
 230:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		vmac_send_state = VMAC_SEND_STATE_IDLE;
 231:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		retry_count = 0;
 232:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		msg_send_senddone(vmac_msg, 1, RADIO_PID);  //to release the memory for this msg
 233:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		vmac_msg = NULL;
 234:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		vmac_msg = mq_dequeue(&vmac_pq);
 235:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		if( vmac_msg != NULL ) {
 236:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			radio_msg_send(vmac_msg);
 237:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		}
 238:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		LEAVE_CRITICAL_SECTION();
 239:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		break;
 240:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	   }
 241:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****        default:
 242:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		break;
 243:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****    }
 244:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****    return SOS_OK;
 245:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** }
 246:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 247:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 248:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * GC support                                                            *
 249:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 250:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** void radio_gc( void )
 251:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** {
 401               	.LM6:
 402               	/* prologue: frame size=0 */
 403               	/* prologue end (size=0) */
 252:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	mq_gc_mark_payload( &vmac_pq, RADIO_PID );  
 405               	.LM7:
 406 0010 69E0      		ldi r22,lo8(9)
 407 0012 80E0      		ldi r24,lo8(vmac_pq)
 408 0014 90E0      		ldi r25,hi8(vmac_pq)
 409 0016 0E94 0000 		call mq_gc_mark_payload
 253:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	if( vmac_msg != NULL && vmac_msg->data != NULL 
 411               	.LM8:
 412 001a E091 0000 		lds r30,vmac_msg
 413 001e F091 0000 		lds r31,(vmac_msg)+1
 414 0022 3097      		sbiw r30,0
 415 0024 61F0      		breq .L3
 417               	.LM9:
 418 0026 6085      		ldd r22,Z+8
 419 0028 7185      		ldd r23,Z+9
 420 002a 6115      		cp r22,__zero_reg__
 421 002c 7105      		cpc r23,__zero_reg__
 422 002e 39F0      		breq .L3
 423 0030 8285      		ldd r24,Z+10
 424 0032 9385      		ldd r25,Z+11
 425 0034 82FF      		sbrs r24,2
 426 0036 03C0      		rjmp .L3
 254:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			&& flag_msg_release(vmac_msg->flag) ) {
 255:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		ker_gc_mark( RADIO_PID, vmac_msg->data );
 428               	.LM10:
 429 0038 89E0      		ldi r24,lo8(9)
 430 003a 0E94 0000 		call ker_gc_mark
 431               	.L3:
 256:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	}
 257:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	malloc_gc( RADIO_PID );
 433               	.LM11:
 434 003e 89E0      		ldi r24,lo8(9)
 435 0040 0E94 0000 		call malloc_gc
 436               	/* epilogue: frame size=0 */
 437 0044 0895      		ret
 438               	/* epilogue end (size=1) */
 439               	/* function radio_gc size 27 (26) */
 441               	.Lscope1:
 444               	.global	radio_msg_gc
 446               	radio_msg_gc:
 258:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** }
 259:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 260:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** void radio_msg_gc( void )
 261:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** {
 448               	.LM12:
 449               	/* prologue: frame size=0 */
 450               	/* prologue end (size=0) */
 262:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	mq_gc_mark_hdr( &vmac_pq, RADIO_PID );
 452               	.LM13:
 453 0046 69E0      		ldi r22,lo8(9)
 454 0048 80E0      		ldi r24,lo8(vmac_pq)
 455 004a 90E0      		ldi r25,hi8(vmac_pq)
 456 004c 0E94 0000 		call mq_gc_mark_hdr
 457               	/* epilogue: frame size=0 */
 458 0050 0895      		ret
 459               	/* epilogue end (size=1) */
 460               	/* function radio_msg_gc size 6 (5) */
 462               	.Lscope2:
 466               	.global	mac_set_recv_callback
 468               	mac_set_recv_callback:
 263:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** }
 264:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 265:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 266:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 267:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * define the callback function for receiving data                       *
 268:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 269:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** void (*_mac_recv_callback)(Message *m) = 0;
 270:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** void mac_set_recv_callback(void (*func)(Message *m))
 271:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** {
 470               	.LM14:
 471               	/* prologue: frame size=0 */
 472               	/* prologue end (size=0) */
 272:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	_mac_recv_callback = func;
 474               	.LM15:
 475 0052 9093 0000 		sts (_mac_recv_callback)+1,r25
 476 0056 8093 0000 		sts _mac_recv_callback,r24
 477               	/* epilogue: frame size=0 */
 478 005a 0895      		ret
 479               	/* epilogue end (size=1) */
 480               	/* function mac_set_recv_callback size 5 (4) */
 482               	.Lscope3:
 487               	.global	sosmsg_to_mac
 489               	sosmsg_to_mac:
 273:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** }
 274:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 275:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 276:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * change packet's format from SOS message to MAC                        *
 277:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 278:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** void sosmsg_to_mac(Message *msg, VMAC_PPDU *ppdu)
 279:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** {
 491               	.LM16:
 492               	/* prologue: frame size=0 */
 493 005c EF92      		push r14
 494 005e FF92      		push r15
 495 0060 0F93      		push r16
 496 0062 1F93      		push r17
 497               	/* prologue end (size=4) */
 498 0064 8C01      		movw r16,r24
 499 0066 7B01      		movw r14,r22
 280:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	ppdu->len = msg->len + PRE_PAYLOAD_LEN + POST_PAYLOAD_LEN;
 501               	.LM17:
 502 0068 FC01      		movw r30,r24
 503 006a 8781      		ldd r24,Z+7
 504 006c 825F      		subi r24,lo8(-(14))
 505 006e FB01      		movw r30,r22
 506 0070 8583      		std Z+5,r24
 281:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 282:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	ppdu->mpdu.daddr = host_to_net(msg->daddr);
 508               	.LM18:
 509 0072 F801      		movw r30,r16
 510 0074 8281      		ldd r24,Z+2
 511 0076 9381      		ldd r25,Z+3
 512 0078 0E94 0000 		call host_to_net
 513 007c F701      		movw r30,r14
 514 007e 8487      		std Z+12,r24
 515 0080 9587      		std Z+13,r25
 283:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	ppdu->mpdu.saddr = host_to_net(msg->saddr);
 517               	.LM19:
 518 0082 F801      		movw r30,r16
 519 0084 8481      		ldd r24,Z+4
 520 0086 9581      		ldd r25,Z+5
 521 0088 0E94 0000 		call host_to_net
 522 008c F701      		movw r30,r14
 523 008e 8687      		std Z+14,r24
 524 0090 9787      		std Z+15,r25
 284:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	ppdu->mpdu.did = msg->did;
 526               	.LM20:
 527 0092 F801      		movw r30,r16
 528 0094 8081      		ld r24,Z
 529 0096 F701      		movw r30,r14
 530 0098 808B      		std Z+16,r24
 285:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	ppdu->mpdu.sid = msg->sid;
 532               	.LM21:
 533 009a F801      		movw r30,r16
 534 009c 8181      		ldd r24,Z+1
 535 009e F701      		movw r30,r14
 536 00a0 818B      		std Z+17,r24
 286:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	ppdu->mpdu.type = msg->type;
 538               	.LM22:
 539 00a2 F801      		movw r30,r16
 540 00a4 8681      		ldd r24,Z+6
 541 00a6 F701      		movw r30,r14
 542 00a8 828B      		std Z+18,r24
 287:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 288:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	ppdu->mpdu.data = msg->data;
 544               	.LM23:
 545 00aa F801      		movw r30,r16
 546 00ac 8085      		ldd r24,Z+8
 547 00ae 9185      		ldd r25,Z+9
 548 00b0 F701      		movw r30,r14
 549 00b2 838B      		std Z+19,r24
 550 00b4 948B      		std Z+20,r25
 551               	/* epilogue: frame size=0 */
 552 00b6 1F91      		pop r17
 553 00b8 0F91      		pop r16
 554 00ba FF90      		pop r15
 555 00bc EF90      		pop r14
 556 00be 0895      		ret
 557               	/* epilogue end (size=5) */
 558               	/* function sosmsg_to_mac size 50 (41) */
 560               	.Lscope4:
 565               	.global	mac_to_sosmsg
 567               	mac_to_sosmsg:
 289:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** }
 290:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 291:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 292:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * change packet's format from MAC to SOS message                        *
 293:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 294:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** void mac_to_sosmsg(VMAC_PPDU *ppdu, Message *msg)
 295:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** {
 569               	.LM24:
 570               	/* prologue: frame size=0 */
 571 00c0 0F93      		push r16
 572 00c2 1F93      		push r17
 573 00c4 CF93      		push r28
 574 00c6 DF93      		push r29
 575               	/* prologue end (size=4) */
 576 00c8 8C01      		movw r16,r24
 577 00ca EB01      		movw r28,r22
 296:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	msg->len = ppdu->len - (PRE_PAYLOAD_LEN + POST_PAYLOAD_LEN);
 579               	.LM25:
 580 00cc FC01      		movw r30,r24
 581 00ce 8581      		ldd r24,Z+5
 582 00d0 8E50      		subi r24,lo8(-(-14))
 583 00d2 8F83      		std Y+7,r24
 297:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 298:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	msg->daddr = net_to_host(ppdu->mpdu.daddr);
 585               	.LM26:
 586 00d4 8485      		ldd r24,Z+12
 587 00d6 9585      		ldd r25,Z+13
 588 00d8 0E94 0000 		call net_to_host
 589 00dc 8A83      		std Y+2,r24
 590 00de 9B83      		std Y+3,r25
 299:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	msg->saddr = net_to_host(ppdu->mpdu.saddr);
 592               	.LM27:
 593 00e0 F801      		movw r30,r16
 594 00e2 8685      		ldd r24,Z+14
 595 00e4 9785      		ldd r25,Z+15
 596 00e6 0E94 0000 		call net_to_host
 597 00ea 8C83      		std Y+4,r24
 598 00ec 9D83      		std Y+5,r25
 300:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	msg->did = ppdu->mpdu.did;
 600               	.LM28:
 601 00ee F801      		movw r30,r16
 602 00f0 8089      		ldd r24,Z+16
 603 00f2 8883      		st Y,r24
 301:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	msg->sid = ppdu->mpdu.sid;
 605               	.LM29:
 606 00f4 8189      		ldd r24,Z+17
 607 00f6 8983      		std Y+1,r24
 302:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	msg->type = ppdu->mpdu.type;
 609               	.LM30:
 610 00f8 8289      		ldd r24,Z+18
 611 00fa 8E83      		std Y+6,r24
 303:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 304:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	//msg->data = ppdu->mpdu.data;
 305:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	if(msg->len==0){
 613               	.LM31:
 614 00fc 8F81      		ldd r24,Y+7
 615 00fe 8823      		tst r24
 616 0100 19F4      		brne .L8
 306:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		msg->data = NULL;
 618               	.LM32:
 619 0102 1886      		std Y+8,__zero_reg__
 620 0104 1986      		std Y+9,__zero_reg__
 621 0106 05C0      		rjmp .L9
 622               	.L8:
 307:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	} else {
 308:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		msg->data = ppdu->mpdu.data;
 624               	.LM33:
 625 0108 F801      		movw r30,r16
 626 010a 8389      		ldd r24,Z+19
 627 010c 9489      		ldd r25,Z+20
 628 010e 8887      		std Y+8,r24
 629 0110 9987      		std Y+9,r25
 630               	.L9:
 309:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	}
 310:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	msg->flag |= SOS_MSG_RELEASE;
 632               	.LM34:
 633 0112 8A85      		ldd r24,Y+10
 634 0114 9B85      		ldd r25,Y+11
 635 0116 8460      		ori r24,lo8(4)
 636 0118 8A87      		std Y+10,r24
 637 011a 9B87      		std Y+11,r25
 311:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****     // RSSI is the most significant byte of the post payload
 312:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****     // But, since the word is little endian, its the lower byte.
 313:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****     msg->rssi = (ppdu->mpdu.fcs & 0x00ff);
 639               	.LM35:
 640 011c F801      		movw r30,r16
 641 011e 8589      		ldd r24,Z+21
 642 0120 888B      		std Y+16,r24
 643               	/* epilogue: frame size=0 */
 644 0122 DF91      		pop r29
 645 0124 CF91      		pop r28
 646 0126 1F91      		pop r17
 647 0128 0F91      		pop r16
 648 012a 0895      		ret
 649               	/* epilogue end (size=5) */
 650               	/* function mac_to_sosmsg size 54 (45) */
 652               	.Lscope5:
 657               	.global	mac_to_vhal
 659               	mac_to_vhal:
 314:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** }
 315:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 316:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 317:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * change packet's format from MAC to vhal                               *
 318:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 319:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** void mac_to_vhal(VMAC_PPDU *ppdu, vhal_data *vd)
 320:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** {
 661               	.LM36:
 662               	/* prologue: frame size=0 */
 663 012c CF93      		push r28
 664 012e DF93      		push r29
 665               	/* prologue end (size=2) */
 666 0130 FC01      		movw r30,r24
 667 0132 DB01      		movw r26,r22
 321:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	vd->pre_payload_len = PRE_PAYLOAD_LEN;
 669               	.LM37:
 670 0134 8CE0      		ldi r24,lo8(12)
 671 0136 8C93      		st X,r24
 322:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	vd->pre_payload = (uint8_t*)&ppdu->mpdu.fcf;
 673               	.LM38:
 674 0138 3696      		adiw r30,6
 675 013a EB01      		movw r28,r22
 676 013c EB83      		std Y+3,r30
 677 013e FC83      		std Y+4,r31
 323:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 324:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	vd->post_payload_len = POST_PAYLOAD_LEN;
 679               	.LM39:
 680 0140 82E0      		ldi r24,lo8(2)
 681 0142 8A83      		std Y+2,r24
 325:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	vd->post_payload = (uint8_t*)&ppdu->mpdu.fcs;
 683               	.LM40:
 684 0144 3F96      		adiw r30,15
 685 0146 EF83      		std Y+7,r30
 686 0148 F887      		std Y+8,r31
 687 014a 7597      		sbiw r30,21
 326:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 327:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	vd->payload_len = ppdu->len - vd->pre_payload_len - vd->post_payload_len;
 689               	.LM41:
 690 014c 8581      		ldd r24,Z+5
 691 014e 8E50      		subi r24,lo8(-(-14))
 692 0150 8983      		std Y+1,r24
 328:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	vd->payload = ppdu->mpdu.data;
 694               	.LM42:
 695 0152 8389      		ldd r24,Z+19
 696 0154 9489      		ldd r25,Z+20
 697 0156 8D83      		std Y+5,r24
 698 0158 9E83      		std Y+6,r25
 699               	/* epilogue: frame size=0 */
 700 015a DF91      		pop r29
 701 015c CF91      		pop r28
 702 015e 0895      		ret
 703               	/* epilogue end (size=3) */
 704               	/* function mac_to_vhal size 26 (21) */
 706               	.Lscope6:
 711               	.global	vhal_to_mac
 713               	vhal_to_mac:
 329:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** }
 330:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 331:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 332:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * change packet's format from vhal to MAC                               *
 333:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 334:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** void vhal_to_mac(vhal_data *vd, VMAC_PPDU *ppdu)
 335:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** {
 715               	.LM43:
 716               	/* prologue: frame size=0 */
 717 0160 CF93      		push r28
 718 0162 DF93      		push r29
 719               	/* prologue end (size=2) */
 720 0164 AC01      		movw r20,r24
 721 0166 FB01      		movw r30,r22
 336:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	ppdu->len = vd->payload_len + vd->pre_payload_len + vd->post_payload_len;
 723               	.LM44:
 724 0168 EC01      		movw r28,r24
 725 016a 8981      		ldd r24,Y+1
 726 016c 9881      		ld r25,Y
 727 016e 890F      		add r24,r25
 728 0170 9A81      		ldd r25,Y+2
 729 0172 890F      		add r24,r25
 730 0174 8583      		std Z+5,r24
 337:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	memcpy((uint8_t*)&ppdu->mpdu.fcf, vd->pre_payload, PRE_PAYLOAD_LEN);
 732               	.LM45:
 733 0176 2B81      		ldd r18,Y+3
 734 0178 3C81      		ldd r19,Y+4
 735 017a 3696      		adiw r30,6
 736 017c 8CE0      		ldi r24,lo8(12)
 737 017e DF01      		movw r26,r30
 738 0180 E901      		movw r28,r18
 739 0182 0990      		ld __tmp_reg__,Y+
 740 0184 0D92      		st X+,__tmp_reg__
 741 0186 8A95      		dec r24
 742 0188 E1F7      		brne .-8
 743 018a 3697      		sbiw r30,6
 338:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 339:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	ppdu->mpdu.data = vd->payload;
 745               	.LM46:
 746 018c EA01      		movw r28,r20
 747 018e 8D81      		ldd r24,Y+5
 748 0190 9E81      		ldd r25,Y+6
 749 0192 838B      		std Z+19,r24
 750 0194 948B      		std Z+20,r25
 340:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	memcpy((uint8_t*)&ppdu->mpdu.fcs, vd->post_payload, vd->post_payload_len);
 752               	.LM47:
 753 0196 8A81      		ldd r24,Y+2
 754 0198 9927      		clr r25
 755 019a 2F81      		ldd r18,Y+7
 756 019c 3885      		ldd r19,Y+8
 757 019e AC01      		movw r20,r24
 758 01a0 B901      		movw r22,r18
 759 01a2 CF01      		movw r24,r30
 760 01a4 4596      		adiw r24,21
 761 01a6 0E94 0000 		call memcpy
 762               	/* epilogue: frame size=0 */
 763 01aa DF91      		pop r29
 764 01ac CF91      		pop r28
 765 01ae 0895      		ret
 766               	/* epilogue end (size=3) */
 767               	/* function vhal_to_mac size 40 (35) */
 769               	.Lscope7:
 774               	MacBackoff_congestionBackoff:
 341:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** }
 342:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 343:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 344:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * send the message by radio                                             *
 345:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 346:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** static void radio_msg_send(Message *msg)
 347:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** {
 348:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	int16_t timestamp;
 349:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	//construct the packet
 350:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	VMAC_PPDU ppdu;
 351:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	vhal_data vd;
 352:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 353:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	if( Radio_Check_CCA() ) {
 354:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		if( retry_count == 0 ) {
 355:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			incSeq();
 356:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		}
 357:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		if(msg->type == MSG_TIMESTAMP){
 358:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			uint32_t timestp = ker_systime32();
 359:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			memcpy(msg->data, (uint8_t*)(&timestp),sizeof(uint32_t));
 360:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		}
 361:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		sosmsg_to_mac(msg, &ppdu);
 362:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 363:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****         if(msg->daddr==BCAST_ADDRESS || msg->type == MSG_TIMESTAMP) {
 364:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			ppdu.mpdu.fcf = BASIC_RF_FCF_NOACK;     //Broadcast: No Ack
 365:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		} else {
 366:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			//ppdu.mpdu.fcf = BASIC_RF_FCF_NOACK;     //Broadcast: No Ack
 367:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			ppdu.mpdu.fcf = BASIC_RF_FCF_ACK;       //Unicast: Ack
 368:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		}
 369:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 370:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		ppdu.mpdu.panid = host_to_net(VMAC_PANID); // PANID
 371:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		ppdu.mpdu.seq = getSeq();	//count by software
 372:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		ppdu.mpdu.fcs = 1;		//doesn't matter, hardware supports it
 373:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 374:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		mac_to_vhal(&ppdu, &vd);
 375:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		timestamp_outgoing(msg, ker_systime32());
 376:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		Radio_Send_Pack(&vd, &timestamp);
 377:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	
 378:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****         // do not retransmit broadcast messages nor timestamps!
 379:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		if( msg->daddr == BCAST_ADDRESS || msg->type == MSG_TIMESTAMP) {
 380:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		//if( 1 ) {
 381:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			retry_count = 0;
 382:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			msg_send_senddone(msg, 1, RADIO_PID);
 383:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			vmac_msg = NULL;
 384:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			vmac_send_state = VMAC_SEND_STATE_IDLE;
 385:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			return;
 386:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		} else {
 387:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			
 388:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			if( retry_count < (uint8_t)MAX_RETRIES ) {
 389:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 				vmac_send_state = VMAC_SEND_STATE_WAIT_FOR_ACK;
 390:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 				vmac_msg = msg;
 391:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 				//
 392:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 				// We add TWO milliseconds for the ACK transmission time
 393:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 				//
 394:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 				if( ker_timer_restart(RADIO_PID, WAKEUP_TIMER_TID, 
 395:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 					MacBackoff_congestionBackoff(retry_count) + 2) != SOS_OK ) {
 396:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 					ker_timer_start(RADIO_PID, WAKEUP_TIMER_TID,
 397:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 							MacBackoff_congestionBackoff(retry_count) + 2);
 398:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 				}
 399:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 				retry_count++;
 400:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			} else {
 401:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 				retry_count = 0;
 402:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 				msg_send_senddone(vmac_msg, 0, RADIO_PID);  //to release the memory for this msg
 403:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 				vmac_msg = NULL;
 404:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 				vmac_send_state = VMAC_SEND_STATE_IDLE;
 405:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 				if( getMsgNumOfQueue() != 0 ) {
 406:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 					post_short( RADIO_PID, RADIO_PID, MSG_VMAC_TX_NEXT_MSG, 0, 0, 0);
 407:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 				}
 408:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			}
 409:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		}
 410:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	} else {
 411:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		if( retry_count < (uint8_t)MAX_RETRIES ) {
 412:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			vmac_send_state = VMAC_SEND_STATE_BACKOFF;
 413:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			vmac_msg = msg;
 414:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			if( ker_timer_restart(RADIO_PID, WAKEUP_TIMER_TID, 
 415:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 				MacBackoff_congestionBackoff(retry_count)) != SOS_OK ) 	// setup backoff timer
 416:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			{
 417:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 				ker_timer_start(RADIO_PID, WAKEUP_TIMER_TID,
 418:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 						MacBackoff_congestionBackoff(retry_count));
 419:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			}
 420:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			retry_count++;
 421:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		} else {
 422:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			retry_count = 0;
 423:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			msg_send_senddone(vmac_msg, 0, RADIO_PID);  //to release the memory for this msg
 424:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			vmac_msg = NULL;
 425:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			vmac_send_state = VMAC_SEND_STATE_IDLE;
 426:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			if( getMsgNumOfQueue() != 0 ) {
 427:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 				post_short( RADIO_PID, RADIO_PID, MSG_VMAC_TX_NEXT_MSG, 0, 0, 0);
 428:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 			}
 429:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		}
 430:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	}
 431:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** }
 432:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 433:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 434:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * get message number in the queue                                       *
 435:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 436:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** static uint8_t getMsgNumOfQueue()
 437:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** {
 438:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	uint8_t ret = 0;
 439:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	HAS_CRITICAL_SECTION;
 440:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	ENTER_CRITICAL_SECTION();
 441:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	ret = vmac_pq.msg_cnt;
 442:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	LEAVE_CRITICAL_SECTION();
 443:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	return ret;
 444:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** }
 445:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 446:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 447:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 448:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * will be called by post_net, etc functions to send message             *
 449:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 450:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*
 451:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * If send state is not idle, queue the message.
 452:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * If CCA is busy, perform backoff.
 453:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * Otherwise, send the message and wait for ACK.
 454:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  */
 455:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** void radio_msg_alloc(Message *msg)
 456:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** {
 457:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	HAS_CRITICAL_SECTION;
 458:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 459:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	ENTER_CRITICAL_SECTION();
 460:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	if( vmac_send_state != VMAC_SEND_STATE_IDLE ) {
 461:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		mq_enqueue(&vmac_pq, msg);
 462:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		LEAVE_CRITICAL_SECTION();
 463:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		return;
 464:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	}
 465:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 466:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	retry_count = 0;
 467:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	radio_msg_send(msg);
 468:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 469:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	LEAVE_CRITICAL_SECTION();
 470:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** }
 471:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 472:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** void _MacRecvAck(uint8_t ack_seq)
 473:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** {
 474:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	if( (vmac_send_state == VMAC_SEND_STATE_WAIT_FOR_ACK) && (getSeq() == ack_seq) ) {
 475:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		//LED_DBG(LED_RED_TOGGLE);
 476:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		post_short( RADIO_PID, RADIO_PID, MSG_VMAC_TX_ACKED, 0, 0, 0 );
 477:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	}
 478:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** }
 479:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 480:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 481:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * the callback fnction for reading data from cc2420                     *
 482:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 483:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** void _MacRecvCallBack(int16_t timestamp)
 484:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** {
 485:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #ifdef SOS_USE_PREEMPTION
 486:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****   HAS_PREEMPTION_SECTION;
 487:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****   // disable preemption
 488:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****   DISABLE_PREEMPTION();
 489:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #endif
 490:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 491:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	VMAC_PPDU ppdu;
 492:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	vhal_data vd;
 493:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 494:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	mac_to_vhal(&ppdu, &vd);   // note that vd.payload_len will have a bogus entry. It will be overwri
 495:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	Radio_Disable_Interrupt();		//disable interrupt while reading data
 496:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	if( !Radio_Recv_Pack(&vd) ) {
 497:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		Radio_Enable_Interrupt();	//enable interrupt
 498:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		return;
 499:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	}
 500:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	Radio_Enable_Interrupt();   //enable interrupt
 501:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	vhal_to_mac(&vd, &ppdu);
 502:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /* This is now done on the chip with the PANID
 503:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	if( ppdu.mpdu.group     != node_group_id ) {	 
 504:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		ker_free(vd.payload);	 
 505:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		Radio_Enable_Interrupt();		//enable interrupt
 506:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		return;	 
 507:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	}	 
 508:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	*/
 509:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	// Andreas - filter node ID here, even before allocating any new memory 
 510:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	// if you're using sos/config/base you must comment this block out!
 511:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	if (net_to_host(ppdu.mpdu.daddr) != node_address && net_to_host(ppdu.mpdu.daddr) != BCAST_ADDRESS)
 512:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	{
 513:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		ker_free(vd.payload);
 514:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		return;
 515:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	}
 516:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 517:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	Message *msg = msg_create();
 518:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	if( msg == NULL ) {
 519:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		ker_free(vd.payload);
 520:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		return;
 521:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	}
 522:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	mac_to_sosmsg(&ppdu, msg);
 523:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 524:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	// Andreas - start debug
 525:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #ifdef ENA_VMAC_UART_DEBUG
 526:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	uint8_t *payload;
 527:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	uint8_t msg_len;
 528:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	msg_len=msg->len;
 529:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	payload = msg->data;
 530:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 531:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	//post_uart(msg->sid, msg->did, msg->type, msg_len, payload, SOS_MSG_RELEASE, msg->daddr);
 532:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 533:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	// Swap daddr with saddr, because daddr is useless when debugging.
 534:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	// This way, if sossrv says "dest addr: 15" that actually means the message SENDER was node 15
 535:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	post_uart(msg->sid, msg->did, msg->type, msg_len, payload, SOS_MSG_RELEASE, msg->saddr);
 536:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #endif
 537:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 538:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	if(msg->type == MSG_TIMESTAMP){
 539:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		uint32_t timestp = ker_systime32();
 540:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		memcpy(((uint8_t*)(msg->data) + sizeof(uint32_t)),(uint8_t*)(&timestp),sizeof(uint32_t));
 541:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	}
 542:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****     timestamp_incoming(msg, ker_systime32());
 543:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 544:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	// Check for duplicates
 545:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****     if (msg->saddr != BCAST_ADDRESS)
 546:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****     {
 547:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****         uint8_t found = 0;
 548:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****         uint8_t i;
 549:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****         for(i=0; i<NUM_DUP_CHECK; i++)
 550:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****         {
 551:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****             if(msg->saddr == dup_addr[i])
 552:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****             {
 553:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                 if(ppdu.mpdu.seq == dup_seq[i])
 554:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                 {
 555:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                     // duplicate message
 556:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                     //ker_free(vd.payload);
 557:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                     //properly dispose of the message.
 558:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                     msg->flag |= SOS_MSG_RELEASE;
 559:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                     msg_dispose(msg);
 560:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                     return;
 561:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                 } else {
 562:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                     // same address, but different seq
 563:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                     dup_seq[i] = ppdu.mpdu.seq;
 564:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                     found = 1;
 565:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                     break;
 566:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                 }
 567:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****             }
 568:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****         }
 569:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****         if(!found){
 570:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****             // not an entry yet. Find an empty spot, or overwrite one
 571:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****             found = 0;
 572:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****             for(i=0; i<NUM_DUP_CHECK; i++)
 573:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****             {
 574:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                 if(dup_addr[i] == BCAST_ADDRESS){
 575:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                     dup_addr[i] = msg->saddr;
 576:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                     dup_seq[i] = ppdu.mpdu.seq;
 577:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                     found = 1;
 578:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                     break;
 579:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                 }
 580:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****             }
 581:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****             if(!found){
 582:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                 // overwrite oldest
 583:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                 dup_addr[oldest_dup] = msg->saddr;
 584:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                 dup_seq[oldest_dup] = ppdu.mpdu.seq;
 585:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****                 oldest_dup = (oldest_dup + 1)%NUM_DUP_CHECK;
 586:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****             }
 587:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****         }
 588:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****     }
 589:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 590:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	handle_incoming_msg(msg, SOS_MSG_RADIO_IO);
 591:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #ifdef SOS_USE_PREEMPTION
 592:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	ENABLE_GLOBAL_INTERRUPTS();
 593:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	ENABLE_PREEMPTION(NULL);
 594:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #endif
 595:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** }
 596:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 597:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 598:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * set radio timestamp                                                   *
 599:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 600:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** int8_t radio_set_timestamp(bool on)
 601:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** {
 602:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	return SOS_OK;
 603:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** }
 604:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 605:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 606:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * Implement exponential backoff mechanism                               *
 607:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 608:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** static int16_t MacBackoff_congestionBackoff(int8_t retries)
 609:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** {
 776               	.LM48:
 777               	/* prologue: frame size=0 */
 778 01b0 CF93      		push r28
 779 01b2 DF93      		push r29
 780               	/* prologue end (size=2) */
 610:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	int8_t i;
 611:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	int16_t masktime = 1;
 782               	.LM49:
 783 01b4 C1E0      		ldi r28,lo8(1)
 784 01b6 D0E0      		ldi r29,hi8(1)
 612:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	for(i=0; i<retries; i++)
 786               	.LM50:
 787 01b8 1816      		cp __zero_reg__,r24
 788 01ba 24F4      		brge .L19
 789               	.L16:
 613:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		masktime *= 2;			//masktime = 2^retries
 791               	.LM51:
 792 01bc CC0F      		add r28,r28
 793 01be DD1F      		adc r29,r29
 795               	.LM52:
 796 01c0 8150      		subi r24,lo8(-(-1))
 797 01c2 E1F7      		brne .L16
 798               	.L19:
 614:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	masktime --;				//get the mask
 800               	.LM53:
 801 01c4 2197      		sbiw r28,1
 615:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	if( masktime > 1023 )
 803               	.LM54:
 804 01c6 84E0      		ldi r24,hi8(1024)
 805 01c8 C030      		cpi r28,lo8(1024)
 806 01ca D807      		cpc r29,r24
 807 01cc 14F0      		brlt .L17
 616:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 		masktime = 1023;		//max backoff 1023
 809               	.LM55:
 810 01ce CFEF      		ldi r28,lo8(1023)
 811 01d0 D3E0      		ldi r29,hi8(1023)
 812               	.L17:
 617:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** //	return ((ker_rand() & 0xF) + TIMER_MIN_INTERVAL);
 618:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	return ((ker_rand() & masktime) + TIMER_MIN_INTERVAL);
 814               	.LM56:
 815 01d2 0E94 0000 		call ker_rand
 816 01d6 C823      		and r28,r24
 817 01d8 D923      		and r29,r25
 619:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** }
 819               	.LM57:
 820 01da CE01      		movw r24,r28
 821 01dc 0596      		adiw r24,5
 822               	/* epilogue: frame size=0 */
 823 01de DF91      		pop r29
 824 01e0 CF91      		pop r28
 825 01e2 0895      		ret
 826               	/* epilogue end (size=3) */
 827               	/* function MacBackoff_congestionBackoff size 27 (22) */
 833               	.Lscope8:
 837               	getMsgNumOfQueue:
 839               	.LM58:
 840               	/* prologue: frame size=0 */
 841               	/* prologue end (size=0) */
 843               	.LM59:
 844               	/* #APP */
 845 01e4 8FB7      		in r24, __SREG__
 846 01e6 F894      		cli
 847               		
 849               	.LM60:
 850               	/* #NOAPP */
 851 01e8 9091 0000 		lds r25,vmac_pq
 853               	.LM61:
 854               	/* #APP */
 855 01ec 8FBF      		out __SREG__, r24
 856               		
 858               	.LM62:
 859               	/* #NOAPP */
 860 01ee 892F      		mov r24,r25
 861 01f0 9927      		clr r25
 862               	/* epilogue: frame size=0 */
 863 01f2 0895      		ret
 864               	/* epilogue end (size=1) */
 865               	/* function getMsgNumOfQueue size 15 (14) */
 871               	.Lscope9:
 876               	radio_msg_send:
 878               	.LM63:
 879               	/* prologue: frame size=34 */
 880 01f4 DF92      		push r13
 881 01f6 EF92      		push r14
 882 01f8 FF92      		push r15
 883 01fa 0F93      		push r16
 884 01fc 1F93      		push r17
 885 01fe CF93      		push r28
 886 0200 DF93      		push r29
 887 0202 CDB7      		in r28,__SP_L__
 888 0204 DEB7      		in r29,__SP_H__
 889 0206 A297      		sbiw r28,34
 890 0208 0FB6      		in __tmp_reg__,__SREG__
 891 020a F894      		cli
 892 020c DEBF      		out __SP_H__,r29
 893 020e 0FBE      		out __SREG__,__tmp_reg__
 894 0210 CDBF      		out __SP_L__,r28
 895               	/* prologue end (size=15) */
 896 0212 7C01      		movw r14,r24
 898               	.LM64:
 899 0214 0E94 0000 		call Radio_Check_CCA
 900 0218 D82E      		mov r13,r24
 901 021a 9091 0000 		lds r25,retry_count
 902 021e 8823      		tst r24
 903 0220 09F4      		brne .+2
 904 0222 B6C0      		rjmp .L22
 906               	.LM65:
 907 0224 9923      		tst r25
 908 0226 71F4      		brne .L23
 909               	.LBB2:
 910               	.LBB3:
 912               	.LM66:
 913               	/* #APP */
 914 0228 9FB7      		in r25, __SREG__
 915 022a F894      		cli
 916               		
 918               	.LM67:
 919               	/* #NOAPP */
 920 022c 8091 0000 		lds r24,seq_count
 921 0230 8F3F      		cpi r24,lo8(-1)
 922 0232 21F4      		brne .L24
 924               	.LM68:
 925               	/* #APP */
 926 0234 9FB7      		in r25, __SREG__
 927 0236 F894      		cli
 928               		
 930               	.LM69:
 931               	/* #NOAPP */
 932 0238 81E0      		ldi r24,lo8(1)
 933 023a 01C0      		rjmp .L43
 934               	.L24:
 936               	.LM70:
 937 023c 8F5F      		subi r24,lo8(-(1))
 938               	.L43:
 939 023e 8093 0000 		sts seq_count,r24
 941               	.LM71:
 942               	/* #APP */
 943 0242 9FBF      		out __SREG__, r25
 944               		
 945               	/* #NOAPP */
 946               	.L23:
 947               	.LBE3:
 948               	.LBE2:
 950               	.LM72:
 951 0244 F701      		movw r30,r14
 952 0246 8681      		ldd r24,Z+6
 953 0248 8031      		cpi r24,lo8(16)
 954 024a 61F4      		brne .L27
 955               	.LBB4:
 957               	.LM73:
 958 024c 0E94 0000 		call ker_systime32
 959 0250 DC01      		movw r26,r24
 960 0252 CB01      		movw r24,r22
 962               	.LM74:
 963 0254 F701      		movw r30,r14
 964 0256 2085      		ldd r18,Z+8
 965 0258 3185      		ldd r19,Z+9
 966 025a F901      		movw r30,r18
 967 025c 8083      		st Z,r24
 968 025e 9183      		std Z+1,r25
 969 0260 A283      		std Z+2,r26
 970 0262 B383      		std Z+3,r27
 971               	.L27:
 972               	.LBE4:
 974               	.LM75:
 975 0264 BE01      		movw r22,r28
 976 0266 6F5F      		subi r22,lo8(-(1))
 977 0268 7F4F      		sbci r23,hi8(-(1))
 978 026a C701      		movw r24,r14
 979 026c 0E94 0000 		call sosmsg_to_mac
 981               	.LM76:
 982 0270 F701      		movw r30,r14
 983 0272 8281      		ldd r24,Z+2
 984 0274 9381      		ldd r25,Z+3
 985 0276 8F5F      		subi r24,lo8(-1)
 986 0278 9F4F      		sbci r25,hi8(-1)
 987 027a 21F0      		breq .L29
 988 027c F701      		movw r30,r14
 989 027e 8681      		ldd r24,Z+6
 990 0280 8031      		cpi r24,lo8(16)
 991 0282 19F4      		brne .L28
 992               	.L29:
 994               	.LM77:
 995 0284 81E4      		ldi r24,lo8(-30655)
 996 0286 98E8      		ldi r25,hi8(-30655)
 997 0288 02C0      		rjmp .L44
 998               	.L28:
 1000               	.LM78:
 1001 028a 81E6      		ldi r24,lo8(-30623)
 1002 028c 98E8      		ldi r25,hi8(-30623)
 1003               	.L44:
 1004 028e 8F83      		std Y+7,r24
 1005 0290 9887      		std Y+8,r25
 1007               	.LM79:
 1008 0292 80E2      		ldi r24,lo8(9248)
 1009 0294 94E2      		ldi r25,hi8(9248)
 1010 0296 0E94 0000 		call host_to_net
 1011 029a 8B87      		std Y+11,r24
 1012 029c 9C87      		std Y+12,r25
 1014               	.LM80:
 1015 029e 0E94 0000 		call getSeq
 1016 02a2 8987      		std Y+9,r24
 1018               	.LM81:
 1019 02a4 81E0      		ldi r24,lo8(1)
 1020 02a6 90E0      		ldi r25,hi8(1)
 1021 02a8 8E8B      		std Y+22,r24
 1022 02aa 9F8B      		std Y+23,r25
 1024               	.LM82:
 1025 02ac 8E01      		movw r16,r28
 1026 02ae 085E      		subi r16,lo8(-(24))
 1027 02b0 1F4F      		sbci r17,hi8(-(24))
 1028 02b2 B801      		movw r22,r16
 1029 02b4 CE01      		movw r24,r28
 1030 02b6 0196      		adiw r24,1
 1031 02b8 0E94 0000 		call mac_to_vhal
 1033               	.LM83:
 1034 02bc 0E94 0000 		call ker_systime32
 1035 02c0 DC01      		movw r26,r24
 1036 02c2 CB01      		movw r24,r22
 1037 02c4 AC01      		movw r20,r24
 1038 02c6 BD01      		movw r22,r26
 1039 02c8 C701      		movw r24,r14
 1040 02ca 0E94 0000 		call timestamp_outgoing
 1042               	.LM84:
 1043 02ce BE01      		movw r22,r28
 1044 02d0 6F5D      		subi r22,lo8(-(33))
 1045 02d2 7F4F      		sbci r23,hi8(-(33))
 1046 02d4 C801      		movw r24,r16
 1047 02d6 0E94 0000 		call Radio_Send_Pack
 1049               	.LM85:
 1050 02da F701      		movw r30,r14
 1051 02dc 8281      		ldd r24,Z+2
 1052 02de 9381      		ldd r25,Z+3
 1053 02e0 8F5F      		subi r24,lo8(-1)
 1054 02e2 9F4F      		sbci r25,hi8(-1)
 1055 02e4 21F0      		breq .L32
 1056 02e6 F701      		movw r30,r14
 1057 02e8 8681      		ldd r24,Z+6
 1058 02ea 8031      		cpi r24,lo8(16)
 1059 02ec 71F4      		brne .L31
 1060               	.L32:
 1062               	.LM86:
 1063 02ee 1092 0000 		sts retry_count,__zero_reg__
 1065               	.LM87:
 1066 02f2 49E0      		ldi r20,lo8(9)
 1067 02f4 61E0      		ldi r22,lo8(1)
 1068 02f6 C701      		movw r24,r14
 1069 02f8 0E94 0000 		call msg_send_senddone
 1071               	.LM88:
 1072 02fc 1092 0000 		sts (vmac_msg)+1,__zero_reg__
 1073 0300 1092 0000 		sts vmac_msg,__zero_reg__
 1075               	.LM89:
 1076 0304 1092 0000 		sts vmac_send_state,__zero_reg__
 1078               	.LM90:
 1079 0308 8CC0      		rjmp .L21
 1080               	.L31:
 1082               	.LM91:
 1083 030a 9091 0000 		lds r25,retry_count
 1084 030e 9530      		cpi r25,lo8(5)
 1085 0310 28F5      		brsh .L34
 1087               	.LM92:
 1088 0312 82E0      		ldi r24,lo8(2)
 1089 0314 8093 0000 		sts vmac_send_state,r24
 1091               	.LM93:
 1092 0318 F092 0000 		sts (vmac_msg)+1,r15
 1093 031c E092 0000 		sts vmac_msg,r14
 1095               	.LM94:
 1096 0320 892F      		mov r24,r25
 1097 0322 0E94 0000 		call MacBackoff_congestionBackoff
 1098 0326 0296      		adiw r24,2
 1099 0328 AA27      		clr r26
 1100 032a 97FD      		sbrc r25,7
 1101 032c A095      		com r26
 1102 032e BA2F      		mov r27,r26
 1103 0330 9C01      		movw r18,r24
 1104 0332 AD01      		movw r20,r26
 1105 0334 60E0      		ldi r22,lo8(0)
 1106 0336 89E0      		ldi r24,lo8(9)
 1107 0338 0E94 0000 		call ker_timer_restart
 1108 033c 8823      		tst r24
 1109 033e 09F4      		brne .+2
 1110 0340 4DC0      		rjmp .L40
 1112               	.LM95:
 1113 0342 8091 0000 		lds r24,retry_count
 1114 0346 0E94 0000 		call MacBackoff_congestionBackoff
 1115 034a 0296      		adiw r24,2
 1116 034c AA27      		clr r26
 1117 034e 97FD      		sbrc r25,7
 1118 0350 A095      		com r26
 1119 0352 BA2F      		mov r27,r26
 1120 0354 9C01      		movw r18,r24
 1121 0356 AD01      		movw r20,r26
 1122 0358 60E0      		ldi r22,lo8(0)
 1123 035a 3DC0      		rjmp .L46
 1124               	.L34:
 1126               	.LM96:
 1127 035c 1092 0000 		sts retry_count,__zero_reg__
 1129               	.LM97:
 1130 0360 49E0      		ldi r20,lo8(9)
 1131 0362 60E0      		ldi r22,lo8(0)
 1132 0364 8091 0000 		lds r24,vmac_msg
 1133 0368 9091 0000 		lds r25,(vmac_msg)+1
 1134 036c 0E94 0000 		call msg_send_senddone
 1136               	.LM98:
 1137 0370 1092 0000 		sts (vmac_msg)+1,__zero_reg__
 1138 0374 1092 0000 		sts vmac_msg,__zero_reg__
 1140               	.LM99:
 1141 0378 1092 0000 		sts vmac_send_state,__zero_reg__
 1143               	.LM100:
 1144 037c 0E94 0000 		call getMsgNumOfQueue
 1145 0380 8823      		tst r24
 1146 0382 09F4      		brne .+2
 1147 0384 4EC0      		rjmp .L21
 1149               	.LM101:
 1150 0386 EE24      		clr r14
 1151 0388 FF24      		clr r15
 1152 038a 8701      		movw r16,r14
 1153 038c 20E0      		ldi r18,lo8(0)
 1154 038e 44C0      		rjmp .L45
 1155               	.L22:
 1157               	.LM102:
 1158 0390 9530      		cpi r25,lo8(5)
 1159 0392 50F5      		brsh .L39
 1161               	.LM103:
 1162 0394 81E0      		ldi r24,lo8(1)
 1163 0396 8093 0000 		sts vmac_send_state,r24
 1165               	.LM104:
 1166 039a F092 0000 		sts (vmac_msg)+1,r15
 1167 039e E092 0000 		sts vmac_msg,r14
 1169               	.LM105:
 1170 03a2 892F      		mov r24,r25
 1171 03a4 0E94 0000 		call MacBackoff_congestionBackoff
 1172 03a8 AA27      		clr r26
 1173 03aa 97FD      		sbrc r25,7
 1174 03ac A095      		com r26
 1175 03ae BA2F      		mov r27,r26
 1176 03b0 9C01      		movw r18,r24
 1177 03b2 AD01      		movw r20,r26
 1178 03b4 6D2D      		mov r22,r13
 1179 03b6 89E0      		ldi r24,lo8(9)
 1180 03b8 0E94 0000 		call ker_timer_restart
 1181 03bc 8823      		tst r24
 1182 03be 71F0      		breq .L40
 1184               	.LM106:
 1185 03c0 8091 0000 		lds r24,retry_count
 1186 03c4 0E94 0000 		call MacBackoff_congestionBackoff
 1187 03c8 AA27      		clr r26
 1188 03ca 97FD      		sbrc r25,7
 1189 03cc A095      		com r26
 1190 03ce BA2F      		mov r27,r26
 1191 03d0 9C01      		movw r18,r24
 1192 03d2 AD01      		movw r20,r26
 1193 03d4 6D2D      		mov r22,r13
 1194               	.L46:
 1195 03d6 89E0      		ldi r24,lo8(9)
 1196 03d8 0E94 0000 		call ker_timer_start
 1197               	.L40:
 1199               	.LM107:
 1200 03dc 8091 0000 		lds r24,retry_count
 1201 03e0 8F5F      		subi r24,lo8(-(1))
 1202 03e2 8093 0000 		sts retry_count,r24
 1203 03e6 1DC0      		rjmp .L21
 1204               	.L39:
 1206               	.LM108:
 1207 03e8 8093 0000 		sts retry_count,r24
 1209               	.LM109:
 1210 03ec 49E0      		ldi r20,lo8(9)
 1211 03ee 682F      		mov r22,r24
 1212 03f0 8091 0000 		lds r24,vmac_msg
 1213 03f4 9091 0000 		lds r25,(vmac_msg)+1
 1214 03f8 0E94 0000 		call msg_send_senddone
 1216               	.LM110:
 1217 03fc 1092 0000 		sts (vmac_msg)+1,__zero_reg__
 1218 0400 1092 0000 		sts vmac_msg,__zero_reg__
 1220               	.LM111:
 1221 0404 D092 0000 		sts vmac_send_state,r13
 1223               	.LM112:
 1224 0408 0E94 0000 		call getMsgNumOfQueue
 1225 040c 8823      		tst r24
 1226 040e 49F0      		breq .L21
 1228               	.LM113:
 1229 0410 EE24      		clr r14
 1230 0412 FF24      		clr r15
 1231 0414 8701      		movw r16,r14
 1232 0416 2D2D      		mov r18,r13
 1233               	.L45:
 1234 0418 40E2      		ldi r20,lo8(32)
 1235 041a 69E0      		ldi r22,lo8(9)
 1236 041c 862F      		mov r24,r22
 1237 041e 0E94 0000 		call post_short
 1238               	.L21:
 1239               	/* epilogue: frame size=34 */
 1240 0422 A296      		adiw r28,34
 1241 0424 0FB6      		in __tmp_reg__,__SREG__
 1242 0426 F894      		cli
 1243 0428 DEBF      		out __SP_H__,r29
 1244 042a 0FBE      		out __SREG__,__tmp_reg__
 1245 042c CDBF      		out __SP_L__,r28
 1246 042e DF91      		pop r29
 1247 0430 CF91      		pop r28
 1248 0432 1F91      		pop r17
 1249 0434 0F91      		pop r16
 1250 0436 FF90      		pop r15
 1251 0438 EF90      		pop r14
 1252 043a DF90      		pop r13
 1253 043c 0895      		ret
 1254               	/* epilogue end (size=14) */
 1255               	/* function radio_msg_send size 306 (277) */
 1268               	.Lscope10:
 1274               	vmac_handler:
 1276               	.LM114:
 1277               	/* prologue: frame size=0 */
 1278 043e CF93      		push r28
 1279               	/* prologue end (size=1) */
 1280 0440 FB01      		movw r30,r22
 1282               	.LM115:
 1283 0442 8681      		ldd r24,Z+6
 1284 0444 9927      		clr r25
 1285 0446 8032      		cpi r24,32
 1286 0448 9105      		cpc r25,__zero_reg__
 1287 044a 99F0      		breq .L50
 1289               	.LM116:
 1290 044c 8132      		cpi r24,33
 1291 044e 9105      		cpc r25,__zero_reg__
 1292 0450 1CF4      		brge .L56
 1293 0452 0297      		sbiw r24,2
 1294 0454 21F0      		breq .L49
 1295 0456 48C0      		rjmp .L48
 1296               	.L56:
 1297 0458 8197      		sbiw r24,33
 1298 045a 19F1      		breq .L53
 1299 045c 45C0      		rjmp .L48
 1300               	.L49:
 1302               	.LM117:
 1303               	/* #APP */
 1304 045e CFB7      		in r28, __SREG__
 1305 0460 F894      		cli
 1306               		
 1308               	.LM118:
 1309               	/* #NOAPP */
 1310 0462 8091 0000 		lds r24,vmac_msg
 1311 0466 9091 0000 		lds r25,(vmac_msg)+1
 1312 046a 0E94 0000 		call radio_msg_send
 1314               	.LM119:
 1315               	/* #APP */
 1316 046e CFBF      		out __SREG__, r28
 1317               		
 1319               	.LM120:
 1320               	/* #NOAPP */
 1321 0470 3BC0      		rjmp .L48
 1322               	.L50:
 1324               	.LM121:
 1325               	/* #APP */
 1326 0472 CFB7      		in r28, __SREG__
 1327 0474 F894      		cli
 1328               		
 1330               	.LM122:
 1331               	/* #NOAPP */
 1332 0476 8091 0000 		lds r24,vmac_msg
 1333 047a 9091 0000 		lds r25,(vmac_msg)+1
 1334 047e 892B      		or r24,r25
 1335 0480 71F4      		brne .L51
 1337               	.LM123:
 1338 0482 1092 0000 		sts retry_count,__zero_reg__
 1340               	.LM124:
 1341 0486 80E0      		ldi r24,lo8(vmac_pq)
 1342 0488 90E0      		ldi r25,hi8(vmac_pq)
 1343 048a 0E94 0000 		call mq_dequeue
 1344 048e 9093 0000 		sts (vmac_msg)+1,r25
 1345 0492 8093 0000 		sts vmac_msg,r24
 1347               	.LM125:
 1348 0496 0097      		sbiw r24,0
 1349 0498 11F0      		breq .L51
 1351               	.LM126:
 1352 049a 0E94 0000 		call radio_msg_send
 1353               	.L51:
 1355               	.LM127:
 1356               	/* #APP */
 1357 049e CFBF      		out __SREG__, r28
 1358               		
 1360               	.LM128:
 1361               	/* #NOAPP */
 1362 04a0 23C0      		rjmp .L48
 1363               	.L53:
 1365               	.LM129:
 1366               	/* #APP */
 1367 04a2 CFB7      		in r28, __SREG__
 1368 04a4 F894      		cli
 1369               		
 1371               	.LM130:
 1372               	/* #NOAPP */
 1373 04a6 60E0      		ldi r22,lo8(0)
 1374 04a8 89E0      		ldi r24,lo8(9)
 1375 04aa 0E94 0000 		call ker_timer_stop
 1377               	.LM131:
 1378 04ae 1092 0000 		sts vmac_send_state,__zero_reg__
 1380               	.LM132:
 1381 04b2 1092 0000 		sts retry_count,__zero_reg__
 1383               	.LM133:
 1384 04b6 49E0      		ldi r20,lo8(9)
 1385 04b8 61E0      		ldi r22,lo8(1)
 1386 04ba 8091 0000 		lds r24,vmac_msg
 1387 04be 9091 0000 		lds r25,(vmac_msg)+1
 1388 04c2 0E94 0000 		call msg_send_senddone
 1390               	.LM134:
 1391 04c6 1092 0000 		sts (vmac_msg)+1,__zero_reg__
 1392 04ca 1092 0000 		sts vmac_msg,__zero_reg__
 1394               	.LM135:
 1395 04ce 80E0      		ldi r24,lo8(vmac_pq)
 1396 04d0 90E0      		ldi r25,hi8(vmac_pq)
 1397 04d2 0E94 0000 		call mq_dequeue
 1398 04d6 9093 0000 		sts (vmac_msg)+1,r25
 1399 04da 8093 0000 		sts vmac_msg,r24
 1401               	.LM136:
 1402 04de 0097      		sbiw r24,0
 1403 04e0 11F0      		breq .L54
 1405               	.LM137:
 1406 04e2 0E94 0000 		call radio_msg_send
 1407               	.L54:
 1409               	.LM138:
 1410               	/* #APP */
 1411 04e6 CFBF      		out __SREG__, r28
 1412               		
 1413               	/* #NOAPP */
 1414               	.L48:
 1416               	.LM139:
 1417 04e8 80E0      		ldi r24,lo8(0)
 1418 04ea 90E0      		ldi r25,hi8(0)
 1419               	/* epilogue: frame size=0 */
 1420 04ec CF91      		pop r28
 1421 04ee 0895      		ret
 1422               	/* epilogue end (size=2) */
 1423               	/* function vmac_handler size 112 (109) */
 1428               	.Lscope11:
 1432               	.global	radio_msg_alloc
 1434               	radio_msg_alloc:
 1436               	.LM140:
 1437               	/* prologue: frame size=0 */
 1438 04f0 CF93      		push r28
 1439               	/* prologue end (size=1) */
 1440 04f2 BC01      		movw r22,r24
 1442               	.LM141:
 1443               	/* #APP */
 1444 04f4 CFB7      		in r28, __SREG__
 1445 04f6 F894      		cli
 1446               		
 1448               	.LM142:
 1449               	/* #NOAPP */
 1450 04f8 8091 0000 		lds r24,vmac_send_state
 1451 04fc 8823      		tst r24
 1452 04fe 31F0      		breq .L58
 1454               	.LM143:
 1455 0500 80E0      		ldi r24,lo8(vmac_pq)
 1456 0502 90E0      		ldi r25,hi8(vmac_pq)
 1457 0504 0E94 0000 		call mq_enqueue
 1459               	.LM144:
 1460               	/* #APP */
 1461 0508 CFBF      		out __SREG__, r28
 1462               		
 1464               	.LM145:
 1465               	/* #NOAPP */
 1466 050a 06C0      		rjmp .L57
 1467               	.L58:
 1469               	.LM146:
 1470 050c 8093 0000 		sts retry_count,r24
 1472               	.LM147:
 1473 0510 CB01      		movw r24,r22
 1474 0512 0E94 0000 		call radio_msg_send
 1476               	.LM148:
 1477               	/* #APP */
 1478 0516 CFBF      		out __SREG__, r28
 1479               		
 1480               	/* #NOAPP */
 1481               	.L57:
 1482               	/* epilogue: frame size=0 */
 1483 0518 CF91      		pop r28
 1484 051a 0895      		ret
 1485               	/* epilogue end (size=2) */
 1486               	/* function radio_msg_alloc size 32 (29) */
 1491               	.Lscope12:
 1495               	.global	_MacRecvAck
 1497               	_MacRecvAck:
 1499               	.LM149:
 1500               	/* prologue: frame size=0 */
 1501 051c EF92      		push r14
 1502 051e FF92      		push r15
 1503 0520 0F93      		push r16
 1504 0522 1F93      		push r17
 1505               	/* prologue end (size=4) */
 1506 0524 182F      		mov r17,r24
 1508               	.LM150:
 1509 0526 8091 0000 		lds r24,vmac_send_state
 1510 052a 8230      		cpi r24,lo8(2)
 1511 052c 69F4      		brne .L59
 1513               	.LM151:
 1514 052e 0E94 0000 		call getSeq
 1515 0532 8117      		cp r24,r17
 1516 0534 49F4      		brne .L59
 1518               	.LM152:
 1519 0536 EE24      		clr r14
 1520 0538 FF24      		clr r15
 1521 053a 8701      		movw r16,r14
 1522 053c 20E0      		ldi r18,lo8(0)
 1523 053e 41E2      		ldi r20,lo8(33)
 1524 0540 69E0      		ldi r22,lo8(9)
 1525 0542 862F      		mov r24,r22
 1526 0544 0E94 0000 		call post_short
 1527               	.L59:
 1528               	/* epilogue: frame size=0 */
 1529 0548 1F91      		pop r17
 1530 054a 0F91      		pop r16
 1531 054c FF90      		pop r15
 1532 054e EF90      		pop r14
 1533 0550 0895      		ret
 1534               	/* epilogue end (size=5) */
 1535               	/* function _MacRecvAck size 27 (18) */
 1537               	.Lscope13:
 1541               	.global	_MacRecvCallBack
 1543               	_MacRecvCallBack:
 1545               	.LM153:
 1546               	/* prologue: frame size=32 */
 1547 0552 0F93      		push r16
 1548 0554 1F93      		push r17
 1549 0556 CF93      		push r28
 1550 0558 DF93      		push r29
 1551 055a CDB7      		in r28,__SP_L__
 1552 055c DEB7      		in r29,__SP_H__
 1553 055e A097      		sbiw r28,32
 1554 0560 0FB6      		in __tmp_reg__,__SREG__
 1555 0562 F894      		cli
 1556 0564 DEBF      		out __SP_H__,r29
 1557 0566 0FBE      		out __SREG__,__tmp_reg__
 1558 0568 CDBF      		out __SP_L__,r28
 1559               	/* prologue end (size=12) */
 1561               	.LM154:
 1562 056a 8E01      		movw r16,r28
 1563 056c 085E      		subi r16,lo8(-(24))
 1564 056e 1F4F      		sbci r17,hi8(-(24))
 1565 0570 B801      		movw r22,r16
 1566 0572 CE01      		movw r24,r28
 1567 0574 0196      		adiw r24,1
 1568 0576 0E94 0000 		call mac_to_vhal
 1570               	.LM155:
 1571 057a 0E94 0000 		call TC_Disable_Interrupt
 1573               	.LM156:
 1574 057e C801      		movw r24,r16
 1575 0580 0E94 0000 		call Radio_Recv_Pack
 1576 0584 8823      		tst r24
 1577 0586 19F4      		brne .L62
 1579               	.LM157:
 1580 0588 0E94 0000 		call TC_Enable_Interrupt
 1582               	.LM158:
 1583 058c AEC0      		rjmp .L61
 1584               	.L62:
 1586               	.LM159:
 1587 058e 0E94 0000 		call TC_Enable_Interrupt
 1589               	.LM160:
 1590 0592 BE01      		movw r22,r28
 1591 0594 6F5F      		subi r22,lo8(-(1))
 1592 0596 7F4F      		sbci r23,hi8(-(1))
 1593 0598 C801      		movw r24,r16
 1594 059a 0E94 0000 		call vhal_to_mac
 1596               	.LM161:
 1597 059e 8D85      		ldd r24,Y+13
 1598 05a0 9E85      		ldd r25,Y+14
 1599 05a2 0E94 0000 		call net_to_host
 1600 05a6 2091 0000 		lds r18,node_address
 1601 05aa 3091 0000 		lds r19,(node_address)+1
 1602 05ae 8217      		cp r24,r18
 1603 05b0 9307      		cpc r25,r19
 1604 05b2 39F0      		breq .L63
 1605 05b4 8D85      		ldd r24,Y+13
 1606 05b6 9E85      		ldd r25,Y+14
 1607 05b8 0E94 0000 		call net_to_host
 1608 05bc 8F5F      		subi r24,lo8(-1)
 1609 05be 9F4F      		sbci r25,hi8(-1)
 1610 05c0 29F4      		brne .L90
 1611               	.L63:
 1613               	.LM162:
 1614 05c2 0E94 0000 		call msg_create
 1615 05c6 8C01      		movw r16,r24
 1617               	.LM163:
 1618 05c8 0097      		sbiw r24,0
 1619 05ca D9F4      		brne .L65
 1620               	.L90:
 1621               	.LBB5:
 1622               	.LBB6:
 1624               	.Ltext1:
   1:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /* -*- Mode: C; tab-width:4 -*- */
   2:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /* ex: set ts=4: */
   3:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /*
   4:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * Copyright (c) 2003 The Regents of the University of California.
   5:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * All rights reserved.
   6:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *
   7:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * Redistribution and use in source and binary forms, with or without
   8:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * modification, are permitted provided that the following conditions
   9:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * are met:
  10:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * 1. Redistributions of source code must retain the above copyright
  11:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *    notice, this list of conditions and the following disclaimer.
  12:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * 2. Redistributions in binary form must reproduce the above
  13:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *    copyright notice, this list of conditions and the following
  14:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *    disclaimer in the documentation and/or other materials provided
  15:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *    with the distribution.
  16:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * 3. All advertising materials mentioning features or use of this
  17:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *    software must display the following acknowledgement:
  18:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *       This product includes software developed by Networked &
  19:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *       Embedded Systems Lab at UCLA
  20:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * 4. Neither the name of the University nor that of the Laboratory
  21:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *    may be used to endorse or promote products derived from this
  22:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *    software without specific prior written permission.
  23:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *
  24:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS''
  25:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
  26:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
  27:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE REGENTS
  28:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
  29:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
  30:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
  31:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
  32:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
  33:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
  34:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
  35:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * SUCH DAMAGE.
  36:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  *
  37:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief    Allocte and free dynamic memory 
  38:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @author   Roy Shea (roy@cs.ucla.edu) 
  39:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  40:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #ifndef _MALLOC_H_
  41:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #define _MALLOC_H_
  42:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  43:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #include <sos_types.h>
  44:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #include <pid.h>
  45:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #include <malloc_conf.h>
  46:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #include <sos_module_types.h>
  47:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #ifdef FAULT_TOLERANT_SOS
  48:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #include <malloc_domains.h>
  49:/Users/Administrator/sos-2x/kernel/include/malloc.h **** #endif
  50:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  51:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  52:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Init function for memory manager
  53:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  54:/Users/Administrator/sos-2x/kernel/include/malloc.h **** extern void mem_init(void);
  55:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  56:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  57:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Starting memory module interface
  58:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  59:/Users/Administrator/sos-2x/kernel/include/malloc.h **** extern void mem_start(void);
  60:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  61:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  62:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Allocate a chunk of blocks from the heap
  63:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  64:/Users/Administrator/sos-2x/kernel/include/malloc.h **** extern void *sos_blk_mem_alloc(uint16_t size, sos_pid_t id, bool bCallFromModule);
  65:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  66:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  67:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Free a block back into the heap
  68:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  69:/Users/Administrator/sos-2x/kernel/include/malloc.h **** extern void sos_blk_mem_free(void* ptr, bool bCallFromModule);
  70:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  71:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  72:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Re-allocate a block of memory from the heap
  73:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  74:/Users/Administrator/sos-2x/kernel/include/malloc.h **** extern void *sos_blk_mem_realloc(void* pntr, uint16_t newSize, bool bCallFromModule);
  75:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  76:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  77:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Change memory ownership of a segment of memory
  78:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  79:/Users/Administrator/sos-2x/kernel/include/malloc.h **** extern int8_t sos_blk_mem_change_own(void* ptr, sos_pid_t id, bool bCallFromModule);
  80:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  81:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  82:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Allocate a block of memory for long term usage
  83:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  84:/Users/Administrator/sos-2x/kernel/include/malloc.h **** extern void *sos_blk_mem_longterm_alloc(uint16_t size, sos_pid_t id, bool bCallFromModule);
  85:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  86:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  87:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
  88:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Allocate dynamic memory
  89:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @param size Number of bytes to allocate
  90:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @param id Node responsible for the memory
  91:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @return Returns a pointer to the allocated memory.
  92:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * Will return a NULL pointer if the call to sys_malloc fails.
  93:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
  94:/Users/Administrator/sos-2x/kernel/include/malloc.h **** static inline void *ker_malloc(uint16_t size, sos_pid_t id)
  95:/Users/Administrator/sos-2x/kernel/include/malloc.h **** {
  96:/Users/Administrator/sos-2x/kernel/include/malloc.h ****   return sos_blk_mem_alloc(size, id, false);
  97:/Users/Administrator/sos-2x/kernel/include/malloc.h **** }
  98:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
  99:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
 100:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Reallocate dynamic memory
 101:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @param pntr Pointer to the currently held block of memory
 102:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @param newSize Number of bytes to be allocated
 103:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @return Returns the pointer to the reallocated memory.
 104:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * Returns a NULL if unable to reallocate but the original pointer is still valid.
 105:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
 106:/Users/Administrator/sos-2x/kernel/include/malloc.h **** static inline void* ker_realloc(void* pntr, uint16_t newSize)
 107:/Users/Administrator/sos-2x/kernel/include/malloc.h **** {
 108:/Users/Administrator/sos-2x/kernel/include/malloc.h ****   return sos_blk_mem_realloc(pntr, newSize, false);
 109:/Users/Administrator/sos-2x/kernel/include/malloc.h **** }
 110:/Users/Administrator/sos-2x/kernel/include/malloc.h **** 
 111:/Users/Administrator/sos-2x/kernel/include/malloc.h **** /**
 112:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @brief Free memory pointed to by ptr
 113:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @param ptr Pointer to the memory that should be released
 114:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  * @return void
 115:/Users/Administrator/sos-2x/kernel/include/malloc.h ****  */
 116:/Users/Administrator/sos-2x/kernel/include/malloc.h **** static inline void ker_free(void* ptr)
 117:/Users/Administrator/sos-2x/kernel/include/malloc.h **** {
 118:/Users/Administrator/sos-2x/kernel/include/malloc.h ****   sos_blk_mem_free(ptr, false);
 1626               	.LM164:
 1627 05cc 60E0      		ldi r22,lo8(0)
 1628 05ce 8D8D      		ldd r24,Y+29
 1629 05d0 9E8D      		ldd r25,Y+30
 1630 05d2 0E94 0000 		call sos_blk_mem_free
 1631               	.LBE6:
 1632               	.LBE5:
 1634               	.Ltext2:
 1636               	.LM165:
 1637 05d6 89C0      		rjmp .L61
 1638               	.L86:
 1639               	.LBB7:
 1641               	.LM166:
 1642 05d8 F801      		movw r30,r16
 1643 05da 8285      		ldd r24,Z+10
 1644 05dc 9385      		ldd r25,Z+11
 1645 05de 8460      		ori r24,lo8(4)
 1646 05e0 8287      		std Z+10,r24
 1647 05e2 9387      		std Z+11,r25
 1649               	.LM167:
 1650 05e4 C801      		movw r24,r16
 1651 05e6 0E94 0000 		call msg_dispose
 1653               	.LM168:
 1654 05ea 7FC0      		rjmp .L61
 1655               	.L87:
 1657               	.LM169:
 1658 05ec F801      		movw r30,r16
 1659 05ee 8481      		ldd r24,Z+4
 1660 05f0 9581      		ldd r25,Z+5
 1661 05f2 8D93      		st X+,r24
 1662 05f4 9C93      		st X,r25
 1664               	.LM170:
 1665 05f6 4050      		subi r20,lo8(-(dup_seq))
 1666 05f8 5040      		sbci r21,hi8(-(dup_seq))
 1667 05fa 8985      		ldd r24,Y+9
 1668 05fc FA01      		movw r30,r20
 1669 05fe 8083      		st Z,r24
 1671               	.LM171:
 1672 0600 6BC0      		rjmp .L68
 1673               	.L65:
 1674               	.LBE7:
 1676               	.LM172:
 1677 0602 BC01      		movw r22,r24
 1678 0604 CE01      		movw r24,r28
 1679 0606 0196      		adiw r24,1
 1680 0608 0E94 0000 		call mac_to_sosmsg
 1682               	.LM173:
 1683 060c F801      		movw r30,r16
 1684 060e 8681      		ldd r24,Z+6
 1685 0610 8031      		cpi r24,lo8(16)
 1686 0612 61F4      		brne .L67
 1687               	.LBB8:
 1689               	.LM174:
 1690 0614 0E94 0000 		call ker_systime32
 1691 0618 DC01      		movw r26,r24
 1692 061a CB01      		movw r24,r22
 1694               	.LM175:
 1695 061c F801      		movw r30,r16
 1696 061e 2085      		ldd r18,Z+8
 1697 0620 3185      		ldd r19,Z+9
 1698 0622 F901      		movw r30,r18
 1699 0624 8483      		std Z+4,r24
 1700 0626 9583      		std Z+5,r25
 1701 0628 A683      		std Z+6,r26
 1702 062a B783      		std Z+7,r27
 1703               	.L67:
 1704               	.LBE8:
 1706               	.LM176:
 1707 062c 0E94 0000 		call ker_systime32
 1708 0630 DC01      		movw r26,r24
 1709 0632 CB01      		movw r24,r22
 1710 0634 AC01      		movw r20,r24
 1711 0636 BD01      		movw r22,r26
 1712 0638 C801      		movw r24,r16
 1713 063a 0E94 0000 		call timestamp_incoming
 1715               	.LM177:
 1716 063e F801      		movw r30,r16
 1717 0640 4481      		ldd r20,Z+4
 1718 0642 5581      		ldd r21,Z+5
 1719 0644 FFEF      		ldi r31,hi8(-1)
 1720 0646 4F3F      		cpi r20,lo8(-1)
 1721 0648 5F07      		cpc r21,r31
 1722 064a 09F4      		brne .+2
 1723 064c 45C0      		rjmp .L68
 1724               	.LBB9:
 1726               	.LM178:
 1727 064e 20E0      		ldi r18,lo8(0)
 1729               	.LM179:
 1730 0650 322F      		mov r19,r18
 1731 0652 E0E0      		ldi r30,lo8(dup_seq)
 1732 0654 F0E0      		ldi r31,hi8(dup_seq)
 1733 0656 A0E0      		ldi r26,lo8(dup_addr)
 1734 0658 B0E0      		ldi r27,hi8(dup_addr)
 1735               	.L75:
 1737               	.LM180:
 1738 065a 8D91      		ld r24,X+
 1739 065c 9D91      		ld r25,X+
 1740 065e 4817      		cp r20,r24
 1741 0660 5907      		cpc r21,r25
 1742 0662 39F4      		brne .L71
 1744               	.LM181:
 1745 0664 9985      		ldd r25,Y+9
 1746 0666 8081      		ld r24,Z
 1747 0668 9817      		cp r25,r24
 1748 066a 09F4      		brne .+2
 1749 066c B5CF      		rjmp .L86
 1751               	.LM182:
 1752 066e 9083      		st Z,r25
 1754               	.LM183:
 1755 0670 33C0      		rjmp .L68
 1756               	.L71:
 1758               	.LM184:
 1759 0672 2F5F      		subi r18,lo8(-(1))
 1760 0674 3196      		adiw r30,1
 1761 0676 2330      		cpi r18,lo8(3)
 1762 0678 80F3      		brlo .L75
 1764               	.LM185:
 1765 067a 232F      		mov r18,r19
 1766 067c 40E0      		ldi r20,lo8(0)
 1767 067e 50E0      		ldi r21,hi8(0)
 1768               	.L81:
 1770               	.LM186:
 1771 0680 DA01      		movw r26,r20
 1772 0682 A40F      		add r26,r20
 1773 0684 B51F      		adc r27,r21
 1774 0686 A050      		subi r26,lo8(-(dup_addr))
 1775 0688 B040      		sbci r27,hi8(-(dup_addr))
 1776 068a 8D91      		ld r24,X+
 1777 068c 9C91      		ld r25,X
 1778 068e 1197      		sbiw r26,1
 1779 0690 8F5F      		subi r24,lo8(-1)
 1780 0692 9F4F      		sbci r25,hi8(-1)
 1781 0694 09F4      		brne .+2
 1782 0696 AACF      		rjmp .L87
 1784               	.LM187:
 1785 0698 2F5F      		subi r18,lo8(-(1))
 1786 069a 4F5F      		subi r20,lo8(-(1))
 1787 069c 5F4F      		sbci r21,hi8(-(1))
 1788 069e 2330      		cpi r18,lo8(3)
 1789 06a0 78F3      		brlo .L81
 1791               	.LM188:
 1792 06a2 8091 0000 		lds r24,oldest_dup
 1793 06a6 282F      		mov r18,r24
 1794 06a8 3327      		clr r19
 1795 06aa D901      		movw r26,r18
 1796 06ac A20F      		add r26,r18
 1797 06ae B31F      		adc r27,r19
 1798 06b0 A050      		subi r26,lo8(-(dup_addr))
 1799 06b2 B040      		sbci r27,hi8(-(dup_addr))
 1800 06b4 F801      		movw r30,r16
 1801 06b6 8481      		ldd r24,Z+4
 1802 06b8 9581      		ldd r25,Z+5
 1803 06ba 8D93      		st X+,r24
 1804 06bc 9C93      		st X,r25
 1806               	.LM189:
 1807 06be F901      		movw r30,r18
 1808 06c0 E050      		subi r30,lo8(-(dup_seq))
 1809 06c2 F040      		sbci r31,hi8(-(dup_seq))
 1810 06c4 8985      		ldd r24,Y+9
 1811 06c6 8083      		st Z,r24
 1813               	.LM190:
 1814 06c8 C901      		movw r24,r18
 1815 06ca 0196      		adiw r24,1
 1816 06cc 63E0      		ldi r22,lo8(3)
 1817 06ce 70E0      		ldi r23,hi8(3)
 1818 06d0 0E94 0000 		call __divmodhi4
 1819 06d4 8093 0000 		sts oldest_dup,r24
 1820               	.L68:
 1821               	.LBE9:
 1822               	.LBB10:
 1823               	.LBB11:
 1825               	.Ltext3:
   1:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** /* -*- Mode: C; tab-width:4 -*- */
   2:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** /* ex: set ts=4 shiftwidth=4 softtabstop=4 cindent: */
   3:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** /*
   4:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * Copyright (c) 2003 The Regents of the University of California.
   5:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * All rights reserved.
   6:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *
   7:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * Redistribution and use in source and binary forms, with or without
   8:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * modification, are permitted provided that the following conditions
   9:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * are met:
  10:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * 1. Redistributions of source code must retain the above copyright
  11:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *    notice, this list of conditions and the following disclaimer.
  12:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * 2. Redistributions in binary form must reproduce the above
  13:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *    copyright notice, this list of conditions and the following
  14:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *    disclaimer in the documentation and/or other materials provided
  15:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *    with the distribution.
  16:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * 3. All advertising materials mentioning features or use of this
  17:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *    software must display the following acknowledgement:
  18:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *       This product includes software developed by Networked &
  19:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *       Embedded Systems Lab at UCLA
  20:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * 4. Neither the name of the University nor that of the Laboratory
  21:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *    may be used to endorse or promote products derived from this
  22:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *    software without specific prior written permission.
  23:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *
  24:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS''
  25:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
  26:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
  27:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE REGENTS
  28:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
  29:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
  30:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
  31:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
  32:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
  33:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
  34:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
  35:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * SUCH DAMAGE.
  36:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *
  37:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  */
  38:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** /**
  39:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * @brief inline functions for message handling in the stack
  40:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * @author Simon Han (simonhan@ee.ucla.edu)
  41:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  *
  42:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * In SOS, stack is part of operating system.
  43:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * Therefore, stack helps kernel to do message filtering.
  44:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * Note that this routine was originally done in post and call logic.
  45:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * But most of message filterings are meanful for messages from the 
  46:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  * network.  
  47:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****  */
  48:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** 
  49:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** 
  50:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** #ifndef _NET_STACK_H
  51:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** #define _NET_STACK_H
  52:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** 
  53:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** #include <message_queue.h>
  54:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** #include <sos_sched.h>
  55:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** #include <sos_info.h>
  56:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** 
  57:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** static inline void handle_incoming_msg(Message *msg, uint16_t channel_flag)
  58:/Users/Administrator/sos-2x/kernel/include/net_stack.h **** {
  59:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****   //   DEBUG("<NET STACK> Received message from network\n");
  60:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****   msg->flag |= SOS_MSG_FROM_NETWORK | channel_flag;
 1827               	.LM191:
 1828 06d8 F801      		movw r30,r16
 1829 06da 8285      		ldd r24,Z+10
 1830 06dc 9385      		ldd r25,Z+11
 1831 06de 9360      		ori r25,hi8(768)
 1832 06e0 8287      		std Z+10,r24
 1833 06e2 9387      		std Z+11,r25
  61:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****   msg->daddr = entohs(msg->daddr);
  62:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****   msg->saddr = entohs(msg->saddr);
  63:/Users/Administrator/sos-2x/kernel/include/net_stack.h ****   sched_msg_alloc(msg);
 1835               	.LM192:
 1836 06e4 C801      		movw r24,r16
 1837 06e6 0E94 0000 		call sched_msg_alloc
 1838               	.L61:
 1839               	.LBE11:
 1840               	.LBE10:
 1841               	/* epilogue: frame size=32 */
 1842 06ea A096      		adiw r28,32
 1843 06ec 0FB6      		in __tmp_reg__,__SREG__
 1844 06ee F894      		cli
 1845 06f0 DEBF      		out __SP_H__,r29
 1846 06f2 0FBE      		out __SREG__,__tmp_reg__
 1847 06f4 CDBF      		out __SP_L__,r28
 1848 06f6 DF91      		pop r29
 1849 06f8 CF91      		pop r28
 1850 06fa 1F91      		pop r17
 1851 06fc 0F91      		pop r16
 1852 06fe 0895      		ret
 1853               	/* epilogue end (size=11) */
 1854               	/* function _MacRecvCallBack size 217 (194) */
 1869               	.Lscope14:
 1873               	.global	radio_set_timestamp
 1875               	radio_set_timestamp:
 1877               	.Ltext4:
 1879               	.LM193:
 1880               	/* prologue: frame size=0 */
 1881               	/* prologue end (size=0) */
 1883               	.LM194:
 1884 0700 80E0      		ldi r24,lo8(0)
 1885 0702 90E0      		ldi r25,hi8(0)
 1886               	/* epilogue: frame size=0 */
 1887 0704 0895      		ret
 1888               	/* epilogue end (size=1) */
 1889               	/* function radio_set_timestamp size 3 (2) */
 1891               	.Lscope15:
 1894               	.global	mac_init
 1896               	mac_init:
 620:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 621:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** /*************************************************************************
 622:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  * Initiate the radio and mac                                            *
 623:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****  *************************************************************************/
 624:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** void mac_init()
 625:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** {
 1898               	.LM195:
 1899               	/* prologue: frame size=0 */
 1900 0706 1F93      		push r17
 1901               	/* prologue end (size=1) */
 626:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****     uint8_t i;
 627:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	Radio_Init();
 1903               	.LM196:
 1904 0708 0E94 0000 		call Radio_Init
 1905               	.LBB12:
 628:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	Radio_Set_Channel(RADIO_CHANNEL);
 1907               	.LM197:
 1908 070c 2FE6      		ldi r18,lo8(367)
 1909 070e 31E0      		ldi r19,hi8(367)
 1910 0710 40E0      		ldi r20,lo8(0)
 1911 0712 69E0      		ldi r22,lo8(9)
 1912 0714 88E1      		ldi r24,lo8(24)
 1913 0716 0E94 0000 		call TC_SET_REG
 1914 071a 8091 0000 		lds r24,_current_stat
 1915 071e 86FF      		sbrs r24,6
 1916 0720 03C0      		rjmp .L93
 1918               	.LM198:
 1919 0722 83E0      		ldi r24,lo8(3)
 1920 0724 0E94 0000 		call TC_STROBE
 1921               	.L93:
 1922               	.LBE12:
 629:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	//Radio_Set_Channel(13);
 630:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 631:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #ifdef SOS_USE_PREEMPTION
 632:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	ker_register_module(sos_get_header_address(mod_header));
 633:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #else
 634:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	sched_register_kernel_module(&vmac_module, sos_get_header_address(mod_header), NULL);
 1924               	.LM199:
 1925 0728 80E0      		ldi r24,lo8(mod_header)
 1926 072a 90E0      		ldi r25,hi8(mod_header)
 1927 072c AA27      		clr r26
 1928 072e 97FD      		sbrc r25,7
 1929 0730 A095      		com r26
 1930 0732 BA2F      		mov r27,r26
 1931 0734 B695      		lsr r27
 1932 0736 A795      		ror r26
 1933 0738 9795      		ror r25
 1934 073a 8795      		ror r24
 1935 073c 40E0      		ldi r20,lo8(0)
 1936 073e 50E0      		ldi r21,hi8(0)
 1937 0740 BC01      		movw r22,r24
 1938 0742 80E0      		ldi r24,lo8(vmac_module)
 1939 0744 90E0      		ldi r25,hi8(vmac_module)
 1940 0746 0E94 0000 		call sched_register_kernel_module
 635:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** #endif
 636:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 637:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	// Timer needs to be done after reigsteration
 638:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	ker_permanent_timer_init(&wakeup_timer, RADIO_PID, WAKEUP_TIMER_TID, TIMER_ONE_SHOT);
 1942               	.LM200:
 1943 074a 21E0      		ldi r18,lo8(1)
 1944 074c 40E0      		ldi r20,lo8(0)
 1945 074e 69E0      		ldi r22,lo8(9)
 1946 0750 80E0      		ldi r24,lo8(wakeup_timer)
 1947 0752 90E0      		ldi r25,hi8(wakeup_timer)
 1948 0754 0E94 0000 		call ker_permanent_timer_init
 639:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 640:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	mq_init(&vmac_pq);	//! Initialize sending queue
 1950               	.LM201:
 1951 0758 80E0      		ldi r24,lo8(vmac_pq)
 1952 075a 90E0      		ldi r25,hi8(vmac_pq)
 1953 075c 0E94 0000 		call mq_init
 1954               	.LBB13:
 1955               	.LBB14:
 1957               	.LM202:
 1958               	/* #APP */
 1959 0760 1FB7      		in r17, __SREG__
 1960 0762 F894      		cli
 1961               		
 1963               	.LM203:
 1964               	/* #NOAPP */
 1965 0764 0E94 0000 		call ker_rand
 1966 0768 6FEF      		ldi r22,lo8(255)
 1967 076a 70E0      		ldi r23,hi8(255)
 1968 076c 0E94 0000 		call __udivmodhi4
 1969 0770 8F5F      		subi r24,lo8(-(1))
 1970 0772 8093 0000 		sts seq_count,r24
 1972               	.LM204:
 1973               	/* #APP */
 1974 0776 1FBF      		out __SREG__, r17
 1975               		
 1976               	/* #NOAPP */
 1977               	.LBE14:
 1978               	.LBE13:
 641:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	resetSeq();		//set seq_count to random initial number
 642:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	retry_count = 0; 	//set retries 0
 1980               	.LM205:
 1981 0778 1092 0000 		sts retry_count,__zero_reg__
 1982 077c 2FEF      		ldi r18,lo8(-1)
 1983 077e 3FEF      		ldi r19,hi8(-1)
 1984 0780 A0E0      		ldi r26,lo8(dup_seq)
 1985 0782 B0E0      		ldi r27,hi8(dup_seq)
 1986 0784 82E0      		ldi r24,lo8(2)
 1987 0786 E0E0      		ldi r30,lo8(dup_addr)
 1988 0788 F0E0      		ldi r31,hi8(dup_addr)
 1989               	.L99:
 643:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****     for(i=0; i<NUM_DUP_CHECK; i++){
 644:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****         dup_addr[i] = BCAST_ADDRESS;
 1991               	.LM206:
 1992 078a 2193      		st Z+,r18
 1993 078c 3193      		st Z+,r19
 645:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****         dup_seq[i] = 0;
 1995               	.LM207:
 1996 078e 1D92      		st X+,__zero_reg__
 1998               	.LM208:
 1999 0790 8150      		subi r24,lo8(-(-1))
 2000 0792 87FF      		sbrs r24,7
 2001 0794 FACF      		rjmp .L99
 646:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****     }
 647:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c ****     oldest_dup = 0;
 2003               	.LM209:
 2004 0796 1092 0000 		sts oldest_dup,__zero_reg__
 648:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 
 649:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	vmac_send_state = VMAC_SEND_STATE_IDLE;
 2006               	.LM210:
 2007 079a 1092 0000 		sts vmac_send_state,__zero_reg__
 650:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	vmac_msg = NULL;
 2009               	.LM211:
 2010 079e 1092 0000 		sts (vmac_msg)+1,__zero_reg__
 2011 07a2 1092 0000 		sts vmac_msg,__zero_reg__
 651:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	//enable interrupt for receiving data
 652:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	Radio_SetPackRecvedCallBack(_MacRecvCallBack);
 2013               	.LM212:
 2014 07a6 80E0      		ldi r24,lo8(pm(_MacRecvCallBack))
 2015 07a8 90E0      		ldi r25,hi8(pm(_MacRecvCallBack))
 2016 07aa 0E94 0000 		call TC_SetFIFOPCallBack
 653:/Users/Administrator/sos-2x/drivers/cc2420/vmac.c **** 	Radio_Enable_Interrupt();
 2018               	.LM213:
 2019 07ae 0E94 0000 		call TC_Enable_Interrupt
 2020               	/* epilogue: frame size=0 */
 2021 07b2 1F91      		pop r17
 2022 07b4 0895      		ret
 2023               	/* epilogue end (size=2) */
 2024               	/* function mac_init size 95 (92) */
 2035               	.Lscope16:
 2037               		.lcomm vmac_msg,2
 2038               		.lcomm vmac_send_state,1
 2039               		.lcomm wakeup_timer,16
 2040               		.lcomm vmac_module,8
 2041               		.lcomm vmac_pq,16
 2042               		.lcomm seq_count,1
 2043               		.lcomm retry_count,1
 2044               		.lcomm dup_addr,6
 2045               		.lcomm dup_seq,3
 2046               		.lcomm oldest_dup,1
 2059               		.text
 2061               	Letext:
 2062               	/* File "/Users/Administrator/sos-2x/drivers/cc2420/vmac.c": code 1057 = 0x0421 ( 948), prologues  
DEFINED SYMBOLS
                            *ABS*:00000000 vmac.c
                            *ABS*:0000003f __SREG__
                            *ABS*:0000003e __SP_H__
                            *ABS*:0000003d __SP_L__
                            *ABS*:00000000 __tmp_reg__
                            *ABS*:00000001 __zero_reg__
/var/tmp//ccQv3wyb.s:344    .bss:00000000 _mac_recv_callback
/var/tmp//ccQv3wyb.s:349    .progmem.data:00000000 mod_header
/var/tmp//ccQv3wyb.s:1274   .text:0000043e vmac_handler
/var/tmp//ccQv3wyb.s:360    .text:00000000 getSeq
/var/tmp//ccQv3wyb.s:2041   .bss:0000002d seq_count
/var/tmp//ccQv3wyb.s:399    .text:00000010 radio_gc
/var/tmp//ccQv3wyb.s:2040   .bss:0000001d vmac_pq
                             .bss:00000002 vmac_msg
/var/tmp//ccQv3wyb.s:446    .text:00000046 radio_msg_gc
/var/tmp//ccQv3wyb.s:468    .text:00000052 mac_set_recv_callback
/var/tmp//ccQv3wyb.s:489    .text:0000005c sosmsg_to_mac
/var/tmp//ccQv3wyb.s:567    .text:000000c0 mac_to_sosmsg
/var/tmp//ccQv3wyb.s:659    .text:0000012c mac_to_vhal
/var/tmp//ccQv3wyb.s:713    .text:00000160 vhal_to_mac
/var/tmp//ccQv3wyb.s:774    .text:000001b0 MacBackoff_congestionBackoff
/var/tmp//ccQv3wyb.s:837    .text:000001e4 getMsgNumOfQueue
/var/tmp//ccQv3wyb.s:876    .text:000001f4 radio_msg_send
/var/tmp//ccQv3wyb.s:2042   .bss:0000002e retry_count
/var/tmp//ccQv3wyb.s:2037   .bss:00000004 vmac_send_state
/var/tmp//ccQv3wyb.s:1434   .text:000004f0 radio_msg_alloc
/var/tmp//ccQv3wyb.s:1497   .text:0000051c _MacRecvAck
/var/tmp//ccQv3wyb.s:1543   .text:00000552 _MacRecvCallBack
/var/tmp//ccQv3wyb.s:2044   .bss:00000035 dup_seq
/var/tmp//ccQv3wyb.s:2043   .bss:0000002f dup_addr
/var/tmp//ccQv3wyb.s:2045   .bss:00000038 oldest_dup
/var/tmp//ccQv3wyb.s:1875   .text:00000700 radio_set_timestamp
/var/tmp//ccQv3wyb.s:1896   .text:00000706 mac_init
/var/tmp//ccQv3wyb.s:2039   .bss:00000015 vmac_module
/var/tmp//ccQv3wyb.s:2038   .bss:00000005 wakeup_timer
/var/tmp//ccQv3wyb.s:2061   .text:000007b6 Letext

UNDEFINED SYMBOLS
__do_copy_data
__do_clear_bss
mq_gc_mark_payload
ker_gc_mark
malloc_gc
mq_gc_mark_hdr
host_to_net
net_to_host
memcpy
ker_rand
Radio_Check_CCA
ker_systime32
timestamp_outgoing
Radio_Send_Pack
msg_send_senddone
ker_timer_restart
ker_timer_start
post_short
mq_dequeue
ker_timer_stop
mq_enqueue
TC_Disable_Interrupt
Radio_Recv_Pack
TC_Enable_Interrupt
node_address
msg_create
sos_blk_mem_free
msg_dispose
timestamp_incoming
__divmodhi4
sched_msg_alloc
Radio_Init
TC_SET_REG
_current_stat
TC_STROBE
sched_register_kernel_module
ker_permanent_timer_init
mq_init
__udivmodhi4
TC_SetFIFOPCallBack
